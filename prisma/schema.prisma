// This is your Prisma schema file
// Bereifung24 Platform - Kunden-Werkstatt-Vermittlung
// PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ADMIN NOTIFICATIONS
// ============================================

model AdminNotificationSetting {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?

  // Notification Types
  notifyCustomerRegistration  Boolean @default(true) // Benachrichtigung bei Kunden-Registrierung
  notifyWorkshopRegistration  Boolean @default(true) // Benachrichtigung bei Werkstatt-Registrierung
  notifyInfluencerApplication Boolean @default(false) // Benachrichtigung bei Influencer-Bewerbung

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_notification_settings")
}

// ============================================
// ADMIN API SETTINGS
// ============================================

model AdminApiSetting {
  id          String  @id @default(cuid())
  key         String  @unique // e.g., "GOCARDLESS_ACCESS_TOKEN", "GOOGLE_OAUTH_CLIENT_ID"
  value       String? // The actual API key/secret (encrypted in production)
  description String? // What this key is for

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_api_settings")
}

// ============================================
// EMAIL TEMPLATES
// ============================================

model EmailTemplate {
  id          String  @id @default(cuid())
  key         String  @unique // e.g., "BOOKING_CONFIRMATION_CUSTOMER", "BOOKING_CONFIRMATION_WORKSHOP"
  name        String // Display name: "Terminbestätigung - Kunde"
  description String? // What this template is used for
  subject     String // Email subject line with placeholders
  htmlContent String  @db.Text // HTML email content with placeholders

  // Placeholders documentation (JSON array of available placeholders)
  placeholders String @db.Text // JSON: [{"key": "customerName", "description": "Name des Kunden"}]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String
  role     String @default("CUSTOMER") // CUSTOMER, WORKSHOP, ADMIN

  // Profile
  firstName String
  lastName  String
  phone     String?
  street    String?
  zipCode   String?
  city      String?
  latitude  Float?
  longitude Float?

  // Customer Type (for billing)
  customerType String? @default("PRIVATE") // PRIVATE, BUSINESS
  companyName  String?
  taxId        String? // Steuernummer/USt-IdNr for business customers

  // Verification
  emailVerified DateTime?
  isActive      Boolean   @default(true)

  // OAuth
  googleId String? @unique

  // Password Reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Email Verification
  verificationToken String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations based on role
  customer Customer?
  workshop Workshop?

  // Procurement Relations
  suppliersCreated    Supplier[]           @relation
  procurementRequests ProcurementRequest[] @relation
  approvedRequests    ProcurementRequest[] @relation("ApprovedRequests")
  purchaseOrders      PurchaseOrder[]      @relation
  receivedOrders      PurchaseOrder[]      @relation("ReceivedOrders")
  createdAssets       Asset[]              @relation("CreatedAssets")
  assignedAssets      Asset[]              @relation
  investmentPlans     InvestmentPlan[]

  @@map("users")
}

// ============================================
// CUSTOMER
// ============================================

model Customer {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email Notifications
  emailNotifyOffers Boolean @default(true) // Benachrichtigung bei neuen Angeboten

  // Relations
  tireRequests         TireRequest[]
  bookings             Booking[]
  reviews              Review[]
  tireRatings          TireRating[]
  vehicles             Vehicle[]
  weatherAlert         WeatherAlert?
  affiliateConversions AffiliateConversion[] // Tracking von Affiliate-Conversions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

// ============================================
// WEATHER ALERT (Tire Change Reminder)
// ============================================

model WeatherAlert {
  id         String   @id @default(cuid())
  customerId String   @unique
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Settings
  isEnabled            Boolean @default(false) // Ob Benachrichtigungen aktiviert sind
  temperatureThreshold Int     @default(7) // Temperatur-Schwelle in °C (z.B. 7°C)
  daysInAdvance        Int     @default(3) // Wie viele Tage im Voraus benachrichtigen (1-7)
  showOnDashboard      Boolean @default(true) // Widget auf Dashboard anzeigen

  // Season Tracking
  lastAlertSeason String? // WINTER_2024, SUMMER_2024 - verhindert doppelte Benachrichtigung
  lastAlertDate   DateTime?

  // Location (falls abweichend von User-Adresse)
  useCustomLocation Boolean @default(false)
  customZipCode     String?
  customCity        String?
  customLatitude    Float?
  customLongitude   Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("weather_alerts")
}

// ============================================
// WORKSHOP
// ============================================

model Workshop {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business Info
  customerNumber String  @unique @map("customer_number") // Eindeutige Kundennummer (z.B. KD-20231219-001)
  companyName    String
  taxId          String?
  website        String?
  description    String?
  logoUrl        String? // Workshop Logo URL
  taxMode        String  @default("STANDARD") // STANDARD (inkl. MwSt.), KLEINUNTERNEHMER (§19 UStG)

  // Opening Hours (JSON String)
  openingHours String? // JSON: {"monday": "09:00-18:00", ...}

  // Verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Banking (SEPA)
  iban            String?
  accountHolder   String?
  sepaMandateRef  String?   @unique // B24-timestamp-random
  sepaMandateDate DateTime?

  // PayPal
  paypalEmail String?

  // GoCardless Integration
  gocardlessCustomerId       String?   @unique // GoCardless Customer ID
  gocardlessMandateId        String?   @unique // GoCardless Mandate ID
  gocardlessMandateStatus    String? // pending_submission, submitted, active, cancelled, failed, expired
  gocardlessMandateRef       String?   @unique // Eindeutige Mandate Reference
  gocardlessMandateCreatedAt DateTime?
  gocardlessBankAccountId    String? // GoCardless Bank Account ID
  gocardlessSessionToken     String?   @map("gocardless_session_token") // Temporary session token for redirect flow
  gocardlessRedirectFlowId   String?   @map("gocardless_redirect_flow_id") // Temporary redirect flow ID

  // Payment Methods (JSON String)
  paymentMethods String? @map("paymentmethods") // JSON: {"cash": true, "bankTransfer": true, ...}

  // Email Notifications
  emailNotifyRequests      Boolean @default(true) @map("email_notify_requests") // Benachrichtigung bei neuen Anfragen im Umkreis
  emailNotifyOfferAccepted Boolean @default(true) @map("email_notify_offer_accepted") // Benachrichtigung wenn Angebot angenommen wurde
  emailNotifyBookings      Boolean @default(true) @map("email_notify_bookings") // Benachrichtigung bei neuen Terminbuchungen
  emailNotifyReviews       Boolean @default(true) @map("email_notify_reviews") // Benachrichtigung bei neuen Bewertungen
  emailNotifyReminders     Boolean @default(true) @map("email_notify_reminders") // Terminserinnerungen
  emailNotifyCommissions   Boolean @default(true) @map("email_notify_commissions") // Monatliche Provisionsabrechnungen

  // Calendar Integration
  calendarMode       String?   @default("workshop") @map("calendarmode") // "workshop" or "employees"
  googleCalendarId   String?   @map("googlecalendarid") // For workshop mode
  googleAccessToken  String?   @map("googleaccesstoken")
  googleRefreshToken String?   @map("googlerefreshtoken")
  googleTokenExpiry  DateTime? @map("googletokenexpiry")

  // Bereifung24 Employee Assignment
  assignedEmployeeId String?      @map("assigned_employee_id")
  assignedEmployee   B24Employee? @relation("WorkshopAssignment", fields: [assignedEmployeeId], references: [id])

  // Relations
  offers            Offer[]
  bookings          Booking[]
  reviews           Review[]
  commissions       Commission[]
  employees         Employee[]
  workshopVacations WorkshopVacation[]
  workshopServices  WorkshopService[]
  pricingSettings   PricingSettings?
  landingPage       WorkshopLandingPage?
  affiliateConversions AffiliateConversion[]
  crmData           WorkshopCRM?

  // Sales CRM - Converted from Prospect
  prospectSource ProspectWorkshop? @relation("ConvertedFromProspect")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workshops")
}

model PricingSettings {
  id         String   @id @default(cuid())
  workshopId String   @unique @map("workshop_id")
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Auto Reifen
  autoManualPricing Boolean @default(true) @map("auto_manual_pricing")
  autoFixedMarkup   Float   @default(0) @map("auto_fixed_markup")
  autoPercentMarkup Float   @default(0) @map("auto_percent_markup")
  autoIncludeVat    Boolean @default(false) @map("auto_include_vat")

  // Motorrad Reifen
  motoManualPricing Boolean @default(true) @map("moto_manual_pricing")
  motoFixedMarkup   Float   @default(0) @map("moto_fixed_markup")
  motoPercentMarkup Float   @default(0) @map("moto_percent_markup")
  motoIncludeVat    Boolean @default(false) @map("moto_include_vat")

  // Batterie-Service
  batteryManualPricing Boolean @default(true) @map("battery_manual_pricing")
  batteryFixedMarkup   Float   @default(0) @map("battery_fixed_markup")
  batteryPercentMarkup Float   @default(0) @map("battery_percent_markup")
  batteryIncludeVat    Boolean @default(false) @map("battery_include_vat")

  // Bremsen-Service
  brakeManualPricing Boolean @default(true) @map("brake_manual_pricing")
  brakeFixedMarkup   Float   @default(0) @map("brake_fixed_markup")
  brakePercentMarkup Float   @default(0) @map("brake_percent_markup")
  brakeIncludeVat    Boolean @default(false) @map("brake_include_vat")

  // Andere Services
  serviceManualPricing Boolean @default(true) @map("service_manual_pricing")
  serviceFixedMarkup   Float   @default(0) @map("service_fixed_markup")
  servicePercentMarkup Float   @default(0) @map("service_percent_markup")
  serviceIncludeVat    Boolean @default(false) @map("service_include_vat")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("pricing_settings")
}

model Employee {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  name  String
  email String

  // Google Calendar Integration
  googleCalendarId   String?
  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?

  // Working Hours (JSON String)
  workingHours String? // JSON: {"monday": {"from": "08:00", "to": "17:00", "working": true}, ...}

  // Relations
  bookings          Booking[]
  employeeVacations EmployeeVacation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employees")
}

// ============================================
// TIRE REQUEST
// ============================================

model TireRequest {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  vehicleId  String?
  vehicle    Vehicle? @relation(fields: [vehicleId], references: [id])

  // Tire Specifications
  season      String // SUMMER, WINTER, ALL_SEASON
  width       Int
  aspectRatio Int
  diameter    Int
  loadIndex   Int?
  speedRating String?
  isRunflat   Boolean @default(false)
  quantity    Int     @default(4)

  // Preferences
  preferredBrands String? // Comma-separated brands
  specificBrand   String?
  additionalNotes String?

  // Motorcycle specific
  mountOnMotorcycle Boolean @default(false) @map("mount_on_motorcycle") // For motorcycle tire requests: true = mount on whole motorcycle, false = wheels only (default)

  // Location
  zipCode   String
  city      String?
  radiusKm  Int     @default(25)
  latitude  Float?
  longitude Float?

  // Timing
  needByDate DateTime

  // Status
  status String @default("PENDING") // PENDING, QUOTED, ACCEPTED, COMPLETED, CANCELLED

  // CO2 Tracking
  savedCO2Grams     Int? // Gespeicherte CO₂-Menge in Gramm
  calculationMethod String? // 'STANDARD' oder 'PERSONAL'
  workshopsNotified Int? // Anzahl der Werkstätten, die die Anfrage erhalten haben (für CO2-Berechnung verwendet)

  // Relations
  offers               Offer[]
  booking              Booking?
  affiliateConversions AffiliateConversion[] // Tracking von Affiliate-Conversions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tire_requests")
}

// ============================================
// VEHICLE MANAGEMENT
// ============================================

model Vehicle {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Vehicle Details
  vehicleType  String  @default("CAR") // CAR, MOTORCYCLE, TRAILER
  make         String
  model        String
  year         Int
  licensePlate String?
  vin          String? @unique

  // TÜV (Technical Inspection)
  nextInspectionDate     DateTime?
  inspectionReminder     Boolean   @default(false)
  inspectionReminderDays Int?      @default(30) // Days before inspection to send reminder

  // Tire Sizes (stored as JSON)
  summerTires    String? // JSON string with tire dimensions
  winterTires    String? // JSON string with tire dimensions
  allSeasonTires String? // JSON string with tire dimensions

  // Fuel & Consumption (for CO2 calculation)
  fuelType            FuelType @default(UNKNOWN)
  fuelConsumption     Float? // L/100km für Verbrenner
  electricConsumption Float? // kWh/100km für E-Autos

  // Current Tires
  currentTires VehicleTire[]
  tireHistory  TireHistory[]
  tireRequests TireRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vehicles")
}

model VehicleTire {
  id        String  @id @default(cuid())
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  // Tire Specs
  position    String // FRONT_LEFT, FRONT_RIGHT, REAR_LEFT, REAR_RIGHT
  season      String // SUMMER, WINTER, ALL_SEASON
  width       Int
  aspectRatio Int
  diameter    Int
  loadIndex   Int?
  speedRating String?
  brand       String?
  model       String?
  dotCode     String? // Herstellungsdatum

  // Condition
  treadDepth           Float?
  installedDate        DateTime?
  estimatedReplacement DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vehicle_tires")
}

model TireHistory {
  id        String  @id @default(cuid())
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  // What was installed
  season      String
  width       Int
  aspectRatio Int
  diameter    Int
  brand       String?
  model       String?
  quantity    Int

  // When and where
  installedDate DateTime
  workshopName  String?
  totalCost     Float?

  notes String?

  createdAt DateTime @default(now())

  @@map("tire_history")
}

// ============================================
// OFFER
// ============================================

model Offer {
  id            String      @id @default(cuid())
  tireRequestId String
  tireRequest   TireRequest @relation(fields: [tireRequestId], references: [id])
  workshopId    String
  workshop      Workshop    @relation(fields: [workshopId], references: [id])

  // Tire Details (for compatibility with existing offers)
  tireBrand   String
  tireModel   String
  description String?

  // Multiple tire options (for new offers)
  tireOptions TireOption[]

  // Pricing
  price              Float // Total price (for compatibility)
  pricePerTire       Float?
  installationFee    Float?
  durationMinutes    Int? // Geschätzte Dauer für den Service
  balancingPrice     Float?   @map("balancingprice") // Wuchten-Preis für Wheel Change
  storagePrice       Float?   @map("storageprice") // Einlagerung-Preis für Wheel Change
  storageAvailable   Boolean? @default(false) @map("storageavailable") // Einlagerung verfügbar
  motorcycleTireType String?  @map("motorcycle_tire_type") // FRONT, REAR, or BOTH for motorcycle offers

  // Distance
  distanceKm Float? @map("distance_km") // Distance from customer to workshop in kilometers

  // Validity
  validUntil DateTime

  // Status
  status String @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED

  // If accepted
  acceptedAt             DateTime?
  declinedAt             DateTime?             @map("declined_at")
  customerWantsBalancing Boolean?              @default(false) @map("customer_wants_balancing")
  customerWantsStorage   Boolean?              @default(false) @map("customer_wants_storage")
  selectedTireOptionIds  String[]              @default([]) @map("selected_tire_option_ids") // IDs der vom Kunden ausgewählten TireOptions
  booking                Booking?
  affiliateConversions   AffiliateConversion[] // Tracking von Affiliate-Conversions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("offers")
}

model TireOption {
  id      String @id @default(cuid())
  offerId String @map("offer_id")
  offer   Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)

  brand              String
  model              String
  pricePerTire       Float   @map("price_per_tire")
  montagePrice       Float?  @map("montage_price") // Montage price for service packages (Brake, Battery, etc.)
  motorcycleTireType String? @map("motorcycle_tire_type") // FRONT, REAR, or BOTH for motorcycle tire options
  carTireType        String? @map("car_tire_type") // ALL_FOUR, FRONT_TWO, or REAR_TWO for car tire options
  description        String? // Achsen-Info für Brake Service (z.B. "Vorderachse: Nur Bremsbeläge")

  bookings Booking[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("tire_options")
}

// ============================================
// BOOKING & APPOINTMENT
// ============================================

model Booking {
  id                   String      @id @default(cuid())
  tireRequestId        String      @unique
  tireRequest          TireRequest @relation(fields: [tireRequestId], references: [id])
  customerId           String
  customer             Customer    @relation(fields: [customerId], references: [id])
  workshopId           String
  workshop             Workshop    @relation(fields: [workshopId], references: [id])
  offerId              String      @unique
  offer                Offer       @relation(fields: [offerId], references: [id])
  selectedTireOptionId String?
  selectedTireOption   TireOption? @relation(fields: [selectedTireOptionId], references: [id])

  // Appointment
  appointmentDate   DateTime
  appointmentTime   String
  estimatedDuration Int       @default(60) // Minuten
  employeeId        String?
  employee          Employee? @relation(fields: [employeeId], references: [id])
  googleEventId     String? // Google Calendar Event ID

  // Status
  status String @default("CONFIRMED") // CONFIRMED, COMPLETED, CANCELLED, NO_SHOW

  // Payment
  paymentMethod String? // PAYPAL, BANK_TRANSFER, CREDIT_CARD, ON_SITE
  paymentStatus String    @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  paidAt        DateTime?

  // Notes
  customerNotes String?
  workshopNotes String?

  // Optional services (for wheel change)
  wantsBalancing Boolean? @default(false) @map("wantsbalancing")
  wantsStorage   Boolean? @default(false) @map("wantsstorage")

  // After completion
  completedAt DateTime?
  review      Review?
  tireRating  TireRating?
  commission  Commission?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bookings")
}

// ============================================
// REVIEW & RATING
// ============================================

model Review {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id])

  // Rating
  rating  Int // 1-5 Sterne
  comment String?

  // Response
  workshopResponse String?
  respondedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}

// ============================================
// TIRE RATING (Customer's personal tire notes)
// ============================================

model TireRating {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Rating
  rating  Int // 1-5 Sterne
  comment String? // Persönliche Notizen zu den Reifen

  // Categories (optional detailed ratings)
  quietnessRating Int? // 1-5: Lautstärke
  gripRating      Int? // 1-5: Grip/Haftung
  wearRating      Int? // 1-5: Verschleiß
  comfortRating   Int? // 1-5: Komfort

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tire_ratings")
}

// ============================================
// COMMISSION TRACKING
// ============================================

model Commission {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id])

  // Amounts (Netto-Rechnung)
  orderTotal       Float // Gesamtbetrag des Auftrags (Brutto)
  commissionRate   Float @default(4.9) // Prozentsatz (4,9%)
  commissionAmount Float // Berechnete Provision (Brutto)

  // Tax Calculation (für Rechnung)
  taxRate     Float  @default(19.0) // MwSt-Satz (19%)
  taxAmount   Float? // MwSt-Betrag auf Provision
  netAmount   Float? // Provision Netto (ohne MwSt)
  grossAmount Float? // Provision Brutto (= commissionAmount)

  // Billing Period
  billingPeriodStart DateTime? // Start des Abrechnungszeitraums
  billingPeriodEnd   DateTime? // Ende des Abrechnungszeitraums
  billingMonth       Int? // Monat der Abrechnung (1-12)
  billingYear        Int? // Jahr der Abrechnung

  // Status
  status String @default("PENDING") // PENDING, BILLED, COLLECTED, FAILED, REFUNDED

  // Billing
  billedAt    DateTime?
  collectedAt DateTime?
  failedAt    DateTime? @map("failedat")

  // SEPA/GoCardless Details
  sepaReference String? // Legacy SEPA Referenz
  sepaStatus    String? // Legacy SEPA Status

  // GoCardless Integration
  gocardlessPaymentId     String?   @unique // GoCardless Payment ID
  gocardlessPaymentStatus String? // pending_submission, submitted, confirmed, paid_out, failed, cancelled
  gocardlessChargeDate    DateTime? // Geplantes Abbuchungsdatum
  gocardlessPayoutId      String? // GoCardless Payout ID (wenn ausgezahlt)

  // Invoice/Document
  invoiceNumber String?   @unique // Rechnungsnummer (z.B. RE-2024-001)
  invoiceUrl    String? // Link zur generierten PDF-Rechnung
  invoiceSentAt DateTime? // Wann wurde Rechnung versendet

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workshopId, status])
  @@index([billingMonth, billingYear])
  @@index([gocardlessPaymentId])
  @@map("commissions")
}

// ============================================
// VACATION MANAGEMENT
// ============================================

model WorkshopVacation {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String? // e.g., "Betriebsurlaub", "Feiertage", "Umbau"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workshop_vacations")
}

model EmployeeVacation {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String? // e.g., "Urlaub", "Krankheit", "Fortbildung"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employee_vacations")
}

// ============================================
// WORKSHOP SERVICES
// ============================================

model WorkshopService {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Service Type
  serviceType String // TIRE_CHANGE, WHEEL_CHANGE, TIRE_REPAIR, MOTORCYCLE_TIRE, ALIGNMENT_BOTH, CLIMATE_SERVICE, BRAKE_SERVICE, BATTERY_SERVICE, OTHER_SERVICES

  // Pricing
  basePrice  Float // Grundpreis (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE, sonst Gesamtpreis)
  basePrice4 Float? // Preis für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)

  // Service-specific pricing
  runFlatSurcharge         Float? // Aufpreis für Runflat-Reifen (pro Reifen bei TIRE_CHANGE)
  disposalFee              Float? // Entsorgungsgebühr (pro Reifen)
  wheelSizeSurcharge       Json? // {"17": 5, "18": 10, "19": 15} - Aufpreis nach Radgröße
  balancingPrice           Float? @map("balancingprice") // Wuchten-Preis (pro Rad bei WHEEL_CHANGE)
  storagePrice             Float? @map("storageprice") // Einlagerungspreis (pro Saison bei WHEEL_CHANGE) - Optional
  refrigerantPricePer100ml Float? // Preis pro 100ml Kältemittel (nur bei CLIMATE_SERVICE)

  // Duration
  durationMinutes  Int // Dauer in Minuten (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE)
  durationMinutes4 Int? // Dauer für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)
  balancingMinutes Int?     @map("balancingminutes") // Zusätzliche Dauer für Wuchten (pro Rad bei WHEEL_CHANGE)
  storageAvailable Boolean? @default(false) @map("storageavailable") // Einlagerung verfügbar

  // Service Packages (JSON structure for service-specific options - DEPRECATED, use ServicePackage relation instead)
  packages Json? // Legacy field - use servicePackages relation for new implementations

  // Availability
  isActive Boolean @default(true)

  // Notes
  description   String? // Beschreibung des Services
  internalNotes String? // Interne Notizen

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servicePackages ServicePackage[]

  @@unique([workshopId, serviceType])
  @@map("workshop_services")
}

// ============================================
// SERVICE PACKAGES (for granular package management)
// ============================================

model ServicePackage {
  id                String          @id @default(cuid())
  workshopServiceId String
  workshopService   WorkshopService @relation(fields: [workshopServiceId], references: [id], onDelete: Cascade)

  // Package Type (service-specific)
  // TIRE_CHANGE: two_tires, four_tires, two_tires_disposal, four_tires_disposal
  // WHEEL_CHANGE: basic, with_balancing, with_storage, complete
  // TIRE_REPAIR: small, large, emergency
  // MOTORCYCLE_TIRE: front, rear, both
  // ALIGNMENT_BOTH: measurement_only, with_adjustment, with_adjustment_inspection
  // CLIMATE_SERVICE: check, basic, comfort, premium
  // BRAKE_SERVICE: front_pads, front_pads_discs, rear_pads, rear_pads_discs, rear_pads_discs_handbrake
  // BATTERY_SERVICE: test, replacement, premium
  // OTHER_SERVICES: rdks, valve, storage, tpms
  packageType String

  // Package Details
  name        String // Display name (e.g., "Klimacheck", "2 Reifen wechseln")
  description String? // Package description

  // Pricing & Duration
  price           Float // Price for this package
  durationMinutes Int // Duration in minutes

  // Availability
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workshopServiceId, packageType])
  @@map("service_packages")
}

// ============================================
// WORKSHOP LANDING PAGES
// ============================================

model WorkshopLandingPage {
  id         String   @id @default(cuid())
  workshopId String   @unique
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Status & URL
  isActive Boolean @default(false)
  slug     String  @unique // URL slug (e.g., "autoservice-mueller-berlin")

  // SEO
  metaTitle       String? // Max 60 chars
  metaDescription String? @db.Text // Max 160 chars
  keywords        String? // Comma-separated keywords

  // Hero Section
  heroHeadline String? // Main headline
  heroSubline  String? // Subheadline
  heroImage    String? // Hero background image URL
  ctaText      String  @default("Jetzt Anfrage stellen") // CTA button text

  // About Section
  aboutTitle String?
  aboutText  String? @db.Text

  // Images
  galleryImages String[] // Array of image URLs

  // Team Section
  showTeam    Boolean @default(false)
  teamMembers Json? // [{name, role, image, bio}]

  // Services (custom or from workshop)
  useWorkshopServices Boolean @default(true) // Use workshop's services
  customServices      Json? // Custom service list if not using workshop services

  // Features
  showLogo         Boolean @default(true)
  showReviews      Boolean @default(true)
  showMap          Boolean @default(true)
  showOpeningHours Boolean @default(true)
  showPartnerLogos Boolean @default(false)

  // Partner/Brand Logos
  partnerLogos Json? // [{name, image}]

  // FAQ Section
  showFaq  Boolean @default(false)
  faqItems Json? // [{question, answer}]

  // Social Media
  socialLinks Json? // {facebook, instagram, youtube}

  // Design & Branding
  template     String @default("modern") // modern, classic, minimal, professional
  primaryColor String @default("#2563eb") // Brand color
  accentColor  String @default("#10b981") // Accent color

  // Analytics
  viewCount    Int       @default(0)
  lastViewedAt DateTime?

  // Tracking
  lastPublishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@map("workshop_landing_pages")
}

// ============================================
// BEREIFUNG24 EMPLOYEES (Staff/Mitarbeiter)
// ============================================

model B24Employee {
  id       String  @id @default(cuid())
  email    String  @unique
  password String? // Null until they set it via email link

  // Personal Info
  firstName  String
  lastName   String
  phone      String?
  position   String? // e.g., "Account Manager", "Buchhalter", "Marketing Manager"
  department String? // e.g., "Buchhaltung", "Marketing", "Vertrieb", "Support"

  // Status
  isActive      Boolean @default(true)
  emailVerified Boolean @default(false)

  // Password Setup
  setupToken       String?   @unique // Token for initial password setup
  setupTokenExpiry DateTime? // Token expires after 24h

  // Login tracking
  lastLoginAt DateTime?

  // Relations
  permissions       B24EmployeePermission[]
  assignedWorkshops Workshop[]               @relation("WorkshopAssignment")
  activityLogs      B24EmployeeActivityLog[]

  // Sales CRM Relations
  assignedProspects   ProspectWorkshop[]    @relation("AssignedProspects")
  createdInteractions ProspectInteraction[] @relation("InteractionCreator")
  assignedTasks       ProspectTask[]        @relation("AssignedTasks")
  createdTasks        ProspectTask[]        @relation("TaskCreator")
  createdNotes        ProspectNote[]        @relation("NoteCreator")

  // KVP Relations
  submittedImprovements ImprovementSuggestion[] @relation("ImprovementSubmitter")
  assignedImprovements  ImprovementSuggestion[] @relation("ImprovementAssignee")
  improvementComments   ImprovementComment[]

  // File Management Relations
  createdFolders FileFolder[]
  uploadedFiles  FileUpload[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("b24_employees")
}

model B24EmployeePermission {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Which admin page/section
  resource String // e.g., "customers", "workshops", "analytics", "billing", "email-templates"

  // What they can do
  canRead   Boolean @default(false)
  canWrite  Boolean @default(false)
  canDelete Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, resource])
  @@map("b24_employee_permissions")
}

model B24EmployeeActivityLog {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  action     String // e.g., "workshop_assigned", "customer_contacted", "offer_reviewed"
  resource   String? // e.g., "workshop", "customer", "offer"
  resourceId String? // ID of the resource
  details    String? @db.Text // JSON with additional details
  ipAddress  String?

  createdAt DateTime @default(now())

  @@index([employeeId])
  @@index([createdAt])
  @@map("b24_employee_activity_logs")
}

// ============================================
// WORKSHOP CRM / SALES TRACKING
// ============================================

model WorkshopCRM {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Sales Status
  leadStatus              String   @default("NEUKONTAKT") // NEUKONTAKT, INTERESSIERT, VERHANDLUNG, AKTIV, INAKTIV
  potential               String? // HOCH, MITTEL, NIEDRIG
  estimatedMonthlyRevenue Decimal? @db.Decimal(10, 2)

  // Contact Person
  mainContactName     String?
  mainContactPosition String?
  mainContactPhone    String?
  mainContactEmail    String?
  decisionMaker       Boolean @default(false)

  // Competition
  otherPlatforms String? @db.Text // Comma-separated or JSON

  // Next Steps
  nextContactDate DateTime?
  nextContactType String? // TELEFON, BESUCH, EMAIL
  followUpNotes   String?   @db.Text

  // Contract Status
  contractStatus    String? // KEIN_VERTRAG, ANGEBOT_GESENDET, VERHANDLUNG, VERTRAG_AKTIV
  contractStartDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  interactions WorkshopInteraction[]
  notes        WorkshopNote[]

  @@unique([workshopId])
  @@map("workshop_crm")
}

model WorkshopInteraction {
  id    String      @id @default(cuid())
  crmId String
  crm   WorkshopCRM @relation(fields: [crmId], references: [id], onDelete: Cascade)

  employeeId   String?
  employeeName String // Name of B24 employee who made contact

  type     String // TELEFON, BESUCH, EMAIL, MEETING
  date     DateTime
  duration Int? // Duration in minutes

  summary String  @db.Text
  outcome String? // POSITIV, NEUTRAL, NEGATIV, FOLLOW_UP_NEEDED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([crmId])
  @@index([date])
  @@map("workshop_interactions")
}

model WorkshopNote {
  id    String      @id @default(cuid())
  crmId String
  crm   WorkshopCRM @relation(fields: [crmId], references: [id], onDelete: Cascade)

  employeeId   String?
  employeeName String // Name of B24 employee who created note

  category String? // ALLGEMEIN, WICHTIG, ANFORDERUNG, PROBLEM, CHANCE
  title    String?
  content  String  @db.Text

  isPinned Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([crmId])
  @@index([createdAt])
  @@map("workshop_notes")
}

// ============================================
// ADMIN LOGS
// ============================================

model AdminLog {
  id         String  @id @default(cuid())
  adminEmail String
  action     String
  details    String?

  createdAt DateTime @default(now())

  @@map("admin_logs")
}

// ============================================
// PAGE VIEWS / ANALYTICS
// ============================================

model PageView {
  id String @id @default(cuid())

  // Page information
  path      String // e.g., "/", "/dashboard/customer", "/lp/werkstatt-mueller"
  fullUrl   String? // Full URL including query params
  pageTitle String? // Page title

  // User information
  userId    String? // Logged-in user ID (optional)
  userRole  String? // CUSTOMER, WORKSHOP, ADMIN (optional)
  ipAddress String? // IP address (anonymized for privacy)
  userAgent String? // Browser/device info

  // Referrer
  referrer String? // Where did the user come from

  // Workshop landing page tracking
  workshopId String? // If viewing a workshop landing page

  // Session tracking
  sessionId String? // Session identifier

  // Timing
  viewedAt DateTime @default(now())

  @@index([path])
  @@index([workshopId])
  @@index([viewedAt])
  @@index([userId])
  @@map("page_views")
}

// ============================================
// SALES CRM - PROSPECT MANAGEMENT
// ============================================

// Potenzielle Werkstatt aus Google Places
model ProspectWorkshop {
  id String @id @default(cuid())

  // Google Places Daten
  googlePlaceId String  @unique @map("google_place_id")
  name          String
  address       String
  city          String
  postalCode    String  @map("postal_code")
  state         String? // Bundesland
  country       String  @default("DE")
  phone         String?
  website       String?
  email         String?

  // Google Places Ratings
  rating      Float?
  reviewCount Int?   @default(0) @map("review_count")
  priceLevel  Int?   @map("price_level") // 0-4 (Google Places price level)

  // Media
  photoUrls String[] @map("photo_urls") // Array von Photo URLs

  // Location
  latitude  Float
  longitude Float

  // Google Places Metadata
  placeTypes   String[] @map("place_types") // ["car_repair", "car_dealer", etc.]
  openingHours Json?    @map("opening_hours") // Google Places opening hours structure

  // Sales Pipeline
  status           ProspectStatus @default(NEW)
  priority         Priority       @default(MEDIUM)
  estimatedRevenue Float?         @map("estimated_revenue") // Geschätzter Jahresumsatz

  // Lead Scoring
  leadScore Int? @default(50) @map("lead_score") // 0-100

  // Zuständigkeit
  assignedToId String?      @map("assigned_to_id") // B24Employee ID
  assignedTo   B24Employee? @relation("AssignedProspects", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt   DateTime?    @map("assigned_at")

  // Tracking
  source           String // "google_places", "manual", "referral", "website"
  firstContactDate DateTime? @map("first_contact_date")
  lastContactDate  DateTime? @map("last_contact_date")
  nextFollowUpDate DateTime? @map("next_follow_up_date")

  // Conversion
  convertedToWorkshopId String?   @unique @map("converted_to_workshop_id")
  convertedWorkshop     Workshop? @relation("ConvertedFromProspect", fields: [convertedToWorkshopId], references: [id], onDelete: SetNull)
  convertedAt           DateTime? @map("converted_at")
  conversionValue       Float?    @map("conversion_value") // Tatsächlicher Wert bei Conversion

  // Loss Tracking
  lostReason String? @map("lost_reason") // Grund warum verloren

  // Relations
  interactions ProspectInteraction[]
  tasks        ProspectTask[]
  notes        ProspectNote[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([assignedToId])
  @@index([postalCode])
  @@index([city])
  @@index([leadScore])
  @@index([nextFollowUpDate])
  @@map("prospect_workshops")
}

enum ProspectStatus {
  NEW // Neu gefunden
  CONTACTED // Erstkontakt gemacht
  QUALIFIED // Qualifiziert (hat Potenzial)
  MEETING_SCHEDULED // Termin vereinbart
  DEMO_COMPLETED // Demo durchgeführt
  PROPOSAL_SENT // Angebot verschickt
  NEGOTIATING // In Verhandlung
  VERBAL_AGREEMENT // Mündliche Zusage
  CONTRACT_SENT // Vertrag verschickt
  WON // Gewonnen → Workshop erstellt
  LOST // Verloren
  NOT_INTERESTED // Kein Interesse
  NOT_REACHABLE // Nicht erreichbar
  CALLBACK // Follow-up geplant
  ON_HOLD // Pausiert
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Interaktionen/Kontakthistorie
model ProspectInteraction {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  type    InteractionType
  channel ContactChannel
  subject String
  notes   String          @db.Text
  outcome String? // Ergebnis der Interaktion

  // Duration for calls/meetings (in minutes)
  duration Int?

  // Sentiment Analysis
  sentiment String? // "positive", "neutral", "negative"

  // Next Steps
  nextSteps String? @map("next_steps") @db.Text

  // Attachments
  attachments String[] // URLs zu hochgeladenen Dateien

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("InteractionCreator", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([prospectId])
  @@index([createdById])
  @@index([createdAt])
  @@map("prospect_interactions")
}

enum InteractionType {
  CALL // Telefonat
  EMAIL // E-Mail
  MEETING // Persönliches Treffen
  DEMO // Produkt-Demo
  NOTE // Notiz/Memo
  PROPOSAL // Angebot versendet
  CONTRACT // Vertrag
  FOLLOW_UP // Follow-up Kontakt
}

enum ContactChannel {
  PHONE
  EMAIL
  IN_PERSON // Persönlich
  VIDEO_CALL // Video-Call
  WHATSAPP
  SMS
  LINKEDIN
  OTHER
}

// Tasks/Follow-ups für Prospects
model ProspectTask {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  title       String
  description String?  @db.Text
  dueDate     DateTime @map("due_date")

  priority Priority   @default(MEDIUM)
  status   TaskStatus @default(PENDING)

  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")

  // Reminder
  reminderDate DateTime? @map("reminder_date")
  reminderSent Boolean   @default(false) @map("reminder_sent")

  assignedToId String      @map("assigned_to_id")
  assignedTo   B24Employee @relation("AssignedTasks", fields: [assignedToId], references: [id])

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("TaskCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([prospectId])
  @@index([assignedToId])
  @@index([dueDate])
  @@index([status])
  @@map("prospect_tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Notizen zu Prospects
model ProspectNote {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  content  String  @db.Text
  isPinned Boolean @default(false) @map("is_pinned") // Wichtige Notizen anpinnen

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("NoteCreator", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([prospectId])
  @@index([createdById])
  @@map("prospect_notes")
}

// Erweitere B24Employee Model für Sales-Beziehungen
// (Diese Relations müssen zum existierenden B24Employee Model hinzugefügt werden)
// assignedProspects     ProspectWorkshop[]      @relation("AssignedProspects")
// createdInteractions   ProspectInteraction[]   @relation("InteractionCreator")
// assignedTasks         ProspectTask[]          @relation("AssignedTasks")
// createdTasks          ProspectTask[]          @relation("TaskCreator")
// createdNotes          ProspectNote[]          @relation("NoteCreator")

// ============================================
// KVP - KONTINUIERLICHER VERBESSERUNGSPROZESS
// ============================================

model ImprovementSuggestion {
  id String @id @default(cuid())

  title       String              @db.VarChar(200)
  description String              @db.Text
  category    String              @db.VarChar(50) // z.B. "UI/UX", "Performance", "Prozess", "Feature"
  priority    ImprovementPriority @default(MEDIUM)
  status      ImprovementStatus   @default(NEW)

  // Zeitplan
  estimatedEffort String?   @db.VarChar(50) // z.B. "1 Tag", "1 Woche", "1 Monat"
  plannedDate     DateTime? // Geplante Umsetzung
  completedDate   DateTime? // Tatsächliche Umsetzung

  // Beziehungen
  submittedById String      @map("submitted_by_id")
  submittedBy   B24Employee @relation("ImprovementSubmitter", fields: [submittedById], references: [id])

  assignedToId String?      @map("assigned_to_id")
  assignedTo   B24Employee? @relation("ImprovementAssignee", fields: [assignedToId], references: [id])

  // Kommentare und Feedback
  comments ImprovementComment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([submittedById])
  @@index([assignedToId])
  @@map("improvement_suggestions")
}

model ImprovementComment {
  id String @id @default(cuid())

  suggestionId String                @map("suggestion_id")
  suggestion   ImprovementSuggestion @relation(fields: [suggestionId], references: [id], onDelete: Cascade)

  content      String  @db.Text
  isStatusNote Boolean @default(false) @map("is_status_note") // true = System-Notiz bei Statusänderung

  authorId String      @map("author_id")
  author   B24Employee @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([suggestionId])
  @@index([authorId])
  @@map("improvement_comments")
}

enum ImprovementStatus {
  NEW // Neu eingereicht
  IN_REVIEW // In Prüfung
  APPROVED // Genehmigt
  IN_PROGRESS // In Umsetzung
  COMPLETED // Abgeschlossen
  REJECTED // Abgelehnt
  ON_HOLD // Zurückgestellt
}

enum ImprovementPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// FILE MANAGEMENT / DOCUMENT CLOUD
// ============================================

model FileFolder {
  id         String       @id @default(cuid())
  name       String
  parentId   String?
  parent     FileFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  subfolders FileFolder[] @relation("FolderHierarchy")

  files FileUpload[]

  createdById String
  createdBy   B24Employee @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([createdById])
  @@map("file_folders")
}

model FileUpload {
  id          String @id @default(cuid())
  name        String // Original filename
  storagePath String @unique // Path on server filesystem
  mimeType    String
  size        Int // Size in bytes

  folderId String?
  folder   FileFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  uploadedById String
  uploadedBy   B24Employee @relation(fields: [uploadedById], references: [id])

  description String?

  downloads      Int       @default(0)
  lastDownloadAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([folderId])
  @@index([uploadedById])
  @@index([createdAt])
  @@map("file_uploads")
}

// ============================================
// PROCUREMENT & INVESTMENT MANAGEMENT
// ============================================

// Lieferanten / Suppliers
model Supplier {
  id      String  @id @default(cuid())
  name    String
  address String?
  zipCode String?
  city    String?
  country String? @default("Deutschland")
  email   String?
  phone   String?
  website String?

  // Tax & Banking
  taxId    String? // USt-IdNr.
  vatId    String? // Steuernummer
  iban     String?
  bic      String?
  bankName String?

  // Payment Terms
  paymentTerms String? @default("30 Tage netto") // z.B. "14 Tage 2% Skonto, 30 Tage netto"

  // Categories
  categories String[] // ["BUERO", "IT", "FAHRZEUGE", "MARKETING", "SONSTIGES"]

  // Rating
  rating Int     @default(0) // 0-5 Sterne
  notes  String? @db.Text

  // Relations
  orders   PurchaseOrder[]
  requests ProcurementRequest[]

  // Metadata
  isActive    Boolean @default(true)
  createdById String
  createdBy   User    @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
  @@map("suppliers")
}

// Bedarfsanforderungen / Procurement Requests
model ProcurementRequest {
  id            String @id @default(cuid())
  requestNumber String @unique // z.B. "ANF-2025-001"

  // Requester
  requestedById String
  requestedBy   User   @relation(fields: [requestedById], references: [id])

  // Request Details
  title          String
  description    String?             @db.Text
  category       ProcurementCategory
  estimatedPrice Float // Geschätzter Preis in EUR

  // Priority & Classification
  urgency    UrgencyLevel @default(NORMAL)
  costCenter CostCenter

  // Supplier
  supplierId   String?
  supplier     Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  supplierName String? // Falls noch kein Lieferant im System

  // Approval Workflow
  status          RequestStatus @default(PENDING)
  approvedById    String?
  approvedBy      User?         @relation("ApprovedRequests", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?       @db.Text

  // Link to Order
  orderId String?        @unique
  order   PurchaseOrder? @relation(fields: [orderId], references: [id])

  // Link to Investment
  investmentItemId String?
  investmentItem   InvestmentItem? @relation(fields: [investmentItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestNumber])
  @@index([requestedById])
  @@index([status])
  @@index([costCenter])
  @@map("procurement_requests")
}

// Bestellungen / Purchase Orders
model PurchaseOrder {
  id          String @id @default(cuid())
  orderNumber String @unique // z.B. "PO-2025-001"

  // Supplier
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Order Details
  items      OrderItem[]
  totalNet   Float // Gesamt netto
  totalVat   Float // Gesamt MwSt
  totalGross Float // Gesamt brutto

  // Status
  status OrderStatus @default(DRAFT)

  // Ordering
  orderedById String
  orderedBy   User      @relation(fields: [orderedById], references: [id])
  orderedAt   DateTime?

  // Delivery
  deliveryAddress  String?   @db.Text
  expectedDelivery DateTime?
  actualDelivery   DateTime?
  receivedById     String?
  receivedBy       User?     @relation("ReceivedOrders", fields: [receivedById], references: [id])
  receivedAt       DateTime?

  // Invoice & Payment
  invoiceNumber   String?
  invoiceDate     DateTime?
  invoiceReceived Boolean   @default(false)
  paymentDue      DateTime?
  paid            Boolean   @default(false)
  paidAt          DateTime?
  paidAmount      Float?

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text

  // Links
  request ProcurementRequest?
  assets  Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderNumber])
  @@index([supplierId])
  @@index([status])
  @@index([orderedAt])
  @@map("purchase_orders")
}

// Bestellpositionen / Order Items
model OrderItem {
  id      String        @id @default(cuid())
  orderId String
  order   PurchaseOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  position    Int // Positionsnummer
  description String
  quantity    Int
  unit        String @default("Stück") // Stück, kg, Liter, etc.

  priceNet Float // Einzelpreis netto
  vatRate  Float // MwSt-Satz (0.19 oder 0.07)

  totalNet   Float // Gesamt netto
  totalVat   Float // Gesamt MwSt
  totalGross Float // Gesamt brutto

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@map("order_items")
}

// Anlagenvermögen / Assets
model Asset {
  id          String @id @default(cuid())
  assetNumber String @unique // z.B. "ASS-2025-001"

  // Asset Details
  name        String
  description String?       @db.Text
  category    AssetCategory

  // Acquisition
  acquisitionCost Float // Anschaffungskosten
  acquisitionDate DateTime
  orderId         String?
  order           PurchaseOrder? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Depreciation (AfA)
  usefulLife         Int // Nutzungsdauer in Jahren
  afaMethod          AfaMethod @default(LINEAR)
  annualDepreciation Float // Jährliche AfA

  // Current Value
  bookValue        Float // Aktueller Buchwert
  fullyDepreciated Boolean @default(false)

  // Location & Assignment
  costCenter   CostCenter
  location     String? // z.B. "Büro München, Raum 301"
  assignedToId String?
  assignedTo   User?      @relation(fields: [assignedToId], references: [id], onDelete: SetNull)

  // Additional Info
  serialNumber String?
  manufacturer String?
  model        String?

  // Status
  status         AssetStatus @default(ACTIVE)
  disposalDate   DateTime?
  disposalReason String?     @db.Text

  // Relations
  depreciationEntries DepreciationEntry[]

  // Metadata
  createdById String
  createdBy   User   @relation("CreatedAssets", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetNumber])
  @@index([category])
  @@index([costCenter])
  @@index([status])
  @@map("assets")
}

// Abschreibungsbuchungen / Depreciation Entries
model DepreciationEntry {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  year      Int
  month     Int? // Optional für monatliche AfA
  amount    Float // Abschreibungsbetrag
  bookValue Float // Buchwert nach Abschreibung

  notes String?

  createdAt DateTime @default(now())

  @@unique([assetId, year, month])
  @@index([assetId])
  @@index([year])
  @@map("depreciation_entries")
}

// Investitionsplanung / Investment Planning
model InvestmentPlan {
  id   String @id @default(cuid())
  year Int    @unique

  // Budget per Cost Center
  totalBudget Float @default(0)
  spent       Float @default(0)
  reserved    Float @default(0) // Genehmigte aber noch nicht bestellte Anfragen

  // Relations
  items   InvestmentItem[]
  budgets CostCenterBudget[]

  // Metadata
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year])
  @@map("investment_plans")
}

// Budget pro Kostenstelle
model CostCenterBudget {
  id     String         @id @default(cuid())
  planId String
  plan   InvestmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  costCenter CostCenter
  budget     Float
  spent      Float      @default(0)
  reserved   Float      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, costCenter])
  @@index([planId])
  @@map("cost_center_budgets")
}

// Investitionsposten / Investment Items
model InvestmentItem {
  id     String         @id @default(cuid())
  planId String
  plan   InvestmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Details
  title       String
  description String?    @db.Text
  costCenter  CostCenter

  // Cost
  estimatedCost Float
  actualCost    Float?

  // Planning
  priority     InvestmentPriority @default(MEDIUM)
  type         InvestmentType
  quarter      Int? // 1, 2, 3, 4
  plannedMonth Int? // 1-12

  // Status
  status InvestmentStatus @default(PLANNED)

  // Relations
  requests ProcurementRequest[]

  // ROI Calculation (optional)
  expectedSavings Float? // Erwartete jährliche Einsparung
  paybackPeriod   Float? // Amortisationsdauer in Jahren

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
  @@index([costCenter])
  @@index([status])
  @@map("investment_items")
}

// ============================================
// ENUMS FOR PROCUREMENT
// ============================================

enum ProcurementCategory {
  GWG // Geringwertige Wirtschaftsgüter (bis 800€)
  SAMMELPOSTEN // 250-1000€
  ANLAGEVERMOEGEN // ab 1000€
  VERBRAUCH // Verbrauchsmaterial
  SOFTWARE // Software/Lizenzen
  DIENSTLEISTUNG // Dienstleistungen
  SONSTIGES // Sonstiges
}

enum UrgencyLevel {
  LOW
  NORMAL
  HIGH
  EMERGENCY
}

enum CostCenter {
  MARKETING
  SUPPORT
  IT
  BUCHHALTUNG
  PERSONAL
  ALLGEMEIN
}

enum RequestStatus {
  PENDING // Ausstehend
  APPROVED // Genehmigt
  REJECTED // Abgelehnt
  ORDERED // Bestellt
  COMPLETED // Abgeschlossen
  CANCELLED // Storniert
}

enum OrderStatus {
  DRAFT // Entwurf
  SENT // Versendet
  CONFIRMED // Bestätigt
  PARTIALLY_DELIVERED // Teilweise geliefert
  DELIVERED // Geliefert
  INVOICED // Rechnung erhalten
  PAID // Bezahlt
  CANCELLED // Storniert
}

enum AssetCategory {
  COMPUTER // Computer/Laptops
  MONITOR // Monitore
  PERIPHERALS // Peripherie (Drucker, Scanner, etc.)
  SOFTWARE // Software
  FURNITURE // Büromöbel
  VEHICLE // Fahrzeuge
  PHONE // Telefone/Smartphones
  NETWORK // Netzwerkgeräte
  SERVER // Server
  OTHER // Sonstiges
}

enum AfaMethod {
  LINEAR // Lineare Abschreibung
  DEGRESSIV // Degressive Abschreibung
  SOFORT // Sofortabschreibung (GWG)
}

enum AssetStatus {
  ACTIVE // Aktiv in Nutzung
  INACTIVE // Nicht in Nutzung
  IN_REPAIR // In Reparatur
  DISPOSED // Ausgemustert
  SOLD // Verkauft
}

enum InvestmentPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InvestmentType {
  REPLACEMENT // Ersatzinvestition
  EXPANSION // Erweiterungsinvestition
  RATIONALIZATION // Rationalisierungsinvestition
  STRATEGIC // Strategische Investition
}

enum InvestmentStatus {
  PLANNED // Geplant
  APPROVED // Genehmigt
  IN_PROGRESS // In Bearbeitung
  COMPLETED // Abgeschlossen
  CANCELLED // Abgebrochen
  POSTPONED // Verschoben
}

// ============================================
// CO2 TRACKING SYSTEM
// ============================================

model CO2Settings {
  id                 String @id @default(cuid())
  workshopsToCompare Int    @default(3) // Anzahl Werkstätten, die Kunde sonst besuchen würde

  // Durchschnittswerte pro km (Fallback wenn kein Fahrzeug bekannt)
  co2PerKmCombustion Int @default(140) // g CO₂/km für Verbrenner (Durchschnitt)
  co2PerKmElectric   Int @default(50) // g CO₂/km für E-Autos (Strommix DE)

  // Kraftstoffspezifische CO₂-Faktoren (für präzise Berechnung mit Verbrauchsdaten)
  co2PerLiterPetrol Int @default(2320) // g CO₂/Liter Benzin
  co2PerLiterDiesel Int @default(2640) // g CO₂/Liter Diesel
  co2PerLiterLPG    Int @default(1640) // g CO₂/Liter LPG (Autogas)
  co2PerKgCNG       Int @default(1990) // g CO₂/kg CNG (Erdgas)
  co2PerKWhElectric Int @default(420) // g CO₂/kWh Strom (DE Mix)

  // Legacy field (kept for backwards compatibility)
  co2PerLiterFuel Int @default(2330) // g CO₂/Liter (Durchschnitt Benzin/Diesel)

  // Kraftstoffpreise für monetäre Einsparungsberechnung
  petrolPricePerLiter Float @default(1.75) // €/Liter (Benzin)
  dieselPricePerLiter Float @default(1.65) // €/Liter (Diesel)
  lpgPricePerLiter    Float @default(0.80) // €/Liter (LPG)
  cngPricePerKg       Float @default(1.10) // €/kg (CNG)
  electricPricePerKWh Float @default(0.35) // €/kWh (Strom)

  // Legacy field (kept for backwards compatibility)
  fuelPricePerLiter Float @default(1.65) // €/Liter (Durchschnitt)

  updatedAt DateTime @updatedAt

  @@map("co2_settings")
}

enum FuelType {
  UNKNOWN
  PETROL // Benzin
  DIESEL // Diesel
  ELECTRIC // Elektro
  HYBRID // Hybrid
  PLUGIN_HYBRID // Plugin-Hybrid
  LPG // Autogas
  CNG // Erdgas
}

// ========================================
// AFFILIATE / INFLUENCER MANAGEMENT SYSTEM
// ========================================

model Influencer {
  id String @id @default(cuid())

  // Basic Info
  email String  @unique
  code  String  @unique // Unique affiliate code: z.B. "PETER24"
  name  String?

  // Registration Status
  isRegistered            Boolean   @default(false)
  registrationToken       String?   @unique // Token für erste Registrierung
  registrationTokenExpiry DateTime?

  // Password Reset
  resetToken       String?   @unique @map("resettoken")
  resetTokenExpiry DateTime? @map("resettokenexpiry")

  // Authentication (wenn registriert)
  password String? // Hashed password
  isActive Boolean @default(true)

  // Platform & Channel Info
  platform           InfluencerPlatform?
  channelName        String? // z.B. "@username"
  channelUrl         String?
  additionalChannels Json? // Array of {platform, url}

  // Commission Settings (in Cents)
  commissionPer1000Views            Int @default(300) // €3.00 default
  commissionPerCustomerRegistration Int @default(1500) // €15.00 default
  commissionPerCustomerFirstOffer   Int @default(2500) // €25.00 default
  commissionPerWorkshopRegistration Int @default(1500) // €15.00 default
  commissionPerWorkshopFirstOffer   Int @default(2500) // €25.00 default

  // Time Limits
  activeFrom  DateTime  @default(now())
  activeUntil DateTime? // null = unlimited
  isUnlimited Boolean   @default(false)

  // Payment Info
  paymentMethod PaymentMethod?

  // Bank Transfer
  accountHolder String?
  iban          String?
  bic           String?

  // PayPal
  paypalEmail String?

  // Tax Info
  taxType     TaxType? // INDIVIDUAL or BUSINESS
  companyName String?
  taxId       String? // Steuernummer / USt-ID

  // Address
  street  String?
  zipCode String?
  city    String?
  country String? @default("Deutschland")

  // Admin Notes
  notes String? @db.Text

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  clicks      AffiliateClick[]
  conversions AffiliateConversion[]
  payments    AffiliatePayment[]

  @@map("influencers")
}

model InfluencerApplication {
  id String @id @default(cuid())

  // Basic Info
  name  String
  email String

  // Platform Info
  platform    String // "YouTube", "Instagram", "TikTok", "Facebook", etc.
  channelName String
  channelUrl  String
  followers   Int?

  // Application Content
  message String? @db.Text

  // Status Workflow
  status ApplicationStatus @default(PENDING)

  // Admin Review
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?   @db.Text
  influencerId    String? // Reference to created influencer after approval

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("influencer_applications")
}

// ============================================
// DELETED USERS BLACKLIST
// ============================================

model DeletedUserEmail {
  id           String    @id @default(cuid())
  email        String    @unique // Email kann nicht mehr verwendet werden
  userType     String    @default("CUSTOMER") // 'CUSTOMER' or 'WORKSHOP'
  reason       String?   // Grund für Löschung
  deletedBy    String?   // Admin/Employee der gelöscht hat
  deletedAt    DateTime  @default(now())
  
  // Support-Notizen
  supportNotes String?   @db.Text // Kommentare vom Support-Team
  unlockedAt   DateTime? // Wann wurde entsperrt
  unlockedBy   String?   // Wer hat entsperrt
  updatedAt    DateTime  @updatedAt

  @@map("deleted_user_emails")
}

// ============================================
// INFLUENCER SETTINGS
// ============================================

model InfluencerSettings {
  id String @id @default(cuid())

  // Default commission rates displayed on landing page (in cents)
  defaultPer1000Views     Int @default(300) // €3.00
  defaultPerRegistration  Int @default(1500) // €15.00
  defaultPerAcceptedOffer Int @default(2500) // €25.00

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("influencer_settings")
}

model AffiliateClick {
  id           String     @id @default(cuid())
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  // Tracking Data
  ipAddress   String
  userAgent   String? @db.Text
  referrer    String? @db.Text
  landingPage String?

  // Cookie ID für Attribution
  cookieId String @unique

  // Timestamps
  clickedAt DateTime @default(now())

  // Optional: Device/Location Data
  deviceType String? // mobile, desktop, tablet
  country    String?
  city       String?

  @@index([influencerId])
  @@index([cookieId])
  @@index([clickedAt])
  @@map("affiliate_clicks")
}

model AffiliateConversion {
  id           String     @id @default(cuid())
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  // Conversion Type
  type ConversionType

  // Attribution
  cookieId String // Links back to AffiliateClick

  // Related Entities
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  workshopId String? @map("workshop_id")
  workshop   Workshop? @relation(fields: [workshopId], references: [id])

  tireRequestId String?
  tireRequest   TireRequest? @relation(fields: [tireRequestId], references: [id])

  offerId String?
  offer   Offer?  @relation(fields: [offerId], references: [id])

  // Commission (in Cents)
  commissionAmount Int

  // Payment Status
  isPaid    Boolean           @default(false)
  paidAt    DateTime?
  paymentId String?
  payment   AffiliatePayment? @relation(fields: [paymentId], references: [id])

  // Timestamps
  convertedAt DateTime @default(now())

  @@index([influencerId])
  @@index([customerId])
  @@index([cookieId])
  @@index([convertedAt])
  @@index([isPaid])
  @@map("affiliate_conversions")
}

model AffiliatePayment {
  id           String     @id @default(cuid())
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  // Payment Period
  periodStart DateTime
  periodEnd   DateTime

  // Amounts (in Cents)
  totalAmount         Int
  clicksAmount        Int
  registrationsAmount Int
  offersAmount        Int

  // Counts
  totalClicks        Int
  totalRegistrations Int
  totalOffers        Int

  // Status
  status PaymentStatus @default(PENDING)

  // Payment Details
  paymentMethod    PaymentMethod
  paymentReference String? // z.B. PayPal Transaction ID oder Überweisung Referenz

  // Timestamps
  createdAt DateTime  @default(now())
  paidAt    DateTime?

  // Relations
  conversions AffiliateConversion[]

  @@index([influencerId])
  @@index([periodStart, periodEnd])
  @@index([status])
  @@map("affiliate_payments")
}

enum InfluencerPlatform {
  TIKTOK
  INSTAGRAM
  YOUTUBE
  FACEBOOK
  TWITTER
  LINKEDIN
  BLOG
  WEBSITE
  OTHER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ConversionType {
  PAGE_VIEW // Pro 1000 Views
  REGISTRATION // User registered
  ACCEPTED_OFFER // First offer accepted
  WORKSHOP_REGISTRATION // Workshop registration
  WORKSHOP_OFFER // Workshop offer
}

enum PaymentMethod {
  BANK_TRANSFER
  PAYPAL
}

enum TaxType {
  INDIVIDUAL // Privatperson
  BUSINESS // Unternehmen
}

enum PaymentStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}
