<!DOCTYPE html>
<html>
<head>
    <title>Test TURBOGA53 Tracking</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Affiliate Tracking Test - TURBOGA53</h1>
    
    <div class="test-box">
        <h2>Schritt 1: Cookie pr√ºfen</h2>
        <button onclick="checkCookies()">Cookies pr√ºfen</button>
        <div id="cookie-result"></div>
    </div>

    <div class="test-box">
        <h2>Schritt 2: Cookie manuell setzen</h2>
        <button onclick="setCookie()">Cookie setzen (b24_affiliate_ref=TURBOGA53)</button>
        <div id="set-cookie-result"></div>
    </div>

    <div class="test-box">
        <h2>Schritt 3: Tracking API testen</h2>
        <button onclick="testTracking()">Tracking testen</button>
        <div id="tracking-result"></div>
    </div>

    <div class="test-box">
        <h2>Schritt 4: Registrierung simulieren</h2>
        <p class="info status">
            ‚ö†Ô∏è Dieser Test zeigt nur, ob der Cookie richtig gelesen wird. 
            F√ºr eine echte Registrierung gehen Sie zu: <a href="/register/customer">/register/customer</a>
        </p>
        <button onclick="checkRegistrationFlow()">Registrierungs-Flow pr√ºfen</button>
        <div id="registration-result"></div>
    </div>

    <div class="test-box">
        <h2>Schritt 5: Influencer-Login pr√ºfen</h2>
        <p class="info status">
            Das Dashboard-Problem kommt daher, dass Sie nicht eingeloggt sind.
        </p>
        <button onclick="window.location.href='/influencer/login'">Zum Influencer-Login</button>
    </div>

    <script>
        function checkCookies() {
            const result = document.getElementById('cookie-result');
            const cookies = document.cookie.split('; ');
            const affiliateRef = cookies.find(c => c.startsWith('b24_affiliate_ref='));
            const cookieId = cookies.find(c => c.startsWith('b24_cookie_id='));
            
            let html = '<div style="margin-top: 15px;">';
            
            if (affiliateRef) {
                html += `<div class="status success">‚úÖ Affiliate Cookie gefunden: <code>${affiliateRef}</code></div>`;
            } else {
                html += `<div class="status error">‚ùå Affiliate Cookie NICHT gefunden!</div>`;
            }
            
            if (cookieId) {
                html += `<div class="status success">‚úÖ Cookie ID gefunden: <code>${cookieId}</code></div>`;
            } else {
                html += `<div class="status info">‚ÑπÔ∏è Cookie ID nicht gefunden (wird beim ersten Tracking gesetzt)</div>`;
            }
            
            if (!affiliateRef) {
                html += `<div class="status info">üí° Tipp: Besuchen Sie die Seite mit <code>?ref=TURBOGA53</code> Parameter</div>`;
            }
            
            html += '</div>';
            result.innerHTML = html;
        }

        function setCookie() {
            const result = document.getElementById('set-cookie-result');
            
            // Set affiliate ref cookie
            document.cookie = `b24_affiliate_ref=TURBOGA53; path=/; max-age=${30 * 24 * 60 * 60}`;
            
            // Set cookie ID if not exists
            const existingId = document.cookie.split('; ').find(c => c.startsWith('b24_cookie_id='));
            if (!existingId) {
                const cookieId = Math.random().toString(36).substring(2) + Date.now().toString(36);
                document.cookie = `b24_cookie_id=${cookieId}; path=/; max-age=${30 * 24 * 60 * 60}`;
            }
            
            result.innerHTML = `
                <div class="status success" style="margin-top: 15px;">
                    ‚úÖ Cookies gesetzt!<br>
                    <small>Cookie l√§uft ab in: 30 Tagen</small>
                </div>
            `;
        }

        async function testTracking() {
            const result = document.getElementById('tracking-result');
            result.innerHTML = '<div class="status info">‚è≥ Teste Tracking API...</div>';
            
            const cookieId = 'test-' + Math.random().toString(36).substring(7);
            
            try {
                const response = await fetch(`/api/affiliate/track?ref=TURBOGA53&cookieId=${cookieId}`);
                const data = await response.json();
                
                let html = '<div style="margin-top: 15px;">';
                html += `<div><strong>HTTP Status:</strong> ${response.status}</div>`;
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                if (response.status === 200 && data.status === 'tracked') {
                    html += '<div class="status success">‚úÖ Tracking funktioniert! Click und PAGE_VIEW wurden erstellt.</div>';
                } else if (response.status === 404) {
                    html += '<div class="status error">‚ùå Influencer TURBOGA53 existiert nicht in der Datenbank!</div>';
                    html += '<div class="status info">üí° F√ºhren Sie aus: <code>node create-turboga53-influencer.mjs</code></div>';
                } else if (response.status === 403) {
                    html += '<div class="status error">‚ùå Influencer ist inaktiv oder abgelaufen!</div>';
                    html += '<div class="status info">üí° Pr√ºfen Sie in Prisma Studio: <code>npx prisma studio</code></div>';
                } else if (data.status === 'duplicate') {
                    html += '<div class="status info">‚ÑπÔ∏è Duplicate Click (bereits innerhalb 24h getrackt)</div>';
                } else {
                    html += '<div class="status error">‚ùå Unerwarteter Fehler</div>';
                }
                
                html += '</div>';
                result.innerHTML = html;
                
            } catch (error) {
                result.innerHTML = `
                    <div class="status error" style="margin-top: 15px;">
                        ‚ùå Fehler beim Testen:<br>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }

        async function checkRegistrationFlow() {
            const result = document.getElementById('registration-result');
            
            const cookies = document.cookie.split('; ');
            const affiliateRef = cookies.find(c => c.startsWith('b24_affiliate_ref='));
            
            let html = '<div style="margin-top: 15px;">';
            
            if (affiliateRef) {
                const refValue = affiliateRef.split('=')[1];
                html += `<div class="status success">‚úÖ Cookie ist gesetzt: <code>${affiliateRef}</code></div>`;
                html += `<div class="status success">‚úÖ Bei Registrierung wird dieser Code verwendet: <strong>${refValue}</strong></div>`;
                html += `<div class="status info">
                    üí° <strong>N√§chster Schritt:</strong><br>
                    1. Gehen Sie zu <a href="/register/customer">/register/customer</a><br>
                    2. Registrieren Sie einen neuen Kunden<br>
                    3. Eine REGISTRATION Conversion wird automatisch erstellt<br>
                    4. Pr√ºfen Sie danach im Influencer-Dashboard die Stats
                </div>`;
            } else {
                html += `<div class="status error">‚ùå Kein Affiliate Cookie gesetzt!</div>`;
                html += `<div class="status info">üí° Klicken Sie oben auf "Cookie setzen" oder besuchen Sie die Seite mit <code>?ref=TURBOGA53</code></div>`;
            }
            
            html += '</div>';
            result.innerHTML = html;
        }

        // Auto-check on load
        window.addEventListener('load', () => {
            checkCookies();
        });
    </script>

    <div class="test-box">
        <h2>üìã Zusammenfassung</h2>
        <div class="status info">
            <h3>Das Problem mit dem 500-Fehler:</h3>
            <p>Der Fehler bei <code>/api/influencer/stats</code> kommt daher, dass Sie nicht als Influencer eingeloggt sind.</p>
            <p>Das Tracking selbst (Clicks und Registrierungen) funktioniert aber trotzdem!</p>
            
            <h3>So funktioniert das System:</h3>
            <ol>
                <li>Besucher kommt √ºber <code>?ref=TURBOGA53</code> ‚Üí Cookie wird gesetzt</li>
                <li>Click wird getrackt (AffiliateClick + PAGE_VIEW Conversion)</li>
                <li>Besucher registriert sich ‚Üí REGISTRATION Conversion wird erstellt</li>
                <li><strong>Influencer loggt sich separat ein</strong> ‚Üí Sieht Stats im Dashboard</li>
            </ol>
            
            <h3>Test-Ablauf:</h3>
            <ol>
                <li>‚úÖ Cookie pr√ºfen/setzen (oben)</li>
                <li>‚úÖ Tracking API testen (oben)</li>
                <li>‚úÖ Registrierung durchf√ºhren</li>
                <li>‚úÖ Als Influencer einloggen unter <a href="/influencer/login">/influencer/login</a></li>
                <li>‚úÖ Dashboard pr√ºfen unter <a href="/influencer/dashboard">/influencer/dashboard</a></li>
            </ol>
        </div>
    </div>
</body>
</html>
