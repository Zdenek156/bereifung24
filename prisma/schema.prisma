// This is your Prisma schema file
// Bereifung24 Platform - Kunden-Werkstatt-Vermittlung
// PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ADMIN NOTIFICATIONS
// ============================================

model AdminNotificationSetting {
  id                        String   @id @default(cuid())
  email                     String   @unique
  name                      String?
  
  // Notification Types
  notifyCustomerRegistration Boolean  @default(true)  // Benachrichtigung bei Kunden-Registrierung
  notifyWorkshopRegistration Boolean  @default(true)  // Benachrichtigung bei Werkstatt-Registrierung
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@map("admin_notification_settings")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  role          String   @default("CUSTOMER") // CUSTOMER, WORKSHOP, ADMIN
  
  // Profile
  firstName     String
  lastName      String
  phone         String?
  street        String?
  zipCode       String?
  city          String?
  latitude      Float?
  longitude     Float?
  
  // Customer Type (for billing)
  customerType  String?   @default("PRIVATE") // PRIVATE, BUSINESS
  companyName   String?
  taxId         String?   // Steuernummer/USt-IdNr for business customers
  
  // Verification
  emailVerified DateTime?
  isActive      Boolean   @default(true)
  
  // OAuth
  googleId      String?   @unique
  
  // Password Reset
  resetToken        String?
  resetTokenExpiry  DateTime?
  
  // Email Verification
  verificationToken String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations based on role
  customer      Customer?
  workshop      Workshop?
  
  @@map("users")
}

// ============================================
// CUSTOMER
// ============================================

model Customer {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Email Notifications
  emailNotifyOffers Boolean  @default(true) // Benachrichtigung bei neuen Angeboten
  
  // Relations
  tireRequests    TireRequest[]
  bookings        Booking[]
  reviews         Review[]
  tireRatings     TireRating[]
  vehicles        Vehicle[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("customers")
}

// ============================================
// WORKSHOP
// ============================================

model Workshop {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Business Info
  companyName     String
  taxId           String?
  website         String?
  description     String?
  
  // Opening Hours (JSON String)
  openingHours    String? // JSON: {"monday": "09:00-18:00", ...}
  
  // Verification
  isVerified      Boolean   @default(false)
  verifiedAt      DateTime?
  
  // Banking (SEPA)
  iban            String?
  accountHolder   String?
  sepaMandateRef  String?   @unique // B24-timestamp-random
  sepaMandateDate DateTime?
  
  // PayPal
  paypalEmail     String?
  
  // Payment Methods (JSON String)
  paymentMethods  String? @map("paymentmethods") // JSON: {"cash": true, "bankTransfer": true, ...}
  
  // Email Notifications
  emailNotifyRequests Boolean  @default(true) // Benachrichtigung bei neuen Anfragen im Umkreis
  
  // Calendar Integration
  calendarMode         String?  @default("workshop") @map("calendarmode") // "workshop" or "employees"
  googleCalendarId     String?  @map("googlecalendarid") // For workshop mode
  googleAccessToken    String?  @map("googleaccesstoken")
  googleRefreshToken   String?  @map("googlerefreshtoken")
  googleTokenExpiry    DateTime? @map("googletokenexpiry")
  
  // Relations
  offers          Offer[]
  bookings        Booking[]
  reviews         Review[]
  commissions     Commission[]
  employees       Employee[]
  workshopVacations WorkshopVacation[]
  workshopServices WorkshopService[]
  pricingSettings PricingSettings?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("workshops")
}

model PricingSettings {
  id                    String    @id @default(cuid())
  workshopId            String    @unique @map("workshop_id")
  workshop              Workshop  @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  // Auto Reifen
  autoManualPricing     Boolean   @default(true) @map("auto_manual_pricing")
  autoFixedMarkup       Float     @default(0) @map("auto_fixed_markup")
  autoPercentMarkup     Float     @default(0) @map("auto_percent_markup")
  autoIncludeVat        Boolean   @default(false) @map("auto_include_vat")
  
  // Motorrad Reifen
  motoManualPricing     Boolean   @default(true) @map("moto_manual_pricing")
  motoFixedMarkup       Float     @default(0) @map("moto_fixed_markup")
  motoPercentMarkup     Float     @default(0) @map("moto_percent_markup")
  motoIncludeVat        Boolean   @default(false) @map("moto_include_vat")
  
  // Andere Services
  serviceManualPricing  Boolean   @default(true) @map("service_manual_pricing")
  serviceFixedMarkup    Float     @default(0) @map("service_fixed_markup")
  servicePercentMarkup  Float     @default(0) @map("service_percent_markup")
  serviceIncludeVat     Boolean   @default(false) @map("service_include_vat")
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  @@map("pricing_settings")
}

model Employee {
  id                   String    @id @default(cuid())
  workshopId           String
  workshop             Workshop  @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  name                 String
  email                String
  
  // Google Calendar Integration
  googleCalendarId     String?
  googleAccessToken    String?
  googleRefreshToken   String?
  googleTokenExpiry    DateTime?
  
  // Working Hours (JSON String)
  workingHours         String? // JSON: {"monday": {"from": "08:00", "to": "17:00", "working": true}, ...}
  
  // Relations
  bookings             Booking[]
  employeeVacations    EmployeeVacation[]
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  @@map("employees")
}

// ============================================
// TIRE REQUEST
// ============================================

model TireRequest {
  id                String   @id @default(cuid())
  customerId        String
  customer          Customer @relation(fields: [customerId], references: [id])
  vehicleId         String?
  vehicle           Vehicle? @relation(fields: [vehicleId], references: [id])
  
  // Tire Specifications
  season            String  // SUMMER, WINTER, ALL_SEASON
  width             Int
  aspectRatio       Int
  diameter          Int
  loadIndex         Int?
  speedRating       String?
  isRunflat         Boolean  @default(false)
  quantity          Int      @default(4)
  
  // Preferences
  preferredBrands   String? // Comma-separated brands
  specificBrand     String?
  additionalNotes   String?
  
  // Location
  zipCode           String
  city              String?
  radiusKm          Int      @default(25)
  latitude          Float?
  longitude         Float?
  
  // Timing
  needByDate        DateTime
  
  // Status
  status            String   @default("PENDING") // PENDING, QUOTED, ACCEPTED, COMPLETED, CANCELLED
  
  // Relations
  offers            Offer[]
  booking           Booking?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("tire_requests")
}

// ============================================
// VEHICLE MANAGEMENT
// ============================================

model Vehicle {
  id                String   @id @default(cuid())
  customerId        String
  customer          Customer @relation(fields: [customerId], references: [id])
  
  // Vehicle Details
  make              String
  model             String
  year              Int
  licensePlate      String?
  vin               String?   @unique
  
  // Current Tires
  currentTires      VehicleTire[]
  tireHistory       TireHistory[]
  tireRequests      TireRequest[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("vehicles")
}

model VehicleTire {
  id                String   @id @default(cuid())
  vehicleId         String
  vehicle           Vehicle  @relation(fields: [vehicleId], references: [id])
  
  // Tire Specs
  position          String   // FRONT_LEFT, FRONT_RIGHT, REAR_LEFT, REAR_RIGHT
  season            String   // SUMMER, WINTER, ALL_SEASON
  width             Int
  aspectRatio       Int
  diameter          Int
  loadIndex         Int?
  speedRating       String?
  brand             String?
  model             String?
  dotCode           String?  // Herstellungsdatum
  
  // Condition
  treadDepth        Float?
  installedDate     DateTime?
  estimatedReplacement DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("vehicle_tires")
}

model TireHistory {
  id                String   @id @default(cuid())
  vehicleId         String
  vehicle           Vehicle  @relation(fields: [vehicleId], references: [id])
  
  // What was installed
  season            String
  width             Int
  aspectRatio       Int
  diameter          Int
  brand             String?
  model             String?
  quantity          Int
  
  // When and where
  installedDate     DateTime
  workshopName      String?
  totalCost         Float?
  
  notes             String?
  
  createdAt         DateTime @default(now())
  
  @@map("tire_history")
}

// ============================================
// OFFER
// ============================================

model Offer {
  id                String        @id @default(cuid())
  tireRequestId     String
  tireRequest       TireRequest   @relation(fields: [tireRequestId], references: [id])
  workshopId        String
  workshop          Workshop      @relation(fields: [workshopId], references: [id])
  
  // Tire Details (for compatibility with existing offers)
  tireBrand         String
  tireModel         String
  description       String?
  
  // Multiple tire options (for new offers)
  tireOptions       TireOption[]
  
  // Pricing
  price             Float         // Total price (for compatibility)
  pricePerTire      Float?
  installationFee   Float?
  durationMinutes   Int?          // Geschätzte Dauer für den Service
  
  // Validity
  validUntil        DateTime
  
  // Status
  status            String        @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED
  
  // If accepted
  acceptedAt        DateTime?
  declinedAt        DateTime?     @map("declined_at")
  booking           Booking?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@map("offers")
}

model TireOption {
  id            String    @id @default(cuid())
  offerId       String    @map("offer_id")
  offer         Offer     @relation(fields: [offerId], references: [id], onDelete: Cascade)
  
  brand         String
  model         String
  pricePerTire  Float     @map("price_per_tire")
  
  bookings      Booking[]
  
  createdAt     DateTime  @default(now()) @map("created_at")
  
  @@map("tire_options")
}

// ============================================
// BOOKING & APPOINTMENT
// ============================================

model Booking {
  id                String      @id @default(cuid())
  tireRequestId     String      @unique
  tireRequest       TireRequest @relation(fields: [tireRequestId], references: [id])
  customerId        String
  customer          Customer    @relation(fields: [customerId], references: [id])
  workshopId        String
  workshop          Workshop    @relation(fields: [workshopId], references: [id])
  offerId           String      @unique
  offer             Offer       @relation(fields: [offerId], references: [id])
  selectedTireOptionId String?
  selectedTireOption   TireOption? @relation(fields: [selectedTireOptionId], references: [id])
  
  // Appointment
  appointmentDate   DateTime
  appointmentTime   String
  estimatedDuration Int         @default(60) // Minuten
  employeeId        String?
  employee          Employee?   @relation(fields: [employeeId], references: [id])
  googleEventId     String?     // Google Calendar Event ID
  
  // Status
  status            String      @default("CONFIRMED") // CONFIRMED, COMPLETED, CANCELLED, NO_SHOW
  
  // Payment
  paymentMethod     String?     // PAYPAL, BANK_TRANSFER, CREDIT_CARD, ON_SITE
  paymentStatus     String      @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  paidAt            DateTime?
  
  // Notes
  customerNotes     String?
  workshopNotes     String?
  
  // After completion
  completedAt       DateTime?
  review            Review?
  tireRating        TireRating?
  commission        Commission?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("bookings")
}

// ============================================
// REVIEW & RATING
// ============================================

model Review {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  booking       Booking  @relation(fields: [bookingId], references: [id])
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  workshopId    String
  workshop      Workshop @relation(fields: [workshopId], references: [id])
  
  // Rating
  rating        Int      // 1-5 Sterne
  comment       String?
  
  // Response
  workshopResponse String?
  respondedAt      DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("reviews")
}

// ============================================
// TIRE RATING (Customer's personal tire notes)
// ============================================

model TireRating {
  id            String   @id @default(cuid())
  bookingId     String   @unique
  booking       Booking  @relation(fields: [bookingId], references: [id])
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  
  // Rating
  rating        Int      // 1-5 Sterne
  comment       String?  // Persönliche Notizen zu den Reifen
  
  // Categories (optional detailed ratings)
  quietnessRating     Int?  // 1-5: Lautstärke
  gripRating          Int?  // 1-5: Grip/Haftung
  wearRating          Int?  // 1-5: Verschleiß
  comfortRating       Int?  // 1-5: Komfort
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("tire_ratings")
}

// ============================================
// COMMISSION TRACKING
// ============================================

model Commission {
  id              String   @id @default(cuid())
  bookingId       String   @unique
  booking         Booking  @relation(fields: [bookingId], references: [id])
  workshopId      String
  workshop        Workshop @relation(fields: [workshopId], references: [id])
  
  // Amounts
  orderTotal      Float    // Gesamtbetrag des Auftrags
  commissionRate  Float    @default(5.0) // Prozentsatz (Standard 5%)
  commissionAmount Float   // Berechnete Provision
  
  // Status
  status          String   @default("PENDING") // PENDING, BILLED, COLLECTED, FAILED
  
  // Billing
  billedAt        DateTime?
  collectedAt     DateTime?
  
  // SEPA Details
  sepaReference   String?
  sepaStatus      String?
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("commissions")
}

// ============================================
// VACATION MANAGEMENT
// ============================================

model WorkshopVacation {
  id          String   @id @default(cuid())
  workshopId  String
  workshop    Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  startDate   DateTime
  endDate     DateTime
  reason      String?  // e.g., "Betriebsurlaub", "Feiertage", "Umbau"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("workshop_vacations")
}

model EmployeeVacation {
  id          String   @id @default(cuid())
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  startDate   DateTime
  endDate     DateTime
  reason      String?  // e.g., "Urlaub", "Krankheit", "Fortbildung"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("employee_vacations")
}

// ============================================
// WORKSHOP SERVICES
// ============================================

model WorkshopService {
  id                    String   @id @default(cuid())
  workshopId            String
  workshop              Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  
  // Service Type
  serviceType           String   // TIRE_CHANGE, WHEEL_CHANGE, TIRE_REPAIR, MOTORCYCLE_TIRE, ALIGNMENT_MEASUREMENT, ALIGNMENT_ADJUSTMENT, ALIGNMENT_BOTH
  
  // Pricing
  basePrice             Float    // Grundpreis (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE, sonst Gesamtpreis)
  basePrice4            Float?   // Preis für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)
  
  // Service-specific pricing
  runFlatSurcharge      Float?   @map("runFlat_surcharge") // Aufpreis für Runflat-Reifen (pro Reifen bei TIRE_CHANGE)
  disposalFee           Float?   @map("disposal_fee") // Entsorgungsgebühr (pro Reifen)
  wheelSizeSurcharge    Json?    @map("wheel_size_surcharge") // {"17": 5, "18": 10, "19": 15} - Aufpreis nach Radgröße
  balancingPrice        Float?   @map("balancingprice") // Wuchten-Preis (pro Rad bei WHEEL_CHANGE)
  storagePrice          Float?   @map("storageprice") // Einlagerungspreis (pro Saison bei WHEEL_CHANGE) - Optional
  
  // Duration
  durationMinutes       Int      @map("duration_minutes") // Dauer in Minuten (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE)
  durationMinutes4      Int?     @map("duration_minutes_4") // Dauer für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)
  balancingMinutes      Int?     @map("balancingminutes") // Zusätzliche Dauer für Wuchten (pro Rad bei WHEEL_CHANGE)
  storageAvailable      Boolean? @default(false) @map("storageavailable") // Einlagerung verfügbar
  
  // Availability
  isActive              Boolean  @default(true)
  
  // Notes
  description           String?  // Beschreibung des Services
  internalNotes         String?  // Interne Notizen
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([workshopId, serviceType])
  @@map("workshop_services")
}

// ============================================
// ADMIN LOGS
// ============================================

model AdminLog {
  id          String   @id @default(cuid())
  adminEmail  String
  action      String
  details     String?
  
  createdAt   DateTime @default(now())
  
  @@map("admin_logs")
}
