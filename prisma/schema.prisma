// This is your Prisma schema file
// Bereifung24 Platform - Kunden-Werkstatt-Vermittlung
// PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ADMIN NOTIFICATIONS
// ============================================

model AdminNotificationSetting {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?

  // Notification Types
  notifyCustomerRegistration  Boolean @default(true) // Benachrichtigung bei Kunden-Registrierung
  notifyWorkshopRegistration  Boolean @default(true) // Benachrichtigung bei Werkstatt-Registrierung
  notifyInfluencerApplication Boolean @default(false) // Benachrichtigung bei Influencer-Bewerbung

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_notification_settings")
}

// ============================================
// ADMIN API SETTINGS
// ============================================

model AdminApiSetting {
  id          String  @id @default(cuid())
  key         String  @unique // e.g., "GOCARDLESS_ACCESS_TOKEN", "GOOGLE_OAUTH_CLIENT_ID"
  value       String? // The actual API key/secret (encrypted in production)
  description String? // What this key is for

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_api_settings")
}

// ============================================
// EMAIL TEMPLATES
// ============================================

model EmailTemplate {
  id          String  @id @default(cuid())
  key         String  @unique // e.g., "BOOKING_CONFIRMATION_CUSTOMER", "BOOKING_CONFIRMATION_WORKSHOP"
  name        String // Display name: "Terminbestätigung - Kunde"
  description String? // What this template is used for
  subject     String // Email subject line with placeholders
  htmlContent String  @db.Text // HTML email content with placeholders

  // Placeholders documentation (JSON array of available placeholders)
  placeholders String @db.Text // JSON: [{"key": "customerName", "description": "Name des Kunden"}]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String
  role     String @default("CUSTOMER") // CUSTOMER, WORKSHOP, ADMIN

  // Profile
  firstName String
  lastName  String
  phone     String?
  street    String?
  zipCode   String?
  city      String?
  latitude  Float?
  longitude Float?

  // Customer Type (for billing)
  customerType String? @default("PRIVATE") // PRIVATE, BUSINESS
  companyName  String?
  taxId        String? // Steuernummer/USt-IdNr for business customers

  // Verification
  emailVerified DateTime?
  isActive      Boolean   @default(true)

  // OAuth
  googleId String? @unique

  // Password Reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Email Verification
  verificationToken String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations based on role
  customer Customer?
  workshop Workshop?

  // Email System Relations
  emailSettings  EmailSettings?
  emailSignature EmailSignature?
  emailMessages  EmailMessage[]

  // Procurement Relations
  suppliersCreated    Supplier[]           @relation
  procurementRequests ProcurementRequest[] @relation
  approvedRequests    ProcurementRequest[] @relation("ApprovedRequests")
  purchaseOrders      PurchaseOrder[]      @relation
  receivedOrders      PurchaseOrder[]      @relation("ReceivedOrders")
  createdAssets       Asset[]              @relation("CreatedAssets")
  assignedAssets      Asset[]              @relation
  investmentPlans     InvestmentPlan[]

  // Buchhaltung Relations
  createdAccountingEntries AccountingEntry[]    @relation("AccountingEntryCreator")
  lockedAccountingEntries  AccountingEntry[]    @relation("AccountingEntryLocker")
  accountingAuditLogs      AccountingAuditLog[] @relation("AccountingAuditor")
  bookingTemplates         BookingTemplate[]    @relation("BookingTemplateCreator")

  @@map("users")
}

// ============================================
// CUSTOMER
// ============================================

model Customer {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email Notifications
  emailNotifyOffers Boolean @default(true) // Benachrichtigung bei neuen Angeboten

  // Relations
  tireRequests         TireRequest[]
  bookings             Booking[]
  reviews              Review[]
  tireRatings          TireRating[]
  vehicles             Vehicle[]
  weatherAlert         WeatherAlert?
  affiliateConversions AffiliateConversion[] // Tracking von Affiliate-Conversions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

// ============================================
// WEATHER ALERT (Tire Change Reminder)
// ============================================

model WeatherAlert {
  id         String   @id @default(cuid())
  customerId String   @unique
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Settings
  isEnabled            Boolean @default(false) // Ob Benachrichtigungen aktiviert sind
  temperatureThreshold Int     @default(7) // Temperatur-Schwelle in °C (z.B. 7°C)
  daysInAdvance        Int     @default(3) // Wie viele Tage im Voraus benachrichtigen (1-7)
  showOnDashboard      Boolean @default(true) // Widget auf Dashboard anzeigen

  // Season Tracking
  lastAlertSeason String? // WINTER_2024, SUMMER_2024 - verhindert doppelte Benachrichtigung
  lastAlertDate   DateTime?

  // Location (falls abweichend von User-Adresse)
  useCustomLocation Boolean @default(false)
  customZipCode     String?
  customCity        String?
  customLatitude    Float?
  customLongitude   Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("weather_alerts")
}

// ============================================
// WORKSHOP
// ============================================

model Workshop {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business Info
  customerNumber String  @unique @map("customer_number") // Eindeutige Kundennummer (z.B. KD-20231219-001)
  companyName    String
  taxId          String?
  website        String?
  description    String?
  logoUrl        String? // Workshop Logo URL
  taxMode        String  @default("STANDARD") // STANDARD (inkl. MwSt.), KLEINUNTERNEHMER (§19 UStG)

  // Opening Hours (JSON String)
  openingHours String? // JSON: {"monday": "09:00-18:00", ...}

  // Verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Banking (SEPA)
  iban            String?
  accountHolder   String?
  sepaMandateRef  String?   @unique // B24-timestamp-random
  sepaMandateDate DateTime?

  // PayPal
  paypalEmail String?

  // GoCardless Integration
  gocardlessCustomerId       String?   @unique // GoCardless Customer ID
  gocardlessMandateId        String?   @unique // GoCardless Mandate ID
  gocardlessMandateStatus    String? // pending_submission, submitted, active, cancelled, failed, expired
  gocardlessMandateRef       String?   @unique // Eindeutige Mandate Reference
  gocardlessMandateCreatedAt DateTime?
  gocardlessBankAccountId    String? // GoCardless Bank Account ID
  gocardlessSessionToken     String?   @map("gocardless_session_token") // Temporary session token for redirect flow
  gocardlessRedirectFlowId   String?   @map("gocardless_redirect_flow_id") // Temporary redirect flow ID

  // Payment Methods (JSON String)
  paymentMethods String? @map("paymentmethods") // JSON: {"cash": true, "bankTransfer": true, ...}

  // Email Notifications
  emailNotifyRequests      Boolean @default(true) @map("email_notify_requests") // Benachrichtigung bei neuen Anfragen im Umkreis
  emailNotifyOfferAccepted Boolean @default(true) @map("email_notify_offer_accepted") // Benachrichtigung wenn Angebot angenommen wurde
  emailNotifyBookings      Boolean @default(true) @map("email_notify_bookings") // Benachrichtigung bei neuen Terminbuchungen
  emailNotifyReviews       Boolean @default(true) @map("email_notify_reviews") // Benachrichtigung bei neuen Bewertungen
  emailNotifyReminders     Boolean @default(true) @map("email_notify_reminders") // Terminserinnerungen
  emailNotifyCommissions   Boolean @default(true) @map("email_notify_commissions") // Monatliche Provisionsabrechnungen

  // Calendar Integration
  calendarMode       String?   @default("workshop") @map("calendarmode") // "workshop" or "employees"
  googleCalendarId   String?   @map("googlecalendarid") // For workshop mode
  googleAccessToken  String?   @map("googleaccesstoken")
  googleRefreshToken String?   @map("googlerefreshtoken")
  googleTokenExpiry  DateTime? @map("googletokenexpiry")

  // Bereifung24 Employee Assignment
  assignedEmployeeId String?      @map("assigned_employee_id")
  assignedEmployee   B24Employee? @relation("WorkshopAssignment", fields: [assignedEmployeeId], references: [id])

  // Relations
  offers               Offer[]
  bookings             Booking[]
  reviews              Review[]
  commissions          Commission[]
  commissionInvoices   CommissionInvoice[] @relation("WorkshopInvoices")
  employees            Employee[]
  workshopVacations    WorkshopVacation[]
  workshopServices     WorkshopService[]
  pricingSettings      PricingSettings?
  landingPage          WorkshopLandingPage?
  affiliateConversions AffiliateConversion[]
  crmData              WorkshopCRM?

  // Sales CRM - Converted from Prospect
  prospectSource ProspectWorkshop? @relation("ConvertedFromProspect")

  // Track viewed tire requests
  viewedRequests TireRequestView[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workshops")
}

model PricingSettings {
  id         String   @id @default(cuid())
  workshopId String   @unique @map("workshop_id")
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Auto Reifen
  autoManualPricing Boolean @default(true) @map("auto_manual_pricing")
  autoFixedMarkup   Float   @default(0) @map("auto_fixed_markup")
  autoPercentMarkup Float   @default(0) @map("auto_percent_markup")
  autoIncludeVat    Boolean @default(false) @map("auto_include_vat")

  // Motorrad Reifen
  motoManualPricing Boolean @default(true) @map("moto_manual_pricing")
  motoFixedMarkup   Float   @default(0) @map("moto_fixed_markup")
  motoPercentMarkup Float   @default(0) @map("moto_percent_markup")
  motoIncludeVat    Boolean @default(false) @map("moto_include_vat")

  // Batterie-Service
  batteryManualPricing Boolean @default(true) @map("battery_manual_pricing")
  batteryFixedMarkup   Float   @default(0) @map("battery_fixed_markup")
  batteryPercentMarkup Float   @default(0) @map("battery_percent_markup")
  batteryIncludeVat    Boolean @default(false) @map("battery_include_vat")

  // Bremsen-Service
  brakeManualPricing Boolean @default(true) @map("brake_manual_pricing")
  brakeFixedMarkup   Float   @default(0) @map("brake_fixed_markup")
  brakePercentMarkup Float   @default(0) @map("brake_percent_markup")
  brakeIncludeVat    Boolean @default(false) @map("brake_include_vat")

  // Andere Services
  serviceManualPricing Boolean @default(true) @map("service_manual_pricing")
  serviceFixedMarkup   Float   @default(0) @map("service_fixed_markup")
  servicePercentMarkup Float   @default(0) @map("service_percent_markup")
  serviceIncludeVat    Boolean @default(false) @map("service_include_vat")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("pricing_settings")
}

model Employee {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  name  String
  email String

  // Google Calendar Integration
  googleCalendarId   String?
  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?

  // Working Hours (JSON String)
  workingHours String? // JSON: {"monday": {"from": "08:00", "to": "17:00", "working": true}, ...}

  // Relations
  bookings          Booking[]
  employeeVacations EmployeeVacation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employees")
}

// ============================================
// TIRE REQUEST
// ============================================

model TireRequest {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  vehicleId  String?
  vehicle    Vehicle? @relation(fields: [vehicleId], references: [id])

  // Tire Specifications
  season      String // SUMMER, WINTER, ALL_SEASON
  width       Int
  aspectRatio Int
  diameter    Int
  loadIndex   Int?
  speedRating String?
  isRunflat   Boolean @default(false)
  quantity    Int     @default(4)

  // Preferences
  preferredBrands String? // Comma-separated brands
  specificBrand   String?
  additionalNotes String?

  // Motorcycle specific
  mountOnMotorcycle Boolean @default(false) @map("mount_on_motorcycle") // For motorcycle tire requests: true = mount on whole motorcycle, false = wheels only (default)

  // Location
  zipCode   String
  city      String?
  radiusKm  Int     @default(25)
  latitude  Float?
  longitude Float?

  // Timing
  needByDate DateTime

  // Status
  status String @default("PENDING") // PENDING, QUOTED, ACCEPTED, COMPLETED, CANCELLED

  // CO2 Tracking
  savedCO2Grams     Int? // Gespeicherte CO₂-Menge in Gramm
  calculationMethod String? // 'STANDARD' oder 'PERSONAL'
  workshopsNotified Int? // Anzahl der Werkstätten, die die Anfrage erhalten haben (für CO2-Berechnung verwendet)

  // Relations
  offers               Offer[]
  booking              Booking?
  affiliateConversions AffiliateConversion[] // Tracking von Affiliate-Conversions
  viewedByWorkshops    TireRequestView[] // Track which workshops have viewed this request

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tire_requests")
}

// Track when a workshop views a tire request (for "New" filter)
model TireRequestView {
  id            String      @id @default(cuid())
  tireRequestId String      @map("tire_request_id")
  tireRequest   TireRequest @relation(fields: [tireRequestId], references: [id], onDelete: Cascade)
  workshopId    String      @map("workshop_id")
  workshop      Workshop    @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  viewedAt      DateTime    @default(now()) @map("viewed_at")

  @@unique([tireRequestId, workshopId])
  @@map("tire_request_views")
}

// ============================================
// VEHICLE MANAGEMENT
// ============================================

model Vehicle {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Vehicle Details
  vehicleType  String  @default("CAR") // CAR, MOTORCYCLE, TRAILER
  make         String
  model        String
  year         Int
  licensePlate String?
  vin          String? @unique

  // TÜV (Technical Inspection)
  nextInspectionDate     DateTime?
  inspectionReminder     Boolean   @default(false)
  inspectionReminderDays Int?      @default(30) // Days before inspection to send reminder

  // Tire Sizes (stored as JSON)
  summerTires    String? // JSON string with tire dimensions
  winterTires    String? // JSON string with tire dimensions
  allSeasonTires String? // JSON string with tire dimensions

  // Fuel & Consumption (for CO2 calculation)
  fuelType            FuelType @default(UNKNOWN)
  fuelConsumption     Float? // L/100km für Verbrenner
  electricConsumption Float? // kWh/100km für E-Autos

  // Current Tires
  currentTires VehicleTire[]
  tireHistory  TireHistory[]
  tireRequests TireRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vehicles")
}

model VehicleTire {
  id        String  @id @default(cuid())
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  // Tire Specs
  position    String // FRONT_LEFT, FRONT_RIGHT, REAR_LEFT, REAR_RIGHT
  season      String // SUMMER, WINTER, ALL_SEASON
  width       Int
  aspectRatio Int
  diameter    Int
  loadIndex   Int?
  speedRating String?
  brand       String?
  model       String?
  dotCode     String? // Herstellungsdatum

  // Condition
  treadDepth           Float?
  installedDate        DateTime?
  estimatedReplacement DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vehicle_tires")
}

model TireHistory {
  id        String  @id @default(cuid())
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  // What was installed
  season      String
  width       Int
  aspectRatio Int
  diameter    Int
  brand       String?
  model       String?
  quantity    Int

  // When and where
  installedDate DateTime
  workshopName  String?
  totalCost     Float?

  notes String?

  createdAt DateTime @default(now())

  @@map("tire_history")
}

// ============================================
// OFFER
// ============================================

model Offer {
  id            String      @id @default(cuid())
  tireRequestId String
  tireRequest   TireRequest @relation(fields: [tireRequestId], references: [id])
  workshopId    String
  workshop      Workshop    @relation(fields: [workshopId], references: [id])

  // Tire Details (for compatibility with existing offers)
  tireBrand   String
  tireModel   String
  description String?

  // Multiple tire options (for new offers)
  tireOptions TireOption[]

  // Pricing
  price              Float // Total price (for compatibility)
  pricePerTire       Float?
  installationFee    Float?
  durationMinutes    Int? // Geschätzte Dauer für den Service
  balancingPrice     Float?   @map("balancingprice") // Wuchten-Preis für Wheel Change
  storagePrice       Float?   @map("storageprice") // Einlagerung-Preis für Wheel Change
  storageAvailable   Boolean? @default(false) @map("storageavailable") // Einlagerung verfügbar
  motorcycleTireType String?  @map("motorcycle_tire_type") // FRONT, REAR, or BOTH for motorcycle offers

  // Distance
  distanceKm Float? @map("distance_km") // Distance from customer to workshop in kilometers

  // Validity
  validUntil DateTime

  // Status
  status String @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED

  // If accepted
  acceptedAt             DateTime?
  declinedAt             DateTime?             @map("declined_at")
  customerWantsBalancing Boolean?              @default(false) @map("customer_wants_balancing")
  customerWantsStorage   Boolean?              @default(false) @map("customer_wants_storage")
  selectedTireOptionIds  String[]              @default([]) @map("selected_tire_option_ids") // IDs der vom Kunden ausgewählten TireOptions
  booking                Booking?
  affiliateConversions   AffiliateConversion[] // Tracking von Affiliate-Conversions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("offers")
}

model TireOption {
  id      String @id @default(cuid())
  offerId String @map("offer_id")
  offer   Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)

  brand              String
  model              String
  pricePerTire       Float   @map("price_per_tire")
  montagePrice       Float?  @map("montage_price") // Montage price for service packages (Brake, Battery, etc.)
  motorcycleTireType String? @map("motorcycle_tire_type") // FRONT, REAR, or BOTH for motorcycle tire options
  carTireType        String? @map("car_tire_type") // ALL_FOUR, FRONT_TWO, or REAR_TWO for car tire options
  description        String? // Achsen-Info für Brake Service (z.B. "Vorderachse: Nur Bremsbeläge")

  bookings Booking[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("tire_options")
}

// ============================================
// BOOKING & APPOINTMENT
// ============================================

model Booking {
  id                   String      @id @default(cuid())
  tireRequestId        String      @unique
  tireRequest          TireRequest @relation(fields: [tireRequestId], references: [id])
  customerId           String
  customer             Customer    @relation(fields: [customerId], references: [id])
  workshopId           String
  workshop             Workshop    @relation(fields: [workshopId], references: [id])
  offerId              String      @unique
  offer                Offer       @relation(fields: [offerId], references: [id])
  selectedTireOptionId String?
  selectedTireOption   TireOption? @relation(fields: [selectedTireOptionId], references: [id])

  // Appointment
  appointmentDate   DateTime
  appointmentTime   String
  estimatedDuration Int       @default(60) // Minuten
  employeeId        String?
  employee          Employee? @relation(fields: [employeeId], references: [id])
  googleEventId     String? // Google Calendar Event ID

  // Status
  status String @default("CONFIRMED") // CONFIRMED, COMPLETED, CANCELLED, NO_SHOW

  // Payment
  paymentMethod String? // PAYPAL, BANK_TRANSFER, CREDIT_CARD, ON_SITE
  paymentStatus String    @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  paidAt        DateTime?

  // Notes
  customerNotes String?
  workshopNotes String?

  // Optional services (for wheel change)
  wantsBalancing Boolean? @default(false) @map("wantsbalancing")
  wantsStorage   Boolean? @default(false) @map("wantsstorage")

  // After completion
  completedAt DateTime?
  review      Review?
  tireRating  TireRating?
  commission  Commission?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bookings")
}

// ============================================
// REVIEW & RATING
// ============================================

model Review {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id])

  // Rating
  rating  Int // 1-5 Sterne
  comment String?

  // Response
  workshopResponse String?
  respondedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}

// ============================================
// TIRE RATING (Customer's personal tire notes)
// ============================================

model TireRating {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Rating
  rating  Int // 1-5 Sterne
  comment String? // Persönliche Notizen zu den Reifen

  // Categories (optional detailed ratings)
  quietnessRating Int? // 1-5: Lautstärke
  gripRating      Int? // 1-5: Grip/Haftung
  wearRating      Int? // 1-5: Verschleiß
  comfortRating   Int? // 1-5: Komfort

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tire_ratings")
}

// ============================================
// COMMISSION TRACKING
// ============================================

model Commission {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id])

  // Amounts (Netto-Rechnung)
  orderTotal       Float // Gesamtbetrag des Auftrags (Brutto)
  commissionRate   Float @default(4.9) // Prozentsatz (4,9%)
  commissionAmount Float // Berechnete Provision (Brutto)

  // Tax Calculation (für Rechnung)
  taxRate     Float  @default(19.0) // MwSt-Satz (19%)
  taxAmount   Float? // MwSt-Betrag auf Provision
  netAmount   Float? // Provision Netto (ohne MwSt)
  grossAmount Float? // Provision Brutto (= commissionAmount)

  // Billing Period
  billingPeriodStart DateTime? // Start des Abrechnungszeitraums
  billingPeriodEnd   DateTime? // Ende des Abrechnungszeitraums
  billingMonth       Int? // Monat der Abrechnung (1-12)
  billingYear        Int? // Jahr der Abrechnung

  // Status
  status String @default("PENDING") // PENDING, BILLED, COLLECTED, FAILED, REFUNDED

  // Billing
  billedAt    DateTime?
  collectedAt DateTime?
  failedAt    DateTime? @map("failedat")

  // SEPA/GoCardless Details
  sepaReference String? // Legacy SEPA Referenz
  sepaStatus    String? // Legacy SEPA Status

  // GoCardless Integration
  gocardlessPaymentId     String?   @unique // GoCardless Payment ID
  gocardlessPaymentStatus String? // pending_submission, submitted, confirmed, paid_out, failed, cancelled
  gocardlessChargeDate    DateTime? // Geplantes Abbuchungsdatum
  gocardlessPayoutId      String? // GoCardless Payout ID (wenn ausgezahlt)

  // Invoice/Document
  invoiceNumber String?   @unique // Rechnungsnummer (z.B. RE-2024-001)
  invoiceUrl    String? // Link zur generierten PDF-Rechnung
  invoiceSentAt DateTime? // Wann wurde Rechnung versendet

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workshopId, status])
  @@index([billingMonth, billingYear])
  @@index([gocardlessPaymentId])
  @@map("commissions")
}

// ============================================
// VACATION MANAGEMENT
// ============================================

model WorkshopVacation {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String? // e.g., "Betriebsurlaub", "Feiertage", "Umbau"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workshop_vacations")
}

model EmployeeVacation {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String? // e.g., "Urlaub", "Krankheit", "Fortbildung"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employee_vacations")
}

// ============================================
// WORKSHOP SERVICES
// ============================================

model WorkshopService {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Service Type
  serviceType String // TIRE_CHANGE, WHEEL_CHANGE, TIRE_REPAIR, MOTORCYCLE_TIRE, ALIGNMENT_BOTH, CLIMATE_SERVICE, BRAKE_SERVICE, BATTERY_SERVICE, OTHER_SERVICES

  // Pricing
  basePrice  Float // Grundpreis (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE, sonst Gesamtpreis)
  basePrice4 Float? // Preis für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)

  // Service-specific pricing
  runFlatSurcharge         Float? // Aufpreis für Runflat-Reifen (pro Reifen bei TIRE_CHANGE)
  disposalFee              Float? // Entsorgungsgebühr (pro Reifen)
  wheelSizeSurcharge       Json? // {"17": 5, "18": 10, "19": 15} - Aufpreis nach Radgröße
  balancingPrice           Float? @map("balancingprice") // Wuchten-Preis (pro Rad bei WHEEL_CHANGE)
  storagePrice             Float? @map("storageprice") // Einlagerungspreis (pro Saison bei WHEEL_CHANGE) - Optional
  refrigerantPricePer100ml Float? // Preis pro 100ml Kältemittel (nur bei CLIMATE_SERVICE)

  // Duration
  durationMinutes  Int // Dauer in Minuten (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE)
  durationMinutes4 Int? // Dauer für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)
  balancingMinutes Int?     @map("balancingminutes") // Zusätzliche Dauer für Wuchten (pro Rad bei WHEEL_CHANGE)
  storageAvailable Boolean? @default(false) @map("storageavailable") // Einlagerung verfügbar

  // Service Packages (JSON structure for service-specific options - DEPRECATED, use ServicePackage relation instead)
  packages Json? // Legacy field - use servicePackages relation for new implementations

  // Availability
  isActive Boolean @default(true)

  // Notes
  description   String? // Beschreibung des Services
  internalNotes String? // Interne Notizen

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servicePackages ServicePackage[]

  @@unique([workshopId, serviceType])
  @@map("workshop_services")
}

// ============================================
// SERVICE PACKAGES (for granular package management)
// ============================================

model ServicePackage {
  id                String          @id @default(cuid())
  workshopServiceId String
  workshopService   WorkshopService @relation(fields: [workshopServiceId], references: [id], onDelete: Cascade)

  // Package Type (service-specific)
  // TIRE_CHANGE: two_tires, four_tires, two_tires_disposal, four_tires_disposal
  // WHEEL_CHANGE: basic, with_balancing, with_storage, complete
  // TIRE_REPAIR: small, large, emergency
  // MOTORCYCLE_TIRE: front, rear, both
  // ALIGNMENT_BOTH: measurement_only, with_adjustment, with_adjustment_inspection
  // CLIMATE_SERVICE: check, basic, comfort, premium
  // BRAKE_SERVICE: front_pads, front_pads_discs, rear_pads, rear_pads_discs, rear_pads_discs_handbrake
  // BATTERY_SERVICE: test, replacement, premium
  // OTHER_SERVICES: rdks, valve, storage, tpms
  packageType String

  // Package Details
  name        String // Display name (e.g., "Klimacheck", "2 Reifen wechseln")
  description String? // Package description

  // Pricing & Duration
  price           Float // Price for this package
  durationMinutes Int // Duration in minutes

  // Availability
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workshopServiceId, packageType])
  @@map("service_packages")
}

// ============================================
// WORKSHOP LANDING PAGES
// ============================================

model WorkshopLandingPage {
  id         String   @id @default(cuid())
  workshopId String   @unique
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Status & URL
  isActive Boolean @default(false)
  slug     String  @unique // URL slug (e.g., "autoservice-mueller-berlin")

  // SEO
  metaTitle       String? // Max 60 chars
  metaDescription String? @db.Text // Max 160 chars
  keywords        String? // Comma-separated keywords

  // Hero Section
  heroHeadline String? // Main headline
  heroSubline  String? // Subheadline
  heroImage    String? // Hero background image URL
  ctaText      String  @default("Jetzt Anfrage stellen") // CTA button text

  // About Section
  aboutTitle String?
  aboutText  String? @db.Text

  // Images
  galleryImages String[] // Array of image URLs

  // Team Section
  showTeam    Boolean @default(false)
  teamMembers Json? // [{name, role, image, bio}]

  // Services (custom or from workshop)
  useWorkshopServices Boolean @default(true) // Use workshop's services
  customServices      Json? // Custom service list if not using workshop services

  // Features
  showLogo         Boolean @default(true)
  showReviews      Boolean @default(true)
  showMap          Boolean @default(true)
  showOpeningHours Boolean @default(true)
  showPartnerLogos Boolean @default(false)

  // Partner/Brand Logos
  partnerLogos Json? // [{name, image}]

  // FAQ Section
  showFaq  Boolean @default(false)
  faqItems Json? // [{question, answer}]

  // Social Media
  socialLinks Json? // {facebook, instagram, youtube}

  // Design & Branding
  template     String @default("modern") // modern, classic, minimal, professional
  primaryColor String @default("#2563eb") // Brand color
  accentColor  String @default("#10b981") // Accent color

  // Analytics
  viewCount    Int       @default(0)
  lastViewedAt DateTime?

  // Tracking
  lastPublishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@map("workshop_landing_pages")
}

// ============================================
// BEREIFUNG24 EMPLOYEES (Staff/Mitarbeiter)
// ============================================

model B24Employee {
  id       String  @id @default(cuid())
  email    String  @unique
  password String? // Null until they set it via email link

  // Personal Info
  firstName    String
  lastName     String
  phone        String?
  position     String? // e.g., "Account Manager", "Buchhalter", "Marketing Manager"
  department   String? // e.g., "Buchhaltung", "Marketing", "Vertrieb", "Support"
  profileImage String? // URL to profile image

  // Status
  status        EmployeeStatus @default(DRAFT) // DRAFT (neu aus Bewerbung), ACTIVE, PROBATION, TERMINATED
  isActive      Boolean        @default(true)
  emailVerified Boolean        @default(false)

  // Password Setup
  setupToken       String?   @unique // Token for initial password setup
  setupTokenExpiry DateTime? // Token expires after 24h

  // Login tracking
  lastLoginAt DateTime?

  // Relations
  applications      B24EmployeeApplication[] // New: Application-based access
  assignedWorkshops Workshop[]                @relation("WorkshopAssignment")
  activityLogs      B24EmployeeActivityLog[]

  // Sales CRM Relations
  assignedProspects   ProspectWorkshop[]    @relation("AssignedProspects")
  createdInteractions ProspectInteraction[] @relation("InteractionCreator")
  assignedTasks       ProspectTask[]        @relation("AssignedTasks")
  createdTasks        ProspectTask[]        @relation("TaskCreator")
  createdNotes        ProspectNote[]        @relation("NoteCreator")

  // KVP Relations
  submittedImprovements ImprovementSuggestion[] @relation("ImprovementSubmitter")
  assignedImprovements  ImprovementSuggestion[] @relation("ImprovementAssignee")
  improvementComments   ImprovementComment[]

  // File Management Relations
  createdFolders FileFolder[]
  uploadedFiles  FileUpload[]

  // Employee Portal Relations
  profile           EmployeeProfile?
  documents         EmployeeDocument[] @relation("EmployeeDocuments")
  uploadedDocuments EmployeeDocument[] @relation("DocumentUploader")
  leaveBalance      LeaveBalance[]
  leaveRequests     LeaveRequest[]     @relation("EmployeeLeaveRequests")
  approvedLeaves    LeaveRequest[]     @relation("LeaveApprover")
  substituteFor     LeaveRequest[]     @relation("LeaveSubstitute")
  sickLeaves        SickLeave[]

  // Time Tracking Relations
  workSessions     WorkSession[]
  overtimeBalances OvertimeBalance[]

  // Vehicle & Trip Relations
  assignedVehicles CompanyVehicle[] // Reverse relation
  trips            TripEntry[]
  fuelReceipts     FuelReceipt[]
  reportedDamages  VehicleDamage[]

  // Spesen & Reisekosten Relations
  expenses               Expense[]       @relation("EmployeeExpenses")
  approvedExpenses       Expense[]       @relation("ApprovedExpenses")
  travelExpenses         TravelExpense[] @relation("EmployeeTravelExpenses")
  approvedTravelExpenses TravelExpense[] @relation("ApprovedTravelExpenses")

  // Phase 7: Communication & Organization Relations
  announcements           Announcement[]           @relation("AnnouncementAuthor")
  readAnnouncements       AnnouncementRead[]       @relation("ReadAnnouncements")
  employeeAssignedTasks   EmployeeTask[]           @relation("EmployeeAssignedTasks")
  employeeCreatedTasks    EmployeeTask[]           @relation("EmployeeCreatedTasks")
  employeeCompletedTasks  EmployeeTask[]           @relation("EmployeeCompletedTasks")
  employeeTaskComments    EmployeeTaskComment[]    @relation("EmployeeTaskComments")
  employeeTaskAttachments EmployeeTaskAttachment[] @relation("EmployeeTaskAttachments")
  knowledgeArticles       KnowledgeArticle[]       @relation("KnowledgeArticles")
  editedArticles          KnowledgeArticle[]       @relation("EditedArticles")

  // Email Settings
  emailSettings EmailSettings?
  emailMessages EmailMessage[]

  // ============================================
  // HR MANAGEMENT - HIERARCHIE
  // ============================================
  managerId      String?
  manager        B24Employee?  @relation("EmployeeHierarchy", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates   B24Employee[] @relation("EmployeeHierarchy")
  hierarchyLevel Int           @default(3) // 0=Geschäftsführung, 1=Manager, 2=Teamleiter, 3=Mitarbeiter

  // ============================================
  // HR MANAGEMENT - ARBEITSVERTRAG
  // ============================================
  employmentType  EmploymentType?
  workTimeModel   WorkTimeModel?
  weeklyHours     Float? // z.B. 40.0, 37.5, 20.0
  monthlyHours    Float? // Automatisch berechnet (weeklyHours × 52 ÷ 12)
  dailyHours      Float? // z.B. 8.0 bei 40h-Woche
  workDaysPerWeek Int? // z.B. 5 (Mo-Fr)

  // Arbeitszeiten
  workStartTime String? // z.B. "08:00"
  workEndTime   String? // z.B. "17:00"
  coreTimeStart String? // Kernarbeitszeit von (Gleitzeit)
  coreTimeEnd   String? // Kernarbeitszeit bis (Gleitzeit)
  flexTimeStart String? // Gleitzeit von (z.B. "07:00")
  flexTimeEnd   String? // Gleitzeit bis (z.B. "20:00")

  contractStart    DateTime?
  contractEnd      DateTime?
  probationEndDate DateTime?
  noticePeriod     String? // z.B. "4 Wochen zum Monatsende"

  // ============================================
  // HR MANAGEMENT - GEHALT & LOHN
  // ============================================
  salaryType    SalaryType?
  monthlySalary Decimal? // Bei Festgehalt
  annualSalary  Decimal? // Bei Jahresgehalt (÷ 12 = Monat)
  hourlyRate    Decimal? // Bei Stundenlohn

  // Minijob
  isMinijob     Boolean @default(false)
  miniJobExempt Boolean @default(false) // Von RV-Pflicht befreit

  // ============================================
  // HR MANAGEMENT - STEUER & SOZIALVERSICHERUNG
  // ============================================
  taxId                String? // Steuer-ID (11-stellig)
  taxClass             TaxClass?
  childAllowance       Float? // z.B. 0.5, 1.0, 1.5
  religion             Religion  @default(NONE)
  socialSecurityNumber String? // SV-Nummer
  healthInsurance      String? // Name der Krankenkasse
  healthInsuranceRate  Float? // Zusatzbeitrag (z.B. 1.7)
  isChildless          Boolean   @default(true) // Für PV-Zuschlag (+0.6%)

  // ============================================
  // HR MANAGEMENT - URLAUBSANSPRUCH
  // ============================================
  annualVacationDays Int @default(30) // Gesetzlich: 24 Tage bei 6-Tage-Woche

  // ============================================
  // HR MANAGEMENT - BANKVERBINDUNG (DEPRECATED)
  // ============================================
  // Bank data moved to EmployeeProfile (encrypted)
  // These fields will be removed in future migration

  // ============================================
  // HR MANAGEMENT - ZUSÄTZLICHE RELATIONS
  // ============================================
  payrollsReceived           Payroll[]          @relation("EmployeePayrollReceived")
  reviewedPayrolls           Payroll[]          @relation("PayrollReviewer")
  approvedPayrolls           Payroll[]          @relation("PayrollApprover")
  jobApplications            JobApplication[]   @relation("ApplicationReviewer")
  createdJobPostings         JobPosting[]       @relation("JobPostingCreator")
  approvalWorkflowsRequested ApprovalWorkflow[] @relation("WorkflowRequester")
  approvalWorkflowsCurrent   ApprovalWorkflow[] @relation("WorkflowApprover")
  approvalSteps              ApprovalStep[]

  // ============================================
  // ROADMAP MANAGEMENT - RELATIONS
  // ============================================
  assignedRoadmapTasks RoadmapTask[] @relation("RoadmapTaskAssignee")
  completedRoadmapTasks RoadmapTask[] @relation("RoadmapTaskCompleter")
  createdRoadmapTasks   RoadmapTask[] @relation("RoadmapTaskCreator")
  helpOffersRoadmapTasks RoadmapTaskHelpOffer[] @relation("RoadmapTaskHelper")

  // ============================================
  // BLOG SYSTEM - RELATIONS
  // ============================================
  authoredBlogPosts  BlogPost[]         @relation("AuthoredPosts")
  reviewedBlogPosts  BlogPost[]         @relation("ReviewedPosts")
  blogPostRevisions  BlogPostRevision[] @relation("PostRevisions")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("b24_employees")
}

// ============================================
// APPLICATION-BASED ACCESS CONTROL
// ============================================
// Simpler permission model: Employees either have access to an application or not
// If they have access, they have FULL access (no granular read/write/delete)

model Application {
  id          String   @id @default(cuid())
  key         String   @unique // e.g., "customers", "workshops", "hr", "buchhaltung"
  name        String // Display name, e.g., "Kundenverwaltung", "Werkstattverwaltung"
  description String? // Optional description
  icon        String   @default("Layout") // Lucide icon name
  adminRoute  String // Route in admin, e.g., "/admin/customers"
  color       String   @default("blue") // Tailwind color for UI
  sortOrder   Int      @default(0) // Display order in menus
  isActive    Boolean  @default(true) // Can be disabled without deleting
  category    String   @default("GENERAL") // GENERAL, ACCOUNTING, HR, SALES, SUPPORT

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employeeAssignments B24EmployeeApplication[]

  @@map("applications")
}

model B24EmployeeApplication {
  id             String   @id @default(cuid())
  employeeId     String
  applicationKey String
  assignedAt     DateTime @default(now())
  assignedBy     String // User ID who assigned the application

  // Roadmap Permissions (only for 'roadmap' application)
  canCreateTasks Boolean @default(false)
  canEditTasks   Boolean @default(false)

  employee    B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  application Application @relation(fields: [applicationKey], references: [key], onDelete: Cascade)

  @@unique([employeeId, applicationKey])
  @@map("b24_employee_applications")
}

model B24EmployeeActivityLog {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  action     String // e.g., "workshop_assigned", "customer_contacted", "offer_reviewed"
  resource   String? // e.g., "workshop", "customer", "offer"
  resourceId String? // ID of the resource
  details    String? @db.Text // JSON with additional details
  ipAddress  String?

  createdAt DateTime @default(now())

  @@index([employeeId])
  @@index([createdAt])
  @@map("b24_employee_activity_logs")
}

// ============================================
// WORKSHOP CRM / SALES TRACKING
// ============================================

model WorkshopCRM {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Sales Status
  leadStatus              String   @default("NEUKONTAKT") // NEUKONTAKT, INTERESSIERT, VERHANDLUNG, AKTIV, INAKTIV
  potential               String? // HOCH, MITTEL, NIEDRIG
  estimatedMonthlyRevenue Decimal? @db.Decimal(10, 2)

  // Contact Person
  mainContactName     String?
  mainContactPosition String?
  mainContactPhone    String?
  mainContactEmail    String?
  decisionMaker       Boolean @default(false)

  // Competition
  otherPlatforms String? @db.Text // Comma-separated or JSON

  // Next Steps
  nextContactDate DateTime?
  nextContactType String? // TELEFON, BESUCH, EMAIL
  followUpNotes   String?   @db.Text

  // Contract Status
  contractStatus    String? // KEIN_VERTRAG, ANGEBOT_GESENDET, VERHANDLUNG, VERTRAG_AKTIV
  contractStartDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  interactions WorkshopInteraction[]
  notes        WorkshopNote[]

  @@unique([workshopId])
  @@map("workshop_crm")
}

model WorkshopInteraction {
  id    String      @id @default(cuid())
  crmId String
  crm   WorkshopCRM @relation(fields: [crmId], references: [id], onDelete: Cascade)

  employeeId   String?
  employeeName String // Name of B24 employee who made contact

  type     String // TELEFON, BESUCH, EMAIL, MEETING
  date     DateTime
  duration Int? // Duration in minutes

  summary String  @db.Text
  outcome String? // POSITIV, NEUTRAL, NEGATIV, FOLLOW_UP_NEEDED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([crmId])
  @@index([date])
  @@map("workshop_interactions")
}

model WorkshopNote {
  id    String      @id @default(cuid())
  crmId String
  crm   WorkshopCRM @relation(fields: [crmId], references: [id], onDelete: Cascade)

  employeeId   String?
  employeeName String // Name of B24 employee who created note

  category String? // ALLGEMEIN, WICHTIG, ANFORDERUNG, PROBLEM, CHANCE
  title    String?
  content  String  @db.Text

  isPinned Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([crmId])
  @@index([createdAt])
  @@map("workshop_notes")
}

// ============================================
// ADMIN LOGS
// ============================================

model AdminLog {
  id         String  @id @default(cuid())
  adminEmail String
  action     String
  details    String?

  createdAt DateTime @default(now())

  @@map("admin_logs")
}

// ============================================
// PAGE VIEWS / ANALYTICS
// ============================================

model PageView {
  id String @id @default(cuid())

  // Page information
  path      String // e.g., "/", "/dashboard/customer", "/lp/werkstatt-mueller"
  fullUrl   String? // Full URL including query params
  pageTitle String? // Page title

  // User information
  userId    String? // Logged-in user ID (optional)
  userRole  String? // CUSTOMER, WORKSHOP, ADMIN (optional)
  ipAddress String? // IP address (anonymized for privacy)
  userAgent String? // Browser/device info

  // Referrer
  referrer String? // Where did the user come from

  // Workshop landing page tracking
  workshopId String? // If viewing a workshop landing page

  // Session tracking
  sessionId String? // Session identifier

  // Timing
  viewedAt DateTime @default(now())

  @@index([path])
  @@index([workshopId])
  @@index([viewedAt])
  @@index([userId])
  @@map("page_views")
}

// ============================================
// SALES CRM - PROSPECT MANAGEMENT
// ============================================

// Potenzielle Werkstatt aus Google Places
model ProspectWorkshop {
  id String @id @default(cuid())

  // Google Places Daten
  googlePlaceId String  @unique @map("google_place_id")
  name          String
  address       String
  city          String
  postalCode    String  @map("postal_code")
  state         String? // Bundesland
  country       String  @default("DE")
  phone         String?
  website       String?
  email         String?

  // Google Places Ratings
  rating      Float?
  reviewCount Int?   @default(0) @map("review_count")
  priceLevel  Int?   @map("price_level") // 0-4 (Google Places price level)

  // Media
  photoUrls String[] @map("photo_urls") // Array von Photo URLs

  // Location
  latitude  Float
  longitude Float

  // Google Places Metadata
  placeTypes   String[] @map("place_types") // ["car_repair", "car_dealer", etc.]
  openingHours Json?    @map("opening_hours") // Google Places opening hours structure

  // Sales Pipeline
  status           ProspectStatus @default(NEW)
  priority         Priority       @default(MEDIUM)
  estimatedRevenue Float?         @map("estimated_revenue") // Geschätzter Jahresumsatz

  // Lead Scoring
  leadScore Int? @default(50) @map("lead_score") // 0-100

  // Zuständigkeit
  assignedToId String?      @map("assigned_to_id") // B24Employee ID
  assignedTo   B24Employee? @relation("AssignedProspects", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt   DateTime?    @map("assigned_at")

  // Tracking
  source           String // "google_places", "manual", "referral", "website"
  firstContactDate DateTime? @map("first_contact_date")
  lastContactDate  DateTime? @map("last_contact_date")
  nextFollowUpDate DateTime? @map("next_follow_up_date")

  // Conversion
  convertedToWorkshopId String?   @unique @map("converted_to_workshop_id")
  convertedWorkshop     Workshop? @relation("ConvertedFromProspect", fields: [convertedToWorkshopId], references: [id], onDelete: SetNull)
  convertedAt           DateTime? @map("converted_at")
  conversionValue       Float?    @map("conversion_value") // Tatsächlicher Wert bei Conversion

  // Loss Tracking
  lostReason String? @map("lost_reason") // Grund warum verloren

  // Relations
  interactions ProspectInteraction[]
  tasks        ProspectTask[]
  notes        ProspectNote[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([assignedToId])
  @@index([postalCode])
  @@index([city])
  @@index([leadScore])
  @@index([nextFollowUpDate])
  @@map("prospect_workshops")
}

enum ProspectStatus {
  NEW // Neu gefunden
  CONTACTED // Erstkontakt gemacht
  QUALIFIED // Qualifiziert (hat Potenzial)
  MEETING_SCHEDULED // Termin vereinbart
  DEMO_COMPLETED // Demo durchgeführt
  PROPOSAL_SENT // Angebot verschickt
  NEGOTIATING // In Verhandlung
  VERBAL_AGREEMENT // Mündliche Zusage
  CONTRACT_SENT // Vertrag verschickt
  WON // Gewonnen → Workshop erstellt
  LOST // Verloren
  NOT_INTERESTED // Kein Interesse
  NOT_REACHABLE // Nicht erreichbar
  CALLBACK // Follow-up geplant
  ON_HOLD // Pausiert
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Interaktionen/Kontakthistorie
model ProspectInteraction {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  type    InteractionType
  channel ContactChannel
  subject String
  notes   String          @db.Text
  outcome String? // Ergebnis der Interaktion

  // Duration for calls/meetings (in minutes)
  duration Int?

  // Sentiment Analysis
  sentiment String? // "positive", "neutral", "negative"

  // Next Steps
  nextSteps String? @map("next_steps") @db.Text

  // Attachments
  attachments String[] // URLs zu hochgeladenen Dateien

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("InteractionCreator", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([prospectId])
  @@index([createdById])
  @@index([createdAt])
  @@map("prospect_interactions")
}

enum InteractionType {
  CALL // Telefonat
  EMAIL // E-Mail
  MEETING // Persönliches Treffen
  DEMO // Produkt-Demo
  NOTE // Notiz/Memo
  PROPOSAL // Angebot versendet
  CONTRACT // Vertrag
  FOLLOW_UP // Follow-up Kontakt
}

enum ContactChannel {
  PHONE
  EMAIL
  IN_PERSON // Persönlich
  VIDEO_CALL // Video-Call
  WHATSAPP
  SMS
  LINKEDIN
  OTHER
}

// Tasks/Follow-ups für Prospects
model ProspectTask {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  title       String
  description String?  @db.Text
  dueDate     DateTime @map("due_date")

  priority Priority   @default(MEDIUM)
  status   TaskStatus @default(PENDING)

  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")

  // Reminder
  reminderDate DateTime? @map("reminder_date")
  reminderSent Boolean   @default(false) @map("reminder_sent")

  assignedToId String      @map("assigned_to_id")
  assignedTo   B24Employee @relation("AssignedTasks", fields: [assignedToId], references: [id])

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("TaskCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([prospectId])
  @@index([assignedToId])
  @@index([dueDate])
  @@index([status])
  @@map("prospect_tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Notizen zu Prospects
model ProspectNote {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  content  String  @db.Text
  isPinned Boolean @default(false) @map("is_pinned") // Wichtige Notizen anpinnen

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("NoteCreator", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([prospectId])
  @@index([createdById])
  @@map("prospect_notes")
}

// Erweitere B24Employee Model für Sales-Beziehungen
// (Diese Relations müssen zum existierenden B24Employee Model hinzugefügt werden)
// assignedProspects     ProspectWorkshop[]      @relation("AssignedProspects")
// createdInteractions   ProspectInteraction[]   @relation("InteractionCreator")
// assignedTasks         ProspectTask[]          @relation("AssignedTasks")
// createdTasks          ProspectTask[]          @relation("TaskCreator")
// createdNotes          ProspectNote[]          @relation("NoteCreator")

// ============================================
// KVP - KONTINUIERLICHER VERBESSERUNGSPROZESS
// ============================================

model ImprovementSuggestion {
  id String @id @default(cuid())

  title       String              @db.VarChar(200)
  description String              @db.Text
  category    String              @db.VarChar(50) // z.B. "UI/UX", "Performance", "Prozess", "Feature"
  priority    ImprovementPriority @default(MEDIUM)
  status      ImprovementStatus   @default(NEW)

  // Zeitplan
  estimatedEffort String?   @db.VarChar(50) // z.B. "1 Tag", "1 Woche", "1 Monat"
  plannedDate     DateTime? // Geplante Umsetzung
  completedDate   DateTime? // Tatsächliche Umsetzung

  // Beziehungen
  submittedById String      @map("submitted_by_id")
  submittedBy   B24Employee @relation("ImprovementSubmitter", fields: [submittedById], references: [id])

  assignedToId String?      @map("assigned_to_id")
  assignedTo   B24Employee? @relation("ImprovementAssignee", fields: [assignedToId], references: [id])

  // Kommentare und Feedback
  comments ImprovementComment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([submittedById])
  @@index([assignedToId])
  @@map("improvement_suggestions")
}

model ImprovementComment {
  id String @id @default(cuid())

  suggestionId String                @map("suggestion_id")
  suggestion   ImprovementSuggestion @relation(fields: [suggestionId], references: [id], onDelete: Cascade)

  content      String  @db.Text
  isStatusNote Boolean @default(false) @map("is_status_note") // true = System-Notiz bei Statusänderung

  authorId String      @map("author_id")
  author   B24Employee @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([suggestionId])
  @@index([authorId])
  @@map("improvement_comments")
}

enum ImprovementStatus {
  NEW // Neu eingereicht
  IN_REVIEW // In Prüfung
  APPROVED // Genehmigt
  IN_PROGRESS // In Umsetzung
  COMPLETED // Abgeschlossen
  REJECTED // Abgelehnt
  ON_HOLD // Zurückgestellt
}

enum ImprovementPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// FILE MANAGEMENT / DOCUMENT CLOUD
// ============================================

model FileFolder {
  id         String       @id @default(cuid())
  name       String
  parentId   String?
  parent     FileFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  subfolders FileFolder[] @relation("FolderHierarchy")

  files FileUpload[]

  createdById String
  createdBy   B24Employee @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([createdById])
  @@map("file_folders")
}

model FileUpload {
  id          String @id @default(cuid())
  name        String // Original filename
  storagePath String @unique // Path on server filesystem
  mimeType    String
  size        Int // Size in bytes

  folderId String?
  folder   FileFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  uploadedById String
  uploadedBy   B24Employee @relation(fields: [uploadedById], references: [id])

  description String?

  downloads      Int       @default(0)
  lastDownloadAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([folderId])
  @@index([uploadedById])
  @@index([createdAt])
  @@map("file_uploads")
}

// ============================================
// PROCUREMENT & INVESTMENT MANAGEMENT
// ============================================

// Lieferanten / Suppliers
model Supplier {
  id      String  @id @default(cuid())
  name    String
  address String?
  zipCode String?
  city    String?
  country String? @default("Deutschland")
  email   String?
  phone   String?
  website String?

  // Tax & Banking
  taxId    String? // USt-IdNr.
  vatId    String? // Steuernummer
  iban     String?
  bic      String?
  bankName String?

  // Payment Terms
  paymentTerms String? @default("30 Tage netto") // z.B. "14 Tage 2% Skonto, 30 Tage netto"

  // Categories
  categories String[] // ["BUERO", "IT", "FAHRZEUGE", "MARKETING", "SONSTIGES"]

  // Rating
  rating Int     @default(0) // 0-5 Sterne
  notes  String? @db.Text

  // Relations
  orders   PurchaseOrder[]
  requests ProcurementRequest[]

  // Metadata
  isActive    Boolean @default(true)
  createdById String
  createdBy   User    @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([isActive])
  @@map("suppliers")
}

// Bedarfsanforderungen / Procurement Requests
model ProcurementRequest {
  id            String @id @default(cuid())
  requestNumber String @unique // z.B. "ANF-2025-001"

  // Requester
  requestedById String
  requestedBy   User   @relation(fields: [requestedById], references: [id])

  // Request Details
  title          String
  description    String?             @db.Text
  category       ProcurementCategory
  estimatedPrice Float // Geschätzter Preis in EUR

  // Priority & Classification
  urgency    UrgencyLevel @default(NORMAL)
  costCenter CostCenter

  // Supplier
  supplierId   String?
  supplier     Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  supplierName String? // Falls noch kein Lieferant im System

  // Approval Workflow
  status          RequestStatus @default(PENDING)
  approvedById    String?
  approvedBy      User?         @relation("ApprovedRequests", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?       @db.Text

  // Link to Order
  orderId String?        @unique
  order   PurchaseOrder? @relation(fields: [orderId], references: [id])

  // Link to Investment
  investmentItemId String?
  investmentItem   InvestmentItem? @relation(fields: [investmentItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requestNumber])
  @@index([requestedById])
  @@index([status])
  @@index([costCenter])
  @@map("procurement_requests")
}

// Bestellungen / Purchase Orders
model PurchaseOrder {
  id          String @id @default(cuid())
  orderNumber String @unique // z.B. "PO-2025-001"

  // Supplier
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  // Order Details
  items      OrderItem[]
  totalNet   Float // Gesamt netto
  totalVat   Float // Gesamt MwSt
  totalGross Float // Gesamt brutto

  // Status
  status OrderStatus @default(DRAFT)

  // Ordering
  orderedById String
  orderedBy   User      @relation(fields: [orderedById], references: [id])
  orderedAt   DateTime?

  // Delivery
  deliveryAddress  String?   @db.Text
  expectedDelivery DateTime?
  actualDelivery   DateTime?
  receivedById     String?
  receivedBy       User?     @relation("ReceivedOrders", fields: [receivedById], references: [id])
  receivedAt       DateTime?

  // Invoice & Payment
  invoiceNumber   String?
  invoiceDate     DateTime?
  invoiceReceived Boolean   @default(false)
  paymentDue      DateTime?
  paid            Boolean   @default(false)
  paidAt          DateTime?
  paidAmount      Float?

  // Notes
  notes         String? @db.Text
  internalNotes String? @db.Text

  // Links
  request ProcurementRequest?
  assets  Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderNumber])
  @@index([supplierId])
  @@index([status])
  @@index([orderedAt])
  @@map("purchase_orders")
}

// Bestellpositionen / Order Items
model OrderItem {
  id      String        @id @default(cuid())
  orderId String
  order   PurchaseOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  position    Int // Positionsnummer
  description String
  quantity    Int
  unit        String @default("Stück") // Stück, kg, Liter, etc.

  priceNet Float // Einzelpreis netto
  vatRate  Float // MwSt-Satz (0.19 oder 0.07)

  totalNet   Float // Gesamt netto
  totalVat   Float // Gesamt MwSt
  totalGross Float // Gesamt brutto

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@map("order_items")
}

// Anlagenvermögen / Assets
model Asset {
  id          String @id @default(cuid())
  assetNumber String @unique // z.B. "ASS-2025-001"

  // Asset Details
  name        String
  description String?       @db.Text
  category    AssetCategory

  // Acquisition
  acquisitionCost Float // Anschaffungskosten
  acquisitionDate DateTime
  orderId         String?
  order           PurchaseOrder? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Depreciation (AfA)
  usefulLife         Int // Nutzungsdauer in Jahren
  afaMethod          AfaMethod @default(LINEAR)
  annualDepreciation Float // Jährliche AfA

  // Current Value
  bookValue        Float // Aktueller Buchwert
  fullyDepreciated Boolean @default(false)

  // Location & Assignment
  costCenter   CostCenter
  location     String? // z.B. "Büro München, Raum 301"
  assignedToId String?
  assignedTo   User?      @relation(fields: [assignedToId], references: [id], onDelete: SetNull)

  // Additional Info
  serialNumber String?
  manufacturer String?
  model        String?

  // Status
  status         AssetStatus @default(ACTIVE)
  disposalDate   DateTime?
  disposalReason String?     @db.Text

  // Relations
  depreciationEntries DepreciationEntry[]
  depreciations       Depreciation[]      @relation("AssetDepreciations") // GmbH: Monatliche AfA
  vehicleCosts        VehicleCost[]       @relation("VehicleCosts")

  // Metadata
  createdById String
  createdBy   User   @relation("CreatedAssets", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetNumber])
  @@index([category])
  @@index([costCenter])
  @@index([status])
  @@map("assets")
}

// Abschreibungsbuchungen / Depreciation Entries
model DepreciationEntry {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  year      Int
  month     Int? // Optional für monatliche AfA
  amount    Float // Abschreibungsbetrag
  bookValue Float // Buchwert nach Abschreibung

  notes String?

  createdAt DateTime @default(now())

  @@unique([assetId, year, month])
  @@index([assetId])
  @@index([year])
  @@map("depreciation_entries")
}

// Investitionsplanung / Investment Planning
model InvestmentPlan {
  id   String @id @default(cuid())
  year Int    @unique

  // Budget per Cost Center
  totalBudget Float @default(0)
  spent       Float @default(0)
  reserved    Float @default(0) // Genehmigte aber noch nicht bestellte Anfragen

  // Relations
  items   InvestmentItem[]
  budgets CostCenterBudget[]

  // Metadata
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year])
  @@map("investment_plans")
}

// Budget pro Kostenstelle
model CostCenterBudget {
  id     String         @id @default(cuid())
  planId String
  plan   InvestmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  costCenter CostCenter
  budget     Float
  spent      Float      @default(0)
  reserved   Float      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, costCenter])
  @@index([planId])
  @@map("cost_center_budgets")
}

// Investitionsposten / Investment Items
model InvestmentItem {
  id     String         @id @default(cuid())
  planId String
  plan   InvestmentPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  // Details
  title       String
  description String?    @db.Text
  costCenter  CostCenter

  // Cost
  estimatedCost Float
  actualCost    Float?

  // Planning
  priority     InvestmentPriority @default(MEDIUM)
  type         InvestmentType
  quarter      Int? // 1, 2, 3, 4
  plannedMonth Int? // 1-12

  // Status
  status InvestmentStatus @default(PLANNED)

  // Relations
  requests ProcurementRequest[]

  // ROI Calculation (optional)
  expectedSavings Float? // Erwartete jährliche Einsparung
  paybackPeriod   Float? // Amortisationsdauer in Jahren

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
  @@index([costCenter])
  @@index([status])
  @@map("investment_items")
}

// ============================================
// ENUMS FOR PROCUREMENT
// ============================================

enum ProcurementCategory {
  GWG // Geringwertige Wirtschaftsgüter (bis 800€)
  SAMMELPOSTEN // 250-1000€
  ANLAGEVERMOEGEN // ab 1000€
  VERBRAUCH // Verbrauchsmaterial
  SOFTWARE // Software/Lizenzen
  DIENSTLEISTUNG // Dienstleistungen
  SONSTIGES // Sonstiges
}

enum UrgencyLevel {
  LOW
  NORMAL
  HIGH
  EMERGENCY
}

enum CostCenter {
  MARKETING
  SUPPORT
  IT
  BUCHHALTUNG
  PERSONAL
  ALLGEMEIN
}

enum RequestStatus {
  PENDING // Ausstehend
  APPROVED // Genehmigt
  REJECTED // Abgelehnt
  ORDERED // Bestellt
  COMPLETED // Abgeschlossen
  CANCELLED // Storniert
}

enum OrderStatus {
  DRAFT // Entwurf
  SENT // Versendet
  CONFIRMED // Bestätigt
  PARTIALLY_DELIVERED // Teilweise geliefert
  DELIVERED // Geliefert
  INVOICED // Rechnung erhalten
  PAID // Bezahlt
  CANCELLED // Storniert
}

enum AssetCategory {
  COMPUTER // Computer/Laptops
  MONITOR // Monitore
  PERIPHERALS // Peripherie (Drucker, Scanner, etc.)
  SOFTWARE // Software
  FURNITURE // Büromöbel
  VEHICLE // Fahrzeuge
  PHONE // Telefone/Smartphones
  NETWORK // Netzwerkgeräte
  SERVER // Server
  OTHER // Sonstiges
}

enum AfaMethod {
  LINEAR // Lineare Abschreibung
  DEGRESSIV // Degressive Abschreibung
  SOFORT // Sofortabschreibung (GWG)
}

enum AssetStatus {
  ACTIVE // Aktiv in Nutzung
  INACTIVE // Nicht in Nutzung
  IN_REPAIR // In Reparatur
  DISPOSED // Ausgemustert
  SOLD // Verkauft
}

enum InvestmentPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum InvestmentType {
  REPLACEMENT // Ersatzinvestition
  EXPANSION // Erweiterungsinvestition
  RATIONALIZATION // Rationalisierungsinvestition
  STRATEGIC // Strategische Investition
}

enum InvestmentStatus {
  PLANNED // Geplant
  APPROVED // Genehmigt
  IN_PROGRESS // In Bearbeitung
  COMPLETED // Abgeschlossen
  CANCELLED // Abgebrochen
  POSTPONED // Verschoben
}

// ============================================
// CO2 TRACKING SYSTEM
// ============================================

model CO2Settings {
  id                 String @id @default(cuid())
  workshopsToCompare Int    @default(3) // Anzahl Werkstätten, die Kunde sonst besuchen würde

  // Durchschnittswerte pro km (Fallback wenn kein Fahrzeug bekannt)
  co2PerKmCombustion Int @default(140) // g CO₂/km für Verbrenner (Durchschnitt)
  co2PerKmElectric   Int @default(50) // g CO₂/km für E-Autos (Strommix DE)

  // Kraftstoffspezifische CO₂-Faktoren (für präzise Berechnung mit Verbrauchsdaten)
  co2PerLiterPetrol Int @default(2320) // g CO₂/Liter Benzin
  co2PerLiterDiesel Int @default(2640) // g CO₂/Liter Diesel
  co2PerLiterLPG    Int @default(1640) // g CO₂/Liter LPG (Autogas)
  co2PerKgCNG       Int @default(1990) // g CO₂/kg CNG (Erdgas)
  co2PerKWhElectric Int @default(420) // g CO₂/kWh Strom (DE Mix)

  // Legacy field (kept for backwards compatibility)
  co2PerLiterFuel Int @default(2330) // g CO₂/Liter (Durchschnitt Benzin/Diesel)

  // Kraftstoffpreise für monetäre Einsparungsberechnung
  petrolPricePerLiter Float @default(1.75) // €/Liter (Benzin)
  dieselPricePerLiter Float @default(1.65) // €/Liter (Diesel)
  lpgPricePerLiter    Float @default(0.80) // €/Liter (LPG)
  cngPricePerKg       Float @default(1.10) // €/kg (CNG)
  electricPricePerKWh Float @default(0.35) // €/kWh (Strom)

  // Legacy field (kept for backwards compatibility)
  fuelPricePerLiter Float @default(1.65) // €/Liter (Durchschnitt)

  updatedAt DateTime @updatedAt

  @@map("co2_settings")
}

enum FuelType {
  UNKNOWN
  PETROL // Benzin
  DIESEL // Diesel
  ELECTRIC // Elektro
  HYBRID // Hybrid
  PLUGIN_HYBRID // Plugin-Hybrid
  LPG // Autogas
  CNG // Erdgas
}

// ========================================
// AFFILIATE / INFLUENCER MANAGEMENT SYSTEM
// ========================================

model Influencer {
  id String @id @default(cuid())

  // Basic Info
  email String  @unique
  code  String  @unique // Unique affiliate code: z.B. "PETER24"
  name  String?

  // Registration Status
  isRegistered            Boolean   @default(false)
  registrationToken       String?   @unique // Token für erste Registrierung
  registrationTokenExpiry DateTime?

  // Password Reset
  resetToken       String?   @unique @map("resettoken")
  resetTokenExpiry DateTime? @map("resettokenexpiry")

  // Authentication (wenn registriert)
  password String? // Hashed password
  isActive Boolean @default(true)

  // Platform & Channel Info
  platform           InfluencerPlatform?
  channelName        String? // z.B. "@username"
  channelUrl         String?
  additionalChannels Json? // Array of {platform, url}

  // Commission Settings (in Cents)
  commissionPer1000Views            Int @default(300) // €3.00 default
  commissionPerRegistration         Int @default(1500) // €15.00 default (maps to commissionPerCustomerRegistration in DB)
  commissionPerAcceptedOffer        Int @default(2500) // €25.00 default (maps to commissionPerCustomerFirstOffer in DB)
  commissionPerWorkshopRegistration Int @default(1500) // €15.00 default

  // Time Limits
  activeFrom  DateTime  @default(now())
  activeUntil DateTime? // null = unlimited
  isUnlimited Boolean   @default(false)

  // Payment Info
  paymentMethod PaymentMethod?

  // Bank Transfer
  accountHolder String?
  iban          String?
  bic           String?

  // PayPal
  paypalEmail String?

  // Tax Info
  taxType     TaxType? // INDIVIDUAL or BUSINESS
  companyName String?
  taxId       String? // Steuernummer / USt-ID

  // Address
  street  String?
  zipCode String?
  city    String?
  country String? @default("Deutschland")

  // Admin Notes
  notes String? @db.Text

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  clicks      AffiliateClick[]
  conversions AffiliateConversion[]
  payments    AffiliatePayment[]

  @@map("influencers")
}

model InfluencerApplication {
  id String @id @default(cuid())

  // Basic Info
  name  String
  email String

  // Platform Info
  platform    String // "YouTube", "Instagram", "TikTok", "Facebook", etc.
  channelName String
  channelUrl  String
  followers   Int?

  // Application Content
  message String? @db.Text

  // Status Workflow
  status ApplicationStatus @default(PENDING)

  // Admin Review
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?   @db.Text
  influencerId    String? // Reference to created influencer after approval

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("influencer_applications")
}

// ============================================
// DELETED USERS BLACKLIST
// ============================================

model DeletedUserEmail {
  id        String   @id @default(cuid())
  email     String   @unique // Email kann nicht mehr verwendet werden
  userType  String   @default("CUSTOMER") // 'CUSTOMER' or 'WORKSHOP'
  reason    String? // Grund für Löschung
  deletedBy String? // Admin/Employee der gelöscht hat
  deletedAt DateTime @default(now())

  // Support-Notizen
  supportNotes String?   @db.Text // Kommentare vom Support-Team
  unlockedAt   DateTime? // Wann wurde entsperrt
  unlockedBy   String? // Wer hat entsperrt
  updatedAt    DateTime  @updatedAt

  @@map("deleted_user_emails")
}

// ============================================
// INFLUENCER SETTINGS
// ============================================

model InfluencerSettings {
  id String @id @default(cuid())

  // Default commission rates displayed on landing page (in cents)
  defaultPer1000Views     Int @default(300) // €3.00
  defaultPerRegistration  Int @default(1500) // €15.00
  defaultPerAcceptedOffer Int @default(2500) // €25.00

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("influencer_settings")
}

model AffiliateClick {
  id           String     @id @default(cuid())
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  // Tracking Data
  ipAddress   String
  userAgent   String? @db.Text
  referrer    String? @db.Text
  landingPage String?

  // Cookie ID für Attribution
  cookieId String @unique

  // Timestamps
  clickedAt DateTime @default(now())

  // Optional: Device/Location Data
  deviceType String? // mobile, desktop, tablet
  country    String?
  city       String?

  @@index([influencerId])
  @@index([cookieId])
  @@index([clickedAt])
  @@map("affiliate_clicks")
}

model AffiliateConversion {
  id           String     @id @default(cuid())
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  // Conversion Type
  type ConversionType

  // Attribution
  cookieId String // Links back to AffiliateClick

  // Related Entities
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  workshopId String?   @map("workshop_id")
  workshop   Workshop? @relation(fields: [workshopId], references: [id])

  tireRequestId String?
  tireRequest   TireRequest? @relation(fields: [tireRequestId], references: [id])

  offerId String?
  offer   Offer?  @relation(fields: [offerId], references: [id])

  // Commission (in Cents)
  commissionAmount Int

  // Payment Status
  isPaid    Boolean           @default(false)
  paidAt    DateTime?
  paymentId String?
  payment   AffiliatePayment? @relation(fields: [paymentId], references: [id])

  // Timestamps
  convertedAt DateTime @default(now())

  @@index([influencerId])
  @@index([customerId])
  @@index([cookieId])
  @@index([convertedAt])
  @@index([isPaid])
  @@map("affiliate_conversions")
}

model AffiliatePayment {
  id           String     @id @default(cuid())
  influencerId String
  influencer   Influencer @relation(fields: [influencerId], references: [id], onDelete: Cascade)

  // Payment Period
  periodStart DateTime
  periodEnd   DateTime

  // Amounts (in Cents)
  totalAmount         Int
  clicksAmount        Int
  registrationsAmount Int
  offersAmount        Int

  // Counts
  totalClicks        Int
  totalRegistrations Int
  totalOffers        Int

  // Status
  status PaymentStatus @default(PENDING)

  // Payment Details
  paymentMethod    PaymentMethod
  paymentReference String? // z.B. PayPal Transaction ID oder Überweisung Referenz

  // Timestamps
  createdAt DateTime  @default(now())
  paidAt    DateTime?

  // Relations
  conversions AffiliateConversion[]

  @@index([influencerId])
  @@index([periodStart, periodEnd])
  @@index([status])
  @@map("affiliate_payments")
}

enum InfluencerPlatform {
  TIKTOK
  INSTAGRAM
  YOUTUBE
  FACEBOOK
  TWITTER
  LINKEDIN
  BLOG
  WEBSITE
  OTHER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ConversionType {
  PAGE_VIEW // Pro 1000 Views
  REGISTRATION // User registered
  ACCEPTED_OFFER // First offer accepted
  WORKSHOP_REGISTRATION // Workshop registration
}

enum PaymentMethod {
  BANK_TRANSFER
  PAYPAL
}

enum TaxType {
  INDIVIDUAL // Privatperson
  BUSINESS // Unternehmen
}

enum PaymentStatus {
  PENDING
  APPROVED
  PAID
  CANCELLED
}

// ============================================
// EMAIL SYSTEM
// ============================================

model EmailSettings {
  id            String       @id @default(cuid())
  userId        String?      @unique
  user          User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  b24EmployeeId String?      @unique
  b24Employee   B24Employee? @relation(fields: [b24EmployeeId], references: [id], onDelete: Cascade)

  // Encryption Key
  encryptionKey String? // AES-256 key for encrypting passwords

  // IMAP Settings
  imapHost     String // imap.hetzner.de
  imapPort     Int     @default(993)
  imapUser     String // employee@bereifung24.de
  imapPassword String // Encrypted
  imapTls      Boolean @default(true)

  // SMTP Settings
  smtpHost     String // smtp.hetzner.de
  smtpPort     Int     @default(465)
  smtpUser     String // employee@bereifung24.de
  smtpPassword String // Encrypted (same as IMAP)
  smtpSecure   Boolean @default(true)

  // Sync Settings
  syncEnabled  Boolean   @default(true)
  syncInterval Int       @default(300000) // 5 minutes in ms
  lastSyncedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_settings")
}

model EmailSignature {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  htmlContent String  @db.Text
  enabled     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_signatures")
}

model EmailMessage {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  b24EmployeeId String?      @map("b24employeeid")
  b24Employee   B24Employee? @relation(fields: [b24EmployeeId], references: [id], onDelete: Cascade)

  // IMAP Metadata
  uid       Int
  messageId String?
  folder    String   @default("INBOX")
  flags     String[] // ["\\Seen", "\\Flagged"]

  // Email Headers
  from    String
  to      String[]
  cc      String[] @default([])
  bcc     String[] @default([])
  replyTo String?
  subject String
  date    DateTime

  // Content
  textContent String? @db.Text
  htmlContent String? @db.Text
  attachments Json? // [{filename, contentType, size}]

  // Status
  isRead    Boolean @default(false)
  isFlagged Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, uid, folder])
  @@unique([b24EmployeeId, uid, folder])
  @@index([userId, folder])
  @@index([b24EmployeeId, folder])
  @@index([userId, date])
  @@index([b24EmployeeId, date])
  @@map("email_messages")
}

// ========================================
// EMPLOYEE PORTAL MODELS
// ========================================

model EmployeeProfile {
  id         String      @id @default(cuid())
  employeeId String      @unique
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Personal Information
  birthDate   DateTime?
  birthPlace  String?
  nationality String?
  address     String?
  city        String?
  postalCode  String?
  country     String?   @default("Deutschland")

  // Tax & Social Security (Encrypted)
  taxId            String? // Steuer-ID
  socialSecurityId String? // Sozialversicherungsnummer
  taxClass         String? // Steuerklasse (I, II, III, IV, V, VI)

  // Banking (Encrypted)
  bankAccount String? // IBAN
  bankName    String?
  bic         String?

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // Profile
  profileImageUrl String?
  bio             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employee_profiles")
}

enum DocumentType {
  CONTRACT // Arbeitsvertrag - nur HR
  PAYSLIP // Gehaltsabrechnung - nur HR
  TAX // Steuerdokumente - nur HR
  SOCIAL_SECURITY // Sozialversicherung - nur HR
  COMPANY // Betriebliche Dokumente - nur HR
  CERTIFICATE // Bescheinigungen - Mitarbeiter
  PROOF // Nachweise - Mitarbeiter
  OTHER // Sonstige - beide
}

model EmployeeDocument {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation("EmployeeDocuments", fields: [employeeId], references: [id], onDelete: Cascade)

  type        String // contract, payslip, certificate, tax, social_security, company, proof, other
  title       String
  description String?
  fileName    String
  fileSize    Int
  mimeType    String
  fileUrl     String // Encrypted path

  uploadedById String
  uploadedBy   B24Employee @relation("DocumentUploader", fields: [uploadedById], references: [id])
  uploadedAt   DateTime    @default(now())

  // Indicates if uploaded by HR/Admin or by Employee themselves
  uploadedByRole String @default("EMPLOYEE") // EMPLOYEE or HR

  // Access Control
  accessLog Json[] @default([]) // [{userId, accessedAt, ip}]

  // Metadata
  category   String?
  tags       String[]  @default([])
  validFrom  DateTime?
  validUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([type])
  @@index([uploadedByRole])
  @@map("employee_documents")
}

model LeaveBalance {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  year          Int
  totalDays     Float @default(30) // Gesetzlicher Anspruch
  usedDays      Float @default(0)
  pendingDays   Float @default(0)
  remainingDays Float @default(30)

  // Übertrag aus Vorjahr
  carryOverDays Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, year])
  @@map("leave_balances")
}

model LeaveRequest {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation("EmployeeLeaveRequests", fields: [employeeId], references: [id], onDelete: Cascade)

  type      String // vacation, sick, special, unpaid
  startDate DateTime
  endDate   DateTime
  days      Float // Arbeitstage

  reason String?
  notes  String?

  status String @default("pending") // pending, approved, rejected, cancelled

  approvedById    String?
  approvedBy      B24Employee? @relation("LeaveApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?

  // Vertretung
  substituteId String?
  substitute   B24Employee? @relation("LeaveSubstitute", fields: [substituteId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("leave_requests")
}

model SickLeave {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  startDate          DateTime
  endDate            DateTime?
  expectedReturnDate DateTime?
  actualReturnDate   DateTime?

  certificateRequired   Boolean   @default(true)
  certificateUrl        String? // AU-Bescheinigung
  certificateUploadedAt DateTime?

  notes String?

  notifiedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([startDate])
  @@map("sick_leaves")
}

// TIME TRACKING SYSTEM
// ============================================

model WorkSession {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  startTime DateTime
  endTime   DateTime?

  // Pausenzeiten
  breakMinutes Int @default(0)

  // Automatisch berechnet bei endTime
  totalMinutes Int?
  workMinutes  Int? // totalMinutes - breakMinutes

  // Optional: Projekt/Kunde zuordnen
  projectName String?
  notes       String?

  // Status
  isActive Boolean @default(true) // true = läuft gerade

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  breaks Break[]

  @@index([employeeId])
  @@index([startTime])
  @@index([isActive])
  @@map("work_sessions")
}

model Break {
  id        String      @id @default(cuid())
  sessionId String
  session   WorkSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  startTime DateTime
  endTime   DateTime?

  minutes Int? // Automatisch berechnet

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@map("breaks")
}

model OvertimeBalance {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  year  Int
  month Int

  // Soll-Stunden (z.B. 160h bei 40h/Woche)
  targetHours Float @default(160)

  // Ist-Stunden
  actualHours Float @default(0)

  // Differenz
  overtimeHours Float @default(0) // Kann negativ sein (Minusstunden)

  // Kumuliert (inkl. Vormonat)
  cumulativeOvertime Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, year, month])
  @@index([employeeId])
  @@map("overtime_balances")
}

// COMPANY VEHICLES & TRIP LOG
// ============================================

model CompanyVehicle {
  id String @id @default(cuid())

  // Fahrzeug-Stammdaten
  licensePlate String  @unique
  make         String // z.B. "BMW"
  model        String // z.B. "320d"
  year         Int?
  vin          String? @unique

  // Kilometer
  currentKm Int @default(0)

  // Zuordnung (optional)
  assignedToId String?
  assignedTo   B24Employee? @relation(fields: [assignedToId], references: [id])

  // Leasingdaten
  leasingCompany String?
  leasingStart   DateTime?
  leasingEnd     DateTime?
  monthlyRate    Decimal?  @db.Decimal(10, 2)
  includedKm     Int? // Inklusiv-Kilometer pro Jahr

  // Wartung
  lastService    DateTime?
  nextService    DateTime?
  nextServiceKm  Int?
  nextInspection DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trips        TripEntry[]
  fuelReceipts FuelReceipt[]
  damages      VehicleDamage[]
  maintenances VehicleMaintenance[]

  @@map("company_vehicles")
}

model TripEntry {
  id        String         @id @default(cuid())
  vehicleId String
  vehicle   CompanyVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Fahrt-Daten
  date       DateTime
  startKm    Int
  endKm      Int
  distanceKm Int // Berechnet: endKm - startKm

  // Ziel
  startLocation String
  endLocation   String
  purpose       String // z.B. "Kundenbesuch"

  // Art
  tripType String @default("BUSINESS") // BUSINESS, PRIVATE, COMMUTE

  // Optional: Kunde/Projekt
  customerName String?
  projectName  String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([vehicleId])
  @@index([date])
  @@map("trip_entries")
}

model FuelReceipt {
  id        String         @id @default(cuid())
  vehicleId String
  vehicle   CompanyVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  date       DateTime
  km         Int // Kilometerstand bei Tankung
  liters     Float
  priceTotal Decimal  @db.Decimal(10, 2)
  station    String? // z.B. "Shell"

  receiptUrl String? // Foto des Belegs

  createdAt DateTime @default(now())

  @@index([employeeId])
  @@index([vehicleId])
  @@map("fuel_receipts")
}

model VehicleDamage {
  id        String         @id @default(cuid())
  vehicleId String
  vehicle   CompanyVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  reportedById String
  reportedBy   B24Employee @relation(fields: [reportedById], references: [id])

  date        DateTime
  location    String? // Wo ist der Schaden aufgetreten
  description String
  severity    String   @default("MINOR") // MINOR, MAJOR, CRITICAL

  // Fotos
  photos String? // JSON Array von URLs

  // Status
  status     String    @default("REPORTED") // REPORTED, IN_REPAIR, REPAIRED, INSURANCE_CLAIM
  repairedAt DateTime?
  repairCost Decimal?  @db.Decimal(10, 2)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vehicleId])
  @@index([reportedById])
  @@map("vehicle_damages")
}

model VehicleMaintenance {
  id        String         @id @default(cuid())
  vehicleId String
  vehicle   CompanyVehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  type String // SERVICE, INSPECTION, TIRE_CHANGE, REPAIR, OTHER

  date        DateTime
  km          Int
  workshop    String?
  cost        Decimal? @db.Decimal(10, 2)
  description String

  // Nächster Service
  nextServiceKm   Int?
  nextServiceDate DateTime?

  receiptUrl String? // Rechnung/Beleg

  createdAt DateTime @default(now())

  @@index([vehicleId])
  @@map("vehicle_maintenances")
}

// ============================================
// SPESEN & BELEGE (PHASE 5)
// ============================================

enum ExpenseCategory {
  MEAL // Essen & Trinken
  HOTEL // Übernachtung
  TRAVEL // Fahrtkosten (nicht Firmenwagen)
  FUEL // Tankkosten
  TOOLS // Werkzeug/Material
  OFFICE // Büromaterial
  PHONE // Telefon/Internet
  OTHER // Sonstiges
}

enum ExpenseStatus {
  PENDING // Warten auf Genehmigung
  APPROVED // Genehmigt
  REJECTED // Abgelehnt
  PAID // Ausgezahlt
}

model Expense {
  id String @id @default(cuid())

  employeeId String
  employee   B24Employee @relation("EmployeeExpenses", fields: [employeeId], references: [id], onDelete: Cascade)

  // Beleg-Informationen
  category    ExpenseCategory
  amount      Decimal         @db.Decimal(10, 2)
  vatAmount   Decimal?        @db.Decimal(10, 2) // MwSt.-Betrag
  vatRate     Int? // MwSt.-Satz in % (7 oder 19)
  date        DateTime // Datum des Belegs
  description String
  merchant    String? // Händler/Lieferant

  // Beleg-Upload
  receiptUrl String? // Pfad zum hochgeladenen Beleg

  // OCR-Daten (optional)
  ocrExtracted Boolean @default(false)
  ocrData      String? // JSON mit OCR-Ergebnissen

  // Status & Genehmigung
  status        ExpenseStatus @default(PENDING)
  approvedById  String?
  approvedBy    B24Employee?  @relation("ApprovedExpenses", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  rejectionNote String? // Grund für Ablehnung

  // Auszahlung
  paidAt        DateTime?
  paymentMethod String? // BANK_TRANSFER, CASH, PAYROLL

  // Projekt/Kunde-Zuordnung (optional)
  projectName  String?
  customerName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([date])
  @@map("expenses")
}

model TravelExpense {
  id String @id @default(cuid())

  employeeId String
  employee   B24Employee @relation("EmployeeTravelExpenses", fields: [employeeId], references: [id], onDelete: Cascade)

  // Reise-Informationen
  purpose     String // Zweck der Reise
  startDate   DateTime // Beginn der Reise
  endDate     DateTime // Ende der Reise
  destination String // Zielort

  // Verpflegungspauschale
  fullDays      Int     @default(0) // Anzahl volle Tage (24h+)
  partialDays   Int     @default(0) // Anzahl Teilreisetage (8-24h)
  dailyRate     Decimal @default(28.00) @db.Decimal(10, 2) // Tagessatz Deutschland
  mealDeduction Decimal @default(0) @db.Decimal(10, 2) // Abzug für gestellte Mahlzeiten

  // Übernachtungskosten
  accommodationCosts    Decimal @default(0) @db.Decimal(10, 2)
  accommodationReceipts String? // JSON Array von Receipt-URLs

  // Fahrtkosten
  travelCosts    Decimal  @default(0) @db.Decimal(10, 2)
  travelMethod   String? // CAR, TRAIN, PLANE, TAXI, PUBLIC_TRANSPORT
  travelReceipts String? // JSON Array von Receipt-URLs
  kmDriven       Int? // Bei PKW: gefahrene KM
  kmRate         Decimal? @default(0.30) @db.Decimal(10, 2) // €/km

  // Sonstige Kosten
  otherCosts       Decimal @default(0) @db.Decimal(10, 2)
  otherDescription String?
  otherReceipts    String? // JSON Array von Receipt-URLs

  // Gesamt
  totalAmount Decimal @db.Decimal(10, 2) // Gesamtsumme

  // Status & Genehmigung
  status        ExpenseStatus @default(PENDING)
  approvedById  String?
  approvedBy    B24Employee?  @relation("ApprovedTravelExpenses", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  rejectionNote String?

  // Auszahlung
  paidAt        DateTime?
  paymentMethod String?

  notes String? // Zusätzliche Bemerkungen

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@map("travel_expenses")
}

// B24Employee Relations erweitern
// Hinweis: Diese Relations müssen zum bestehenden B24Employee Model hinzugefügt werden:
// expenses       Expense[]       @relation("EmployeeExpenses")
// approvedExpenses Expense[]     @relation("ApprovedExpenses")
// travelExpenses TravelExpense[] @relation("EmployeeTravelExpenses")
// approvedTravelExpenses TravelExpense[] @relation("ApprovedTravelExpenses")

// ============================================
// PHASE 7: COMMUNICATION & ORGANIZATION
// ============================================

// SCHWARZES BRETT (Announcements/News)
// ============================================

model Announcement {
  id String @id @default(cuid())

  title   String
  content String           @db.Text
  type    AnnouncementType @default(GENERAL)

  // Priorität & Sichtbarkeit
  priority AnnouncementPriority @default(NORMAL)
  isPinned Boolean              @default(false) // Oben fixieren
  isActive Boolean              @default(true)

  // Zeitraum
  publishedAt DateTime? // Veröffentlichungsdatum (null = Entwurf)
  expiresAt   DateTime? // Ablaufdatum (optional)

  // Autor
  authorId String
  author   B24Employee @relation("AnnouncementAuthor", fields: [authorId], references: [id])

  // Anhänge (optional)
  attachments String? // JSON Array: [{name: "file.pdf", url: "/uploads/..."}]

  // Statistik
  viewCount Int @default(0)

  // Gelesen von (Many-to-Many)
  readBy AnnouncementRead[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([priority])
  @@index([isPinned])
  @@index([publishedAt])
  @@map("announcements")
}

enum AnnouncementType {
  GENERAL // Allgemein
  NEWS // Firmenneuigkeiten
  EVENT // Events/Termine
  BIRTHDAY // Geburtstage
  ACHIEVEMENT // Erfolge/Meilensteine
  POLICY // Richtlinien/Policy
  URGENT // Dringend
  MARKETPLACE // Kleinanzeigen
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model AnnouncementRead {
  id String @id @default(cuid())

  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  employeeId String
  employee   B24Employee @relation("ReadAnnouncements", fields: [employeeId], references: [id], onDelete: Cascade)

  readAt DateTime @default(now())

  @@unique([announcementId, employeeId])
  @@index([employeeId])
  @@map("announcement_reads")
}

// AUFGABENVERWALTUNG (Task Management) für Mitarbeiter
// ============================================

model EmployeeTask {
  id String @id @default(cuid())

  title       String
  description String?            @db.Text
  status      EmployeeTaskStatus @default(TODO)
  priority    TaskPriority       @default(MEDIUM)

  // Zuweisungen
  assignedToId String
  assignedTo   B24Employee @relation("EmployeeAssignedTasks", fields: [assignedToId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   B24Employee @relation("EmployeeCreatedTasks", fields: [createdById], references: [id])

  // Zeitplanung
  dueDate   DateTime?
  startDate DateTime?

  // Projekt/Kategorie
  category String? // z.B. "HR", "IT", "Vertrieb"
  tags     String? // JSON Array: ["urgent", "customer-related"]

  // Fortschritt
  progress       Int    @default(0) // 0-100%
  estimatedHours Float? // Geschätzte Stunden
  actualHours    Float? // Tatsächliche Stunden

  // Abschluss
  completedAt   DateTime?
  completedById String?
  completedBy   B24Employee? @relation("EmployeeCompletedTasks", fields: [completedById], references: [id])

  // Kommentare & Aktivitäten
  comments EmployeeTaskComment[]

  // Dateianhänge
  attachments EmployeeTaskAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assignedToId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@map("employee_tasks")
}

enum EmployeeTaskStatus {
  TODO // Zu erledigen
  IN_PROGRESS // In Arbeit
  REVIEW // Zur Überprüfung
  BLOCKED // Blockiert
  COMPLETED // Abgeschlossen
  CANCELLED // Abgebrochen
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model EmployeeTaskComment {
  id String @id @default(cuid())

  taskId String
  task   EmployeeTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  authorId String
  author   B24Employee @relation("EmployeeTaskComments", fields: [authorId], references: [id])

  content String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@map("employee_task_comments")
}

model EmployeeTaskAttachment {
  id String @id @default(cuid())

  taskId String       @map("taskid")
  task   EmployeeTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  uploadedById String      @map("uploadedbyid")
  uploadedBy   B24Employee @relation("EmployeeTaskAttachments", fields: [uploadedById], references: [id])

  fileName    String  @map("filename")
  fileSize    Int     @map("filesize")
  fileType    String  @map("filetype")
  filePath    String  @map("filepath") // Pfad im Dateisystem oder Cloud Storage
  downloadUrl String? @map("downloadurl") // Optional: Pre-signed URL für Download

  createdAt DateTime @default(now()) @map("createdat")

  @@index([taskId])
  @@map("employee_task_attachments")
}

// WISSENSDATENBANK (Knowledge Base)
// ============================================

model KnowledgeArticle {
  id String @id @default(cuid())

  title   String
  slug    String        @unique // URL-freundlicher Titel
  content String        @db.Text
  excerpt String? // Kurzbeschreibung
  type    KnowledgeType @default(ARTICLE)

  // Kategorisierung
  category String? // z.B. "Onboarding", "IT", "HR-Policies"
  tags     String? // JSON Array

  // Sichtbarkeit & Status
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  isPinned    Boolean   @default(false)

  // Autor & Verwaltung
  authorId String
  author   B24Employee @relation("KnowledgeArticles", fields: [authorId], references: [id])

  lastEditedById String?
  lastEditedBy   B24Employee? @relation("EditedArticles", fields: [lastEditedById], references: [id])

  // Dateien & Medien
  attachments String? // JSON Array: [{name, url, type, size}]
  videoUrl    String? // Optional: Link zu Tutorial-Video

  // Statistik
  viewCount    Int @default(0)
  helpfulCount Int @default(0) // "War dies hilfreich?" Counter

  // Versionierung (optional für später)
  version Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([category])
  @@index([isPublished])
  @@map("knowledge_articles")
}

enum KnowledgeType {
  ARTICLE // Artikel/Anleitung
  FAQ // Häufig gestellte Frage
  TEMPLATE // Vorlage/Formular
  VIDEO // Video-Tutorial
  POLICY // Richtlinie
}

// B24Employee Relations für Phase 7 erweitern:
// announcements            Announcement[]          @relation("AnnouncementAuthor")
// readAnnouncements        AnnouncementRead[]      @relation("ReadAnnouncements")
// employeeAssignedTasks    EmployeeTask[]          @relation("EmployeeAssignedTasks")
// employeeCreatedTasks     EmployeeTask[]          @relation("EmployeeCreatedTasks")
// employeeCompletedTasks   EmployeeTask[]          @relation("EmployeeCompletedTasks")
// employeeTaskComments     EmployeeTaskComment[]   @relation("EmployeeTaskComments")
// knowledgeArticles        KnowledgeArticle[]      @relation("KnowledgeArticles")
// editedArticles           KnowledgeArticle[]      @relation("EditedArticles")

// ============================================
// BUCHHALTUNG (ACCOUNTING SYSTEM)
// ============================================

// Kontenrahmen SKR04
model ChartOfAccounts {
  id            String      @id @default(cuid())
  accountNumber String      @unique // z.B. "4120", "8400"
  accountName   String // z.B. "Löhne und Gehälter", "Erlöse 19% USt"
  accountType   AccountType // REVENUE, EXPENSE, ASSET, LIABILITY
  skrType       String      @default("SKR04") // Kontenrahmen-Version
  parentAccount String? // Hierarchie (optional)
  isActive      Boolean     @default(true)
  description   String? // Zusätzliche Beschreibung

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountNumber])
  @@index([accountType])
  @@index([skrType])
  @@map("chart_of_accounts")
}

enum AccountType {
  REVENUE // Erlöse/Einnahmen (8xxx)
  EXPENSE // Aufwendungen/Ausgaben (4xxx, 6xxx)
  ASSET // Vermögen (0xxx, 1xxx)
  LIABILITY // Verbindlichkeiten/Kapital (2xxx, 3xxx)
}

// Zentrale Buchungseinträge
model AccountingEntry {
  id          String @id @default(cuid())
  entryNumber String @unique // Fortlaufende Belegnummer (GoBD) z.B. "BEL-2026-00001"

  // Datum
  bookingDate  DateTime // Buchungsdatum
  documentDate DateTime // Belegdatum

  // Konten (SKR04)
  debitAccount  String // Soll-Konto (4-stellig)
  creditAccount String // Haben-Konto (4-stellig)

  // Beträge
  amount    Decimal  @db.Decimal(10, 2) // Brutto-Betrag
  vatRate   Int?     @default(0) // MwSt-Satz in % (0, 7, 19)
  vatAmount Decimal? @db.Decimal(10, 2) // MwSt-Betrag
  netAmount Decimal? @db.Decimal(10, 2) // Netto-Betrag

  // Beschreibung
  description    String // Buchungstext
  documentNumber String? // Externe Belegnummer (z.B. Rechnungsnummer)

  // Verknüpfung zu Quell-Datensatz
  sourceType EntrySourceType // Woher kommt die Buchung?
  sourceId   String? // ID des Original-Datensatzes

  // Belege/Anlagen
  attachmentUrls String[] @default([]) // Array von URLs zu PDF/Foto-Belegen

  // GoBD-Konformität
  locked     Boolean   @default(false) // Gesperrt (nicht mehr änderbar)
  lockedAt   DateTime? // Zeitpunkt der Sperrung
  lockedById String? // Wer hat gesperrt?
  lockedBy   User?     @relation("AccountingEntryLocker", fields: [lockedById], references: [id])

  // Stornierung
  isStorno        Boolean           @default(false) // Ist dies eine Storno-Buchung?
  originalEntryId String? // Verknüpfung zur Original-Buchung
  originalEntry   AccountingEntry?  @relation("StornoEntries", fields: [originalEntryId], references: [id], onDelete: SetNull)
  stornoEntries   AccountingEntry[] @relation("StornoEntries")

  // Audit
  createdById String?
  createdBy   User?   @relation("AccountingEntryCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Audit-Log
  auditLogs AccountingAuditLog[]
  
  // Invoice Relation (für Provisionsrechnungen)
  commissionInvoice CommissionInvoice? @relation("InvoiceAccountingEntry")

  @@index([bookingDate])
  @@index([entryNumber])
  @@index([sourceType, sourceId])
  @@index([debitAccount])
  @@index([creditAccount])
  @@index([locked])
  @@map("accounting_entries")
}

enum EntrySourceType {
  COMMISSION // Werkstatt-Provision
  EXPENSE // Mitarbeiter-Spesen
  TRAVEL_EXPENSE // Reisekosten
  PAYROLL // Gehaltsabrechnung
  PROCUREMENT // Einkauf/Bestellung
  INFLUENCER // Influencer-Zahlung
  VEHICLE // Fahrzeugkosten
  MANUAL // Manuelle Buchung
}

// Audit-Trail für Buchungen (GoBD)
model AccountingAuditLog {
  id      String          @id @default(cuid())
  entryId String
  entry   AccountingEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  action  String // CREATED, UPDATED, LOCKED, STORNO
  userId  String?
  user    User?    @relation("AccountingAuditor", fields: [userId], references: [id])
  changes String? @db.Text // JSON mit Änderungen (alt → neu)

  timestamp DateTime @default(now())

  @@index([entryId])
  @@index([timestamp])
  @@map("accounting_audit_logs")
}

// Buchungsvorlagen (für wiederkehrende manuelle Buchungen)
model BookingTemplate {
  id            String  @id @default(cuid())
  name          String // Anzeigename (z.B. "Büromiete Januar")
  description   String // Suchbar im Autocomplete
  debitAccount  String // SKR04 Soll-Konto (4-stellig)
  creditAccount String // SKR04 Haben-Konto (4-stellig)
  amount        Decimal @db.Decimal(10, 2) // Standard-Betrag (änderbar beim Buchen)
  useCount      Int     @default(0) // Wie oft verwendet (für Sortierung)

  createdById String
  createdBy   User   @relation("BookingTemplateCreator", fields: [createdById], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([description])
  @@index([useCount])
  @@map("booking_templates")
}

// Gehaltsabrechnungen
// ============================================
// FAHRZEUGKOSTEN (Bereifung24 Geschäftsfahrzeuge)
// ============================================

// Fahrzeugkosten
model VehicleCost {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation("VehicleCosts", fields: [assetId], references: [id], onDelete: Cascade)

  // Kostenart
  costType VehicleCostType

  // Details
  date        DateTime
  amount      Decimal  @db.Decimal(10, 2)
  mileage     Int? // KM-Stand bei Tankfüllung/Service
  description String
  vendor      String? // Tankstelle, Werkstatt, Versicherung, etc.

  // Beleg
  receiptUrl String?

  // Notizen
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId, date])
  @@index([costType])
  @@index([date])
  @@map("vehicle_costs")
}

enum VehicleCostType {
  FUEL // Treibstoff
  MAINTENANCE // Wartung/Inspektion
  INSURANCE // Versicherung
  TAX // Kfz-Steuer
  REPAIRS // Reparaturen
  PARKING // Parkgebühren
  TOLLS // Maut
  WASHING // Autowäsche
  TIRES // Reifen
  OTHER // Sonstiges
}

// Buchhaltungs-Einstellungen
model AccountingSetting {
  id String @id @default(cuid())

  // Steuerberater
  taxAdvisorName    String?
  taxAdvisorCompany String?
  taxAdvisorEmail   String?
  taxAdvisorPhone   String?
  taxAdvisorAddress String? @db.Text

  // Unternehmens-Stammdaten
  companyTaxNumber String? // Steuernummer
  companyVatId     String? // USt-IdNr.

  // Export-Präferenzen
  preferredExportFormat ExportFormat @default(EXCEL) // DATEV, EXCEL, PDF

  // Kontenplan
  accountingSystem String @default("SKR04") // SKR03 oder SKR04

  // Belegnummern
  entryNumberPrefix  String @default("BEL") // Präfix für Belegnummern
  entryNumberCounter Int    @default(0) // Fortlaufender Counter

  // Standard-MwSt-Sätze
  defaultVatRate Int @default(19) // Standard 19%
  reducedVatRate Int @default(7) // Ermäßigt 7%

  // Einstellungen
  autoLockAfterExport Boolean @default(false) // Buchungen nach Export sperren?
  fiscalYearStart     Int     @default(1) // Geschäftsjahresbeginn (Monat 1-12)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("accounting_settings")
}

enum ExportFormat {
  DATEV // DATEV CSV-Format
  EXCEL // Excel-Datei
  PDF // PDF-Bericht
}

// ============================================
// GmbH-SPEZIFISCHE ERWEITERUNGEN
// ============================================

// Bilanz (Aktiva/Passiva) - GmbH-Pflicht
model BalanceSheet {
  id         String @id @default(cuid())
  year       Int // Geschäftsjahr
  fiscalYear String // z.B. "2026" oder "2026/2027"

  // Aktiva (Vermögen)
  assets Json // Struktur: {anlagevermoegen: {...}, umlaufvermoegen: {...}}
  // Beispiel: {
  //   anlagevermoegen: { sachanlagen: 50000, finanzanlagen: 0 },
  //   umlaufvermoegen: { vorraete: 10000, forderungen: 25000, bank: 15000 }
  // }

  // Passiva (Kapital + Schulden)
  liabilities Json // Struktur: {eigenkapital: {...}, rueckstellungen: {...}, verbindlichkeiten: {...}}
  // Beispiel: {
  //   eigenkapital: { stammkapital: 25000, gewinnvortrag: 10000, jahresueberschuss: 15000 },
  //   rueckstellungen: { steuerrueckstellungen: 5000 },
  //   verbindlichkeiten: { verbindlichkeiten: 45000 }
  // }

  // Bilanzsumme (muss auf beiden Seiten gleich sein)
  totalAssets      Decimal @db.Decimal(12, 2)
  totalLiabilities Decimal @db.Decimal(12, 2)

  // Status
  locked     Boolean   @default(false) // Nach Feststellung gesperrt
  lockedAt   DateTime?
  approvedBy String? // Admin/Geschäftsführer
  notes      String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year])
  @@index([year])
  @@map("balance_sheets")
}

// Gewinn- und Verlustrechnung (GuV) - ersetzt EÜR bei GmbH
model IncomeStatement {
  id         String @id @default(cuid())
  year       Int // Geschäftsjahr
  fiscalYear String // z.B. "2026"

  // Umsatzerlöse
  revenue Json // Struktur nach GuV-Schema
  // Beispiel: {
  //   umsatzerloese: 250000,
  //   sonstigeBetrieblicheErtraege: 5000
  // }

  // Aufwendungen
  expenses Json // Struktur nach GuV-Schema
  // Beispiel: {
  //   materialaufwand: 80000,
  //   personalaufwand: 95000,
  //   abschreibungen: 10000,
  //   sonstigeAufwendungen: 25000
  // }

  // Finanzergebnis
  financialResult Json? // Zinsen, etc.

  // Ergebnis vor Steuern
  earningsBeforeTax Decimal @db.Decimal(12, 2)

  // Steuern
  taxes Decimal @default(0) @db.Decimal(12, 2)

  // Jahresüberschuss/-fehlbetrag
  netIncome Decimal @db.Decimal(12, 2)

  // Status
  locked     Boolean   @default(false)
  lockedAt   DateTime?
  approvedBy String?
  notes      String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year])
  @@index([year])
  @@map("income_statements")
}

// Abschreibungen auf Anlagevermögen
model Depreciation {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation("AssetDepreciations", fields: [assetId], references: [id], onDelete: Cascade)

  // Zeitraum
  year  Int
  month Int // 1-12

  // Abschreibung
  depreciationRate        Decimal @db.Decimal(5, 2) // z.B. 20.00% für 5 Jahre
  depreciationAmount      Decimal @db.Decimal(10, 2) // Monatlicher Abschreibungsbetrag
  accumulatedDepreciation Decimal @db.Decimal(10, 2) // Kumulierte Abschreibung bis dato
  bookValue               Decimal @db.Decimal(10, 2) // Restbuchwert

  // Verknüpfung zur Buchung
  entryId String? // Verknüpfung zu AccountingEntry (monatliche Afa-Buchung)

  // Methode
  method String @default("LINEAR") // LINEAR, DEGRESSIVE, SOFORT

  // Notizen
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId, year, month])
  @@index([year, month])
  @@map("depreciations")
}

// Rückstellungen (GmbH-Pflicht)
model Provision {
  id   String        @id @default(cuid())
  type ProvisionType

  // Details
  year        Int
  amount      Decimal @db.Decimal(10, 2)
  description String
  reason      String? @db.Text // Begründung der Rückstellung

  // Status
  released       Boolean   @default(false) // Wurde aufgelöst?
  releasedAt     DateTime?
  releasedAmount Decimal?  @db.Decimal(10, 2)

  // Verknüpfung
  entryId String? // Verknüpfung zur Bildungs-Buchung

  // Notizen
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year, type])
  @@index([released])
  @@map("provisions")
}

enum ProvisionType {
  TAX // Steuerrückstellungen
  VACATION // Urlaubsrückstellungen
  WARRANTY // Gewährleistungsrückstellungen
  LEGAL // Rechtliche Verpflichtungen
  RESTRUCTURING // Restrukturierung
  PENSION // Pensionsrückstellungen
  OTHER // Sonstige
}

// Forderungen und Verbindlichkeiten (für Bilanzbuchhaltung)
model AccountsReceivable {
  id            String  @id @default(cuid())
  invoiceNumber String  @unique // Rechnungsnummer
  customerName  String
  customerId    String? // Optional: Verknüpfung zu User

  // Betrag
  amount    Decimal  @db.Decimal(10, 2) // Brutto
  netAmount Decimal? @db.Decimal(10, 2)
  vatAmount Decimal? @db.Decimal(10, 2)
  vatRate   Int?     @default(19)

  // Datum
  invoiceDate DateTime
  dueDate     DateTime
  paidAt      DateTime? // Wann bezahlt?

  // Status
  status ReceivableStatus @default(OPEN)

  // Zahlungseingang
  paidAmount Decimal? @db.Decimal(10, 2)

  // Verknüpfung zu Buchungen
  invoiceEntryId String? // Buchung bei Rechnungsstellung
  paymentEntryId String? // Buchung bei Zahlungseingang

  // Notizen
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
  @@map("accounts_receivable")
}

enum ReceivableStatus {
  OPEN // Offen
  PARTIALLY_PAID // Teilweise bezahlt
  PAID // Vollständig bezahlt
  OVERDUE // Überfällig
  WRITTEN_OFF // Abgeschrieben (uneinbringlich)
}

model AccountsPayable {
  id            String  @id @default(cuid())
  invoiceNumber String // Lieferantenrechnungsnummer
  vendorName    String
  vendorId      String? // Optional: Verknüpfung

  // Betrag
  amount    Decimal  @db.Decimal(10, 2)
  netAmount Decimal? @db.Decimal(10, 2)
  vatAmount Decimal? @db.Decimal(10, 2)
  vatRate   Int?     @default(19)

  // Datum
  invoiceDate DateTime
  dueDate     DateTime
  paidAt      DateTime?

  // Status
  status PayableStatus @default(OPEN)

  // Zahlung
  paidAmount Decimal? @db.Decimal(10, 2)

  // Verknüpfung zu Buchungen
  invoiceEntryId String? // Buchung bei Rechnungserhalt
  paymentEntryId String? // Buchung bei Zahlung

  // Kategorie
  category String? // z.B. "Marketing", "IT", "Bürobedarf"

  // Notizen
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
  @@map("accounts_payable")
}

enum PayableStatus {
  OPEN // Offen
  PARTIALLY_PAID // Teilweise bezahlt
  PAID // Vollständig bezahlt
  OVERDUE // Überfällig
}

// Rechnungsabgrenzungsposten (RAP)
model DeferredItem {
  id   String       @id @default(cuid())
  type DeferredType

  // Details
  description String
  amount      Decimal @db.Decimal(10, 2)

  // Zeitraum
  startDate DateTime // Beginn der Periode
  endDate   DateTime // Ende der Periode

  // Buchungsjahr
  fiscalYear Int

  // Verknüpfung
  entryId String? // Ursprüngliche Buchung

  // Status
  released   Boolean   @default(false)
  releasedAt DateTime?

  // Notizen
  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fiscalYear, type])
  @@index([released])
  @@map("deferred_items")
}

enum DeferredType {
  ARAP // Aktive Rechnungsabgrenzung (Vorausgezahlte Ausgaben)
  PRAP // Passive Rechnungsabgrenzung (Voraus erhaltene Einnahmen)
}

// Eigenkapital-Entwicklung
model EquityMovement {
  id   String             @id @default(cuid())
  year Int
  type EquityMovementType

  // Betrag
  amount      Decimal @db.Decimal(10, 2)
  description String

  // Datum
  date DateTime

  // Verknüpfung
  entryId String? // Buchung

  // Details
  details String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([year, type])
  @@index([date])
  @@map("equity_movements")
}

enum EquityMovementType {
  CAPITAL_INCREASE // Kapitalerhöhung
  CAPITAL_DECREASE // Kapitalherabsetzung
  PROFIT_DISTRIBUTION // Gewinnausschüttung
  PROFIT_RETENTION // Gewinnvortrag
  WITHDRAWAL // Privatentnahme (bei Personengesellschaft)
  CONTRIBUTION // Privateinlage (bei Personengesellschaft)
}

// ============================================
// COMPANY SETTINGS
// ============================================

model CompanySettings {
  id String @id @default(cuid())

  // Company Info
  companyName    String  @default("Bereifung24 GmbH")
  companyAddress String?
  companyPhone   String?
  companyEmail   String?
  taxNumber      String?
  vatNumber      String?

  // Accountant Contact
  accountantName      String?
  accountantEmail     String?
  accountantCompany   String?
  accountantAddress   String?
  accountantPhone     String?
  accountantTaxNumber String?

  // SMTP Settings (for email sending)
  smtpHost     String?
  smtpPort     String?
  smtpUser     String?
  smtpPassword String?
  smtpFrom     String?
  smtpSecure   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_settings")
}

// ============================================
// HR MANAGEMENT SYSTEM - ENUMS
// ============================================

enum WorkTimeModel {
  FULLTIME_40H // Vollzeit 40h
  FULLTIME_37_5H // Vollzeit 37,5h
  FULLTIME_35H // Vollzeit 35h
  PARTTIME_30H // Teilzeit 30h (75%)
  PARTTIME_25H // Teilzeit 25h (62,5%)
  PARTTIME_20H // Teilzeit 20h (50%)
  PARTTIME_15H // Teilzeit 15h (37,5%)
  MINIJOB_603 // Minijob 603€ (Stand 2026)
  SHORTTERM_EMPLOYMENT // Kurzfristige Beschäftigung
  FLEXTIME // Gleitzeit
  TRUST_BASED // Vertrauensarbeitszeit
  SHIFT_WORK // Schichtarbeit
  CUSTOM // Benutzerdefiniert
}

enum EmploymentType {
  PERMANENT // Unbefristet
  TEMPORARY // Befristet
  INTERN // Praktikum
  APPRENTICE // Ausbildung
  FREELANCE // Freiberufler
  MINIJOB // Geringfügig beschäftigt
  SHORTTERM // Kurzfristig beschäftigt
}

enum SalaryType {
  MONTHLY // Monatsgehalt
  HOURLY // Stundenlohn
  ANNUAL // Jahresgehalt (bei Führungskräften)
}

enum TaxClass {
  CLASS_I // Steuerklasse I
  CLASS_II // Steuerklasse II (Alleinerziehend)
  CLASS_III // Steuerklasse III
  CLASS_IV // Steuerklasse IV
  CLASS_V // Steuerklasse V
  CLASS_VI // Steuerklasse VI (Zweitjob)
}

enum Religion {
  NONE // Keine (-)
  CATHOLIC // Römisch-Katholisch (rk)
  PROTESTANT // Evangelisch (ev)
  OTHER // Andere
}

enum PayrollStatus {
  DRAFT // Entwurf (automatisch erstellt)
  REVIEW // In Prüfung
  APPROVED // Genehmigt
  PAID // Ausgezahlt
  CANCELLED // Storniert
}

enum ApprovalStatus {
  PENDING // Wartend
  APPROVED // Genehmigt
  REJECTED // Abgelehnt
  CANCELLED // Storniert
}

enum JobApplicationStatus {
  NEW // Neu
  REVIEWED // Geprüft
  INVITED // Eingeladen
  REJECTED // Abgelehnt
  HIRED // Eingestellt
}

enum EmployeeStatus {
  DRAFT // Entwurf (aus Bewerbung erstellt, muss von HR vervollständigt werden)
  ACTIVE // Aktiv (vollständig eingerichtet)
  PROBATION // Probezeit
  TERMINATED // Beendet
}

// ============================================
// HR MANAGEMENT - PAYROLL (ERWEITERT)
// ============================================

model Payroll {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation("EmployeePayrollReceived", fields: [employeeId], references: [id], onDelete: Cascade)

  // Abrechnungszeitraum
  month       Int // 1-12
  year        Int
  periodStart DateTime // 01.12.2025
  periodEnd   DateTime // 31.12.2025

  // Arbeitstage
  workDaysInMonth     Int // z.B. 21 Tage
  calendarDaysInMonth Int // z.B. 31 Tage

  // ============================================
  // BRUTTO-ENTGELT
  // ============================================
  baseSalary Decimal // Grundgehalt (Monatsgehalt oder Stundenlohn × Stunden)

  // Stundenlohn-spezifisch
  workedHours Float? // Geleistete Stunden
  hourlyRate  Decimal? // Stundensatz

  // Zuschläge (steuerpflichtig)
  overtimePay    Decimal @default(0) // Überstunden-Vergütung
  bonusPayment   Decimal @default(0) // Bonuszahlungen
  christmasBonus Decimal @default(0) // Weihnachtsgeld
  vacationBonus  Decimal @default(0) // Urlaubsgeld

  // Zuschläge (steuerfrei nach § 3b EStG)
  nightWorkBonus   Decimal @default(0) // Nachtzuschlag (25%)
  sundayWorkBonus  Decimal @default(0) // Sonntagszuschlag (50%)
  holidayWorkBonus Decimal @default(0) // Feiertagszuschlag (125%)

  // Sonstige Bezüge
  travelAllowance Decimal @default(0) // Fahrtkostenzuschuss (steuerfrei bis 100€)
  vwl             Decimal @default(0) // Vermögenswirksame Leistungen (AG-Anteil)
  childBenefit    Decimal @default(0) // Kindergeldzuschlag

  grossTotal Decimal // Brutto-Gesamt

  // ============================================
  // SOZIALVERSICHERUNG (Arbeitnehmer-Anteil)
  // ============================================
  healthInsurance       Decimal // KV (7,3%)
  healthInsuranceExtra  Decimal // KV-Zusatzbeitrag (Ø 1,7%)
  nursingInsurance      Decimal // PV (1,7% + 0,6% wenn kinderlos)
  pensionInsurance      Decimal // RV (9,3%)
  unemploymentInsurance Decimal // ALV (1,3%)

  totalSocialSecurity Decimal // Gesamt SV (AN)

  // ============================================
  // SOZIALVERSICHERUNG (Arbeitgeber-Anteil)
  // ============================================
  employerHealthInsurance       Decimal // AG-Anteil KV (7,3%)
  employerHealthInsuranceExtra  Decimal // AG-Anteil KV-Zusatz (0,85%)
  employerNursingInsurance      Decimal // AG-Anteil PV (1,7%)
  employerPensionInsurance      Decimal // AG-Anteil RV (9,3%)
  employerUnemploymentInsurance Decimal // AG-Anteil ALV (1,3%)

  // Umlagen
  u1Levy Decimal @default(0) // U1-Umlage Krankheit (1,5%)
  u2Levy Decimal @default(0) // U2-Umlage Mutterschaft (0,3%)
  u3Levy Decimal @default(0) // U3-Umlage Insolvenz (0,1%)
  bgLevy Decimal @default(0) // Berufsgenossenschaft (ca. 1%)

  totalEmployerCosts Decimal // AG-Gesamtkosten

  // ============================================
  // STEUERN
  // ============================================
  taxableIncome Decimal // Steuerpflichtiges Einkommen
  incomeTax     Decimal // Lohnsteuer
  solidarityTax Decimal // Solidaritätszuschlag (5,5%)
  churchTax     Decimal // Kirchensteuer (8-9%)

  totalTax Decimal // Gesamt Steuern

  // ============================================
  // NETTOLOHN
  // ============================================
  netSalary Decimal // Auszahlungsbetrag

  // ============================================
  // ABWESENHEITEN
  // ============================================
  vacationDays  Int   @default(0) // Urlaubstage im Monat
  sickDays      Int   @default(0) // Kranktage im Monat
  overtimeHours Float @default(0) // Überstunden diesen Monat

  // ============================================
  // STATUS & WORKFLOW
  // ============================================
  status PayrollStatus @default(DRAFT)

  generatedAt DateTime @default(now()) // Automatisch erstellt am

  reviewedById String?
  reviewedBy   B24Employee? @relation("PayrollReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewedAt   DateTime?

  approvedById String?
  approvedBy   B24Employee? @relation("PayrollApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt   DateTime?

  paidAt       DateTime? // Auszahlung erfolgt am
  transferDate DateTime? // Überweisungsdatum

  // ============================================
  // DOKUMENT
  // ============================================
  pdfUrl         String? // Link zur Gehaltsabrechnung-PDF
  sentToEmployee Boolean   @default(false) // Per E-Mail versendet
  sentAt         DateTime?

  // ============================================
  // BUCHHALTUNGS-INTEGRATION
  // ============================================
  accountingEntryId String? @unique // Verknüpfung zu AccountingEntry

  // ============================================
  // NOTIZEN
  // ============================================
  internalNotes String? @db.Text // Interne Notizen (nicht auf PDF)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, month, year])
  @@index([status])
  @@index([month, year])
  @@map("payrolls")
}

// ============================================
// ARBEITSZEIT-KONFIGURATION
// ============================================

model WorkTimeConfiguration {
  id          String        @id @default(cuid())
  model       WorkTimeModel
  name        String // z.B. "Vollzeit 40h", "Teilzeit 20h"
  description String? // Beschreibung

  // Zeiten
  weeklyHours     Float // z.B. 40.0, 20.0
  monthlyHours    Float // Berechnet: weeklyHours × 52 ÷ 12
  dailyHours      Float? // z.B. 8.0
  workDaysPerWeek Int? // z.B. 5

  // Standard-Arbeitszeiten
  defaultStartTime String? // z.B. "08:00"
  defaultEndTime   String? // z.B. "17:00"

  // Urlaubsanspruch
  defaultVacationDays Int @default(30)

  // Sozialversicherungspflichtig
  socialSecurityRequired Boolean @default(true)

  // Aktiv/Inaktiv
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_time_configurations")
}

// ============================================
// STELLENAUSSCHREIBUNGEN
// ============================================

model JobPosting {
  id         String @id @default(cuid())
  title      String // "Backend Developer"
  department String // "IT"
  position   String // "Backend Developer"

  description  String   @db.Text // HTML/Markdown
  requirements String[] // Array von Anforderungen
  benefits     String[] // Array von Benefits

  workTimeModel WorkTimeModel @map("work_time_model")
  weeklyHours   Float?        @map("weekly_hours")
  salaryMin     Decimal?      @map("salary_min")
  salaryMax     Decimal?      @map("salary_max")
  remoteAllowed Boolean       @default(false) @map("remote_allowed")

  applicationDeadline DateTime? @map("application_deadline")

  // Sichtbarkeit
  isActive    Boolean   @default(true) @map("is_active")
  isPublic    Boolean   @default(true) @map("is_public") // Auf Startseite sichtbar
  publishedAt DateTime? @map("published_at")

  // Relations
  applications JobApplication[]

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("JobPostingCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("job_postings")
}

// ============================================
// BEWERBUNGEN
// ============================================

model JobApplication {
  id           String     @id @default(cuid())
  jobPostingId String     @map("job_posting_id")
  jobPosting   JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)

  // Bewerber
  firstName String @map("first_name")
  lastName  String @map("last_name")
  email     String
  phone     String?

  // Dokumente
  cvUrl           String  @map("cv_url") // PDF/DOCX
  coverLetterText String? @map("cover_letter_text") @db.Text

  // Status
  status          JobApplicationStatus @default(NEW)
  reviewedById    String?              @map("reviewed_by_id")
  reviewedBy      B24Employee?         @relation("ApplicationReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewedAt      DateTime?            @map("reviewed_at")
  rejectionReason String?              @map("rejection_reason") @db.Text

  // Notizen
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("job_applications")
}

// ============================================
// GENEHMIGUNGS-WORKFLOW
// ============================================

model ApprovalWorkflow {
  id       String @id @default(cuid())
  type     String // "leave_request", "sick_leave", "expense", "payroll"
  entityId String // ID des betreffenden Datensatzes

  requesterId String
  requester   B24Employee @relation("WorkflowRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  currentApproverId String?
  currentApprover   B24Employee? @relation("WorkflowApprover", fields: [currentApproverId], references: [id], onDelete: SetNull)

  status          ApprovalStatus @default(PENDING)
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  steps ApprovalStep[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("approval_workflows")
}

model ApprovalStep {
  id         String           @id @default(cuid())
  workflowId String
  workflow   ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  stepOrder  Int // 1, 2, 3...
  approverId String
  approver   B24Employee @relation(fields: [approverId], references: [id])

  status     ApprovalStatus @default(PENDING)
  approvedAt DateTime?
  rejectedAt DateTime?
  comment    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("approval_steps")
}

// ============================================
// ROADMAP & TASK MANAGEMENT
// ============================================

model RoadmapPhase {
  id          String   @id @default(cuid())
  name        String   // "Phase 1: Pre-Gründung"
  description String?  @db.Text
  startMonth  String   // "2026-01"
  endMonth    String   // "2026-02"
  order       Int      // 1, 2, 3 für Sortierung
  color       String   @default("#3B82F6") // Phasen-Farbe
  isActive    Boolean  @default(true)

  tasks RoadmapTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("roadmap_phases")
}

model RoadmapTask {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  priority    RoadmapTaskPriority // P0, P1, P2, P3
  status      RoadmapTaskStatus   @default(NOT_STARTED)

  // Zuordnung
  assignedToId String?
  assignedTo   B24Employee? @relation("RoadmapTaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  phaseId      String
  phase        RoadmapPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  // Timing
  month    String    // "2026-01"
  dueDate  DateTime?
  startDate DateTime?

  // Organisation
  category String?  // "Finance", "Marketing", "Product", "Operations"
  tags     String[] // ["Förderung", "Launch", "Critical"]
  order    Int      @default(0) // Manuelle Sortierung innerhalb Monat

  // Tracking
  completedAt   DateTime?
  completedById String?
  completedBy   B24Employee? @relation("RoadmapTaskCompleter", fields: [completedById], references: [id], onDelete: SetNull)
  blockedReason String?      @db.Text // Wenn Status = BLOCKED

  // Notes & Comments
  notes String? @db.Text

  // Hilfe anbieten (Helpers who can assist)
  helpOffers RoadmapTaskHelpOffer[]

  createdById String
  createdBy   B24Employee @relation("RoadmapTaskCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assignedToId])
  @@index([phaseId])
  @@index([month])
  @@index([status])
  @@index([priority])
  @@map("roadmap_tasks")
}

// Mitarbeiter können Hilfe bei Tasks anbieten
model RoadmapTaskHelpOffer {
  id       String   @id @default(cuid())
  taskId   String
  task     RoadmapTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  helperId String
  helper   B24Employee @relation("RoadmapTaskHelper", fields: [helperId], references: [id], onDelete: Cascade)
  message  String?     @db.Text // Optional: "Ich kann bei der API-Integration helfen"
  
  status    String   @default("OFFERED") // OFFERED, ACCEPTED, DECLINED
  acceptedAt DateTime?
  
  createdAt DateTime @default(now())

  @@unique([taskId, helperId]) // Ein Mitarbeiter kann nur einmal Hilfe anbieten
  @@map("roadmap_task_help_offers")
}

enum RoadmapTaskPriority {
  P0 // 🔴 Critical - Blockiert andere Tasks, sofort erledigen
  P1 // 🟡 High - Wichtig für Erfolg, zeitnah erledigen
  P2 // 🟢 Medium - Wichtig, aber flexibel
  P3 // 🔵 Low - Nice-to-have
}

enum RoadmapTaskStatus {
  NOT_STARTED  // Noch nicht begonnen
  IN_PROGRESS  // Aktuell in Bearbeitung
  COMPLETED    // Abgeschlossen
  BLOCKED      // Blockiert (mit Grund in blockedReason)
}

// ============================================================================
// COMMISSION INVOICING SYSTEM
// ============================================================================

// Provisionsrechnungen für Werkstätten
model CommissionInvoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique // B24-INV-2026-0001
  
  // Werkstatt
  workshopId      String
  workshop        Workshop @relation("WorkshopInvoices", fields: [workshopId], references: [id], onDelete: Cascade)
  
  // Rechnungszeitraum (Vormonat)
  periodStart     DateTime // 01.01.2026
  periodEnd       DateTime // 31.01.2026
  
  // Positionen (JSON Array)
  // [{
  //   position: 1,
  //   description: "Reifen mit Montage",
  //   quantity: 12,
  //   unitPrice: 25.00,
  //   total: 300.00,
  //   vatRate: 19
  // }, ...]
  lineItems       Json
  
  // Beträge
  subtotal        Float    // Netto-Summe
  vatAmount       Float    // MwSt-Betrag (19%)
  totalAmount     Float    // Brutto-Summe
  
  // Status
  status          String   @default("DRAFT") // DRAFT, SENT, PAID, OVERDUE, CANCELLED
  sentAt          DateTime? // Wann Email versendet wurde
  emailSent       Boolean  @default(false) // Email erfolgreich versendet
  paidAt          DateTime? // Wann bezahlt wurde
  dueDate         DateTime? // Zahlungsziel (bei SEPA-Fehler: +14 Tage)
  
  // PDF
  pdfUrl          String?  // Pfad zum generierten PDF
  
  // Referenzen
  commissionIds   String[] // IDs der einbezogenen Commission-Einträge
  sepaPaymentId   String?  // GoCardless Payment ID
  sepaStatus      String?  // pending_submission, submitted, confirmed, paid_out, cancelled, failed
  
  // Buchhaltung
  accountingEntryId String? @unique // Verknüpfung zu AccountingEntry (Buchungssatz)
  accountingEntry   AccountingEntry? @relation("InvoiceAccountingEntry", fields: [accountingEntryId], references: [id])
  
  // Metadaten
  createdAt       DateTime @default(now())
  createdBy       String?  // B24Employee ID
  updatedAt       DateTime @updatedAt
  notes           String?  @db.Text // Interne Notizen
  
  @@index([workshopId])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@index([invoiceNumber])
  @@map("commission_invoices")
}

// Einstellungen für Rechnungsgenerierung
model InvoiceSettings {
  id                  String   @id @default(cuid())
  
  // Rechnungsnummer
  currentNumber       Int      @default(1) // Fortlaufende Nummer
  prefix              String   @default("B24-INV") // Präfix für Rechnungsnummer
  
  // Bereifung24 GmbH Firmendaten
  companyName         String   @default("Bereifung24 GmbH")
  companyStreet       String?  // z.B. "Musterstraße 123"
  companyZip          String?  // z.B. "10115"
  companyCity         String?  // z.B. "Berlin"
  companyCountry      String   @default("Deutschland")
  
  // Steuerdaten
  taxId               String?  // USt-IdNr. (z.B. DE123456789)
  taxNumber           String?  // Steuernummer
  
  // Handelsregister
  registerCourt       String?  // z.B. "Amtsgericht Berlin"
  registerNumber      String?  // z.B. "HRB 12345"
  managingDirector    String?  // Geschäftsführer
  
  // Kontakt
  email               String?  // buchhaltung@bereifung24.de
  phone               String?
  website             String   @default("www.bereifung24.de")
  
  // Email-Zugangsdaten für Rechnungsversand
  invoiceEmail        String?  // Email-Adresse für Rechnungsversand (z.B. buchhaltung@bereifung24.de)
  invoicePassword     String?  // Passwort für Rechnungsversand (verschlüsselt)
  
  // Banking
  bankName            String?  // z.B. "Deutsche Bank"
  iban                String?  // z.B. "DE89370400440532013000"
  bic                 String?  // z.B. "COBADEFFXXX"
  
  // GoCardless
  gocardlessCreditorId String? // Gläubiger-ID für SEPA
  
  // Logo
  logoUrl             String?  // Pfad zum hochgeladenen Logo
  
  // Template (Optional: Custom HTML)
  templateHtml        String?  @db.Text
  
  // Footer-Text
  footerText          String?  @db.Text // Kleingedrucktes
  
  // Metadaten
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("invoice_settings")
}

// ============================================
// BLOG SYSTEM
// ============================================

model BlogPost {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String
  excerpt         String?  @db.Text
  content         String   @db.Text
  featuredImage   String?
  imageAlt        String?
  
  // SEO Fields
  metaTitle       String?
  metaDescription String?  @db.Text
  keywords        String[]
  canonicalUrl    String?
  focusKeyword    String?
  
  // Organization
  category        BlogCategory @relation(fields: [categoryId], references: [id])
  categoryId      String
  tags            BlogTag[]    @relation("BlogPostToTag")
  targetAudience  BlogAudience // CUSTOMER | WORKSHOP | BOTH
  
  // Publishing
  status          BlogStatus   // DRAFT | REVIEW | PUBLISHED | ARCHIVED
  author          B24Employee  @relation("AuthoredPosts", fields: [authorId], references: [id])
  authorId        String
  reviewer        B24Employee? @relation("ReviewedPosts", fields: [reviewerId], references: [id])
  reviewerId      String?
  reviewedAt      DateTime?
  publishedAt     DateTime?
  scheduledFor    DateTime?
  archivedAt      DateTime?
  
  // Analytics
  views           Int          @default(0)
  readTime        Int?         // Minuten
  seoScore        Int?         // 0-100
  
  // Related Content
  relatedPosts    BlogPost[]   @relation("RelatedPosts")
  relatedTo       BlogPost[]   @relation("RelatedPosts")
  
  // Relations
  blogViews       BlogView[]
  revisions       BlogPostRevision[]
  
  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([slug])
  @@index([status, publishedAt])
  @@index([categoryId])
  @@index([targetAudience])
  @@index([authorId])
  @@map("blog_posts")
}

model BlogCategory {
  id              String     @id @default(cuid())
  slug            String     @unique
  name            String
  description     String?    @db.Text
  icon            String?    // Emoji oder Lucide Icon Name
  color           String?    // Hex-Code für UI
  parentId        String?    // Für Sub-Kategorien
  
  // SEO
  seoTitle        String?
  seoDescription  String?    @db.Text
  
  // Relations
  posts           BlogPost[]
  parent          BlogCategory?  @relation("SubCategories", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children        BlogCategory[] @relation("SubCategories")
  
  // Ordering
  sortOrder       Int        @default(0)
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([slug])
  @@index([parentId])
  @@map("blog_categories")
}

model BlogTag {
  id         String     @id @default(cuid())
  slug       String     @unique
  name       String
  posts      BlogPost[] @relation("BlogPostToTag")
  usageCount Int        @default(0) // Für Popular Tags
  
  createdAt  DateTime   @default(now())
  
  @@index([slug])
  @@index([usageCount])
  @@map("blog_tags")
}

model BlogView {
  id          String   @id @default(cuid())
  postId      String
  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // Analytics
  ipAddress   String?
  userAgent   String?
  referer     String?
  country     String?
  city        String?
  
  viewedAt    DateTime @default(now())
  
  @@index([postId])
  @@index([viewedAt])
  @@map("blog_views")
}

model BlogPostRevision {
  id         String   @id @default(cuid())
  postId     String
  post       BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // Snapshot of post data
  title      String
  content    String   @db.Text
  excerpt    String?  @db.Text
  
  // Who made this revision
  authorId   String
  author     B24Employee @relation("PostRevisions", fields: [authorId], references: [id])
  
  // Change note
  changeNote String?  @db.Text
  
  createdAt  DateTime @default(now())
  
  @@index([postId])
  @@index([createdAt])
  @@map("blog_post_revisions")
}

enum BlogStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum BlogAudience {
  CUSTOMER
  WORKSHOP
  BOTH
}
