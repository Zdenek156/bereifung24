// This is your Prisma schema file
// Bereifung24 Platform - Kunden-Werkstatt-Vermittlung
// PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ADMIN NOTIFICATIONS
// ============================================

model AdminNotificationSetting {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?

  // Notification Types
  notifyCustomerRegistration Boolean @default(true) // Benachrichtigung bei Kunden-Registrierung
  notifyWorkshopRegistration Boolean @default(true) // Benachrichtigung bei Werkstatt-Registrierung

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_notification_settings")
}

// ============================================
// ADMIN API SETTINGS
// ============================================

model AdminApiSetting {
  id          String  @id @default(cuid())
  key         String  @unique // e.g., "GOCARDLESS_ACCESS_TOKEN", "GOOGLE_OAUTH_CLIENT_ID"
  value       String? // The actual API key/secret (encrypted in production)
  description String? // What this key is for

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_api_settings")
}

// ============================================
// EMAIL TEMPLATES
// ============================================

model EmailTemplate {
  id          String  @id @default(cuid())
  key         String  @unique // e.g., "BOOKING_CONFIRMATION_CUSTOMER", "BOOKING_CONFIRMATION_WORKSHOP"
  name        String // Display name: "Terminbestätigung - Kunde"
  description String? // What this template is used for
  subject     String // Email subject line with placeholders
  htmlContent String  @db.Text // HTML email content with placeholders

  // Placeholders documentation (JSON array of available placeholders)
  placeholders String @db.Text // JSON: [{"key": "customerName", "description": "Name des Kunden"}]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id       String @id @default(cuid())
  email    String @unique
  password String
  role     String @default("CUSTOMER") // CUSTOMER, WORKSHOP, ADMIN

  // Profile
  firstName String
  lastName  String
  phone     String?
  street    String?
  zipCode   String?
  city      String?
  latitude  Float?
  longitude Float?

  // Customer Type (for billing)
  customerType String? @default("PRIVATE") // PRIVATE, BUSINESS
  companyName  String?
  taxId        String? // Steuernummer/USt-IdNr for business customers

  // Verification
  emailVerified DateTime?
  isActive      Boolean   @default(true)

  // OAuth
  googleId String? @unique

  // Password Reset
  resetToken       String?
  resetTokenExpiry DateTime?

  // Email Verification
  verificationToken String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations based on role
  customer Customer?
  workshop Workshop?

  @@map("users")
}

// ============================================
// CUSTOMER
// ============================================

model Customer {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email Notifications
  emailNotifyOffers Boolean @default(true) // Benachrichtigung bei neuen Angeboten

  // Relations
  tireRequests TireRequest[]
  bookings     Booking[]
  reviews      Review[]
  tireRatings  TireRating[]
  vehicles     Vehicle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

// ============================================
// WORKSHOP
// ============================================

model Workshop {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business Info
  customerNumber String  @unique @map("customer_number") // Eindeutige Kundennummer (z.B. KD-20231219-001)
  companyName    String
  taxId          String?
  website        String?
  description    String?
  logoUrl        String? // Workshop Logo URL
  taxMode        String  @default("STANDARD") // STANDARD (inkl. MwSt.), KLEINUNTERNEHMER (§19 UStG)

  // Opening Hours (JSON String)
  openingHours String? // JSON: {"monday": "09:00-18:00", ...}

  // Verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Banking (SEPA)
  iban            String?
  accountHolder   String?
  sepaMandateRef  String?   @unique // B24-timestamp-random
  sepaMandateDate DateTime?

  // PayPal
  paypalEmail String?

  // GoCardless Integration
  gocardlessCustomerId       String?   @unique // GoCardless Customer ID
  gocardlessMandateId        String?   @unique // GoCardless Mandate ID
  gocardlessMandateStatus    String? // pending_submission, submitted, active, cancelled, failed, expired
  gocardlessMandateRef       String?   @unique // Eindeutige Mandate Reference
  gocardlessMandateCreatedAt DateTime?
  gocardlessBankAccountId    String? // GoCardless Bank Account ID
  gocardlessSessionToken     String?   @map("gocardless_session_token") // Temporary session token for redirect flow
  gocardlessRedirectFlowId   String?   @map("gocardless_redirect_flow_id") // Temporary redirect flow ID

  // Payment Methods (JSON String)
  paymentMethods String? @map("paymentmethods") // JSON: {"cash": true, "bankTransfer": true, ...}

  // Email Notifications
  emailNotifyRequests      Boolean @default(true) @map("email_notify_requests") // Benachrichtigung bei neuen Anfragen im Umkreis
  emailNotifyOfferAccepted Boolean @default(true) @map("email_notify_offer_accepted") // Benachrichtigung wenn Angebot angenommen wurde
  emailNotifyBookings      Boolean @default(true) @map("email_notify_bookings") // Benachrichtigung bei neuen Terminbuchungen
  emailNotifyReviews       Boolean @default(true) @map("email_notify_reviews") // Benachrichtigung bei neuen Bewertungen
  emailNotifyReminders     Boolean @default(true) @map("email_notify_reminders") // Terminserinnerungen
  emailNotifyCommissions   Boolean @default(true) @map("email_notify_commissions") // Monatliche Provisionsabrechnungen

  // Calendar Integration
  calendarMode       String?   @default("workshop") @map("calendarmode") // "workshop" or "employees"
  googleCalendarId   String?   @map("googlecalendarid") // For workshop mode
  googleAccessToken  String?   @map("googleaccesstoken")
  googleRefreshToken String?   @map("googlerefreshtoken")
  googleTokenExpiry  DateTime? @map("googletokenexpiry")

  // Bereifung24 Employee Assignment
  assignedEmployeeId String?      @map("assigned_employee_id")
  assignedEmployee   B24Employee? @relation("WorkshopAssignment", fields: [assignedEmployeeId], references: [id])

  // Relations
  offers            Offer[]
  bookings          Booking[]
  reviews           Review[]
  commissions       Commission[]
  employees         Employee[]
  workshopVacations WorkshopVacation[]
  workshopServices  WorkshopService[]
  pricingSettings   PricingSettings?
  landingPage       WorkshopLandingPage?
  crmData           WorkshopCRM?

  // Sales CRM - Converted from Prospect
  prospectSource ProspectWorkshop? @relation("ConvertedFromProspect")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workshops")
}

model PricingSettings {
  id         String   @id @default(cuid())
  workshopId String   @unique @map("workshop_id")
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Auto Reifen
  autoManualPricing Boolean @default(true) @map("auto_manual_pricing")
  autoFixedMarkup   Float   @default(0) @map("auto_fixed_markup")
  autoPercentMarkup Float   @default(0) @map("auto_percent_markup")
  autoIncludeVat    Boolean @default(false) @map("auto_include_vat")

  // Motorrad Reifen
  motoManualPricing Boolean @default(true) @map("moto_manual_pricing")
  motoFixedMarkup   Float   @default(0) @map("moto_fixed_markup")
  motoPercentMarkup Float   @default(0) @map("moto_percent_markup")
  motoIncludeVat    Boolean @default(false) @map("moto_include_vat")

  // Batterie-Service
  batteryManualPricing Boolean @default(true) @map("battery_manual_pricing")
  batteryFixedMarkup   Float   @default(0) @map("battery_fixed_markup")
  batteryPercentMarkup Float   @default(0) @map("battery_percent_markup")
  batteryIncludeVat    Boolean @default(false) @map("battery_include_vat")

  // Bremsen-Service
  brakeManualPricing Boolean @default(true) @map("brake_manual_pricing")
  brakeFixedMarkup   Float   @default(0) @map("brake_fixed_markup")
  brakePercentMarkup Float   @default(0) @map("brake_percent_markup")
  brakeIncludeVat    Boolean @default(false) @map("brake_include_vat")

  // Andere Services
  serviceManualPricing Boolean @default(true) @map("service_manual_pricing")
  serviceFixedMarkup   Float   @default(0) @map("service_fixed_markup")
  servicePercentMarkup Float   @default(0) @map("service_percent_markup")
  serviceIncludeVat    Boolean @default(false) @map("service_include_vat")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("pricing_settings")
}

model Employee {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  name  String
  email String

  // Google Calendar Integration
  googleCalendarId   String?
  googleAccessToken  String?
  googleRefreshToken String?
  googleTokenExpiry  DateTime?

  // Working Hours (JSON String)
  workingHours String? // JSON: {"monday": {"from": "08:00", "to": "17:00", "working": true}, ...}

  // Relations
  bookings          Booking[]
  employeeVacations EmployeeVacation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employees")
}

// ============================================
// TIRE REQUEST
// ============================================

model TireRequest {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  vehicleId  String?
  vehicle    Vehicle? @relation(fields: [vehicleId], references: [id])

  // Tire Specifications
  season      String // SUMMER, WINTER, ALL_SEASON
  width       Int
  aspectRatio Int
  diameter    Int
  loadIndex   Int?
  speedRating String?
  isRunflat   Boolean @default(false)
  quantity    Int     @default(4)

  // Preferences
  preferredBrands String? // Comma-separated brands
  specificBrand   String?
  additionalNotes String?

  // Motorcycle specific
  mountOnMotorcycle Boolean @default(false) @map("mount_on_motorcycle") // For motorcycle tire requests: true = mount on whole motorcycle, false = wheels only (default)

  // Location
  zipCode   String
  city      String?
  radiusKm  Int     @default(25)
  latitude  Float?
  longitude Float?

  // Timing
  needByDate DateTime

  // Status
  status String @default("PENDING") // PENDING, QUOTED, ACCEPTED, COMPLETED, CANCELLED

  // Relations
  offers  Offer[]
  booking Booking?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tire_requests")
}

// ============================================
// VEHICLE MANAGEMENT
// ============================================

model Vehicle {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Vehicle Details
  vehicleType  String  @default("CAR") // CAR, MOTORCYCLE, TRAILER
  make         String
  model        String
  year         Int
  licensePlate String?
  vin          String? @unique

  // TÜV (Technical Inspection)
  nextInspectionDate     DateTime?
  inspectionReminder     Boolean   @default(false)
  inspectionReminderDays Int?      @default(30) // Days before inspection to send reminder

  // Tire Sizes (stored as JSON)
  summerTires    String? // JSON string with tire dimensions
  winterTires    String? // JSON string with tire dimensions
  allSeasonTires String? // JSON string with tire dimensions

  // Current Tires
  currentTires VehicleTire[]
  tireHistory  TireHistory[]
  tireRequests TireRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vehicles")
}

model VehicleTire {
  id        String  @id @default(cuid())
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  // Tire Specs
  position    String // FRONT_LEFT, FRONT_RIGHT, REAR_LEFT, REAR_RIGHT
  season      String // SUMMER, WINTER, ALL_SEASON
  width       Int
  aspectRatio Int
  diameter    Int
  loadIndex   Int?
  speedRating String?
  brand       String?
  model       String?
  dotCode     String? // Herstellungsdatum

  // Condition
  treadDepth           Float?
  installedDate        DateTime?
  estimatedReplacement DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vehicle_tires")
}

model TireHistory {
  id        String  @id @default(cuid())
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id])

  // What was installed
  season      String
  width       Int
  aspectRatio Int
  diameter    Int
  brand       String?
  model       String?
  quantity    Int

  // When and where
  installedDate DateTime
  workshopName  String?
  totalCost     Float?

  notes String?

  createdAt DateTime @default(now())

  @@map("tire_history")
}

// ============================================
// OFFER
// ============================================

model Offer {
  id            String      @id @default(cuid())
  tireRequestId String
  tireRequest   TireRequest @relation(fields: [tireRequestId], references: [id])
  workshopId    String
  workshop      Workshop    @relation(fields: [workshopId], references: [id])

  // Tire Details (for compatibility with existing offers)
  tireBrand   String
  tireModel   String
  description String?

  // Multiple tire options (for new offers)
  tireOptions TireOption[]

  // Pricing
  price              Float // Total price (for compatibility)
  pricePerTire       Float?
  installationFee    Float?
  durationMinutes    Int? // Geschätzte Dauer für den Service
  balancingPrice     Float?   @map("balancingprice") // Wuchten-Preis für Wheel Change
  storagePrice       Float?   @map("storageprice") // Einlagerung-Preis für Wheel Change
  storageAvailable   Boolean? @default(false) @map("storageavailable") // Einlagerung verfügbar
  motorcycleTireType String?  @map("motorcycle_tire_type") // FRONT, REAR, or BOTH for motorcycle offers

  // Validity
  validUntil DateTime

  // Status
  status String @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED

  // If accepted
  acceptedAt             DateTime?
  declinedAt             DateTime? @map("declined_at")
  customerWantsBalancing Boolean?  @default(false) @map("customer_wants_balancing")
  customerWantsStorage   Boolean?  @default(false) @map("customer_wants_storage")
  selectedTireOptionIds  String[]  @default([]) @map("selected_tire_option_ids") // IDs der vom Kunden ausgewählten TireOptions
  booking                Booking?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("offers")
}

model TireOption {
  id      String @id @default(cuid())
  offerId String @map("offer_id")
  offer   Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)

  brand              String
  model              String
  pricePerTire       Float   @map("price_per_tire")
  montagePrice       Float?  @map("montage_price") // Montage price for service packages (Brake, Battery, etc.)
  motorcycleTireType String? @map("motorcycle_tire_type") // FRONT, REAR, or BOTH for motorcycle tire options
  carTireType        String? @map("car_tire_type") // ALL_FOUR, FRONT_TWO, or REAR_TWO for car tire options
  description        String? // Achsen-Info für Brake Service (z.B. "Vorderachse: Nur Bremsbeläge")

  bookings Booking[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("tire_options")
}

// ============================================
// BOOKING & APPOINTMENT
// ============================================

model Booking {
  id                   String      @id @default(cuid())
  tireRequestId        String      @unique
  tireRequest          TireRequest @relation(fields: [tireRequestId], references: [id])
  customerId           String
  customer             Customer    @relation(fields: [customerId], references: [id])
  workshopId           String
  workshop             Workshop    @relation(fields: [workshopId], references: [id])
  offerId              String      @unique
  offer                Offer       @relation(fields: [offerId], references: [id])
  selectedTireOptionId String?
  selectedTireOption   TireOption? @relation(fields: [selectedTireOptionId], references: [id])

  // Appointment
  appointmentDate   DateTime
  appointmentTime   String
  estimatedDuration Int       @default(60) // Minuten
  employeeId        String?
  employee          Employee? @relation(fields: [employeeId], references: [id])
  googleEventId     String? // Google Calendar Event ID

  // Status
  status String @default("CONFIRMED") // CONFIRMED, COMPLETED, CANCELLED, NO_SHOW

  // Payment
  paymentMethod String? // PAYPAL, BANK_TRANSFER, CREDIT_CARD, ON_SITE
  paymentStatus String    @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  paidAt        DateTime?

  // Notes
  customerNotes String?
  workshopNotes String?

  // Optional services (for wheel change)
  wantsBalancing Boolean? @default(false) @map("wantsbalancing")
  wantsStorage   Boolean? @default(false) @map("wantsstorage")

  // After completion
  completedAt DateTime?
  review      Review?
  tireRating  TireRating?
  commission  Commission?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bookings")
}

// ============================================
// REVIEW & RATING
// ============================================

model Review {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id])

  // Rating
  rating  Int // 1-5 Sterne
  comment String?

  // Response
  workshopResponse String?
  respondedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}

// ============================================
// TIRE RATING (Customer's personal tire notes)
// ============================================

model TireRating {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Rating
  rating  Int // 1-5 Sterne
  comment String? // Persönliche Notizen zu den Reifen

  // Categories (optional detailed ratings)
  quietnessRating Int? // 1-5: Lautstärke
  gripRating      Int? // 1-5: Grip/Haftung
  wearRating      Int? // 1-5: Verschleiß
  comfortRating   Int? // 1-5: Komfort

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tire_ratings")
}

// ============================================
// COMMISSION TRACKING
// ============================================

model Commission {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  booking    Booking  @relation(fields: [bookingId], references: [id])
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id])

  // Amounts (Netto-Rechnung)
  orderTotal       Float // Gesamtbetrag des Auftrags (Brutto)
  commissionRate   Float @default(4.9) // Prozentsatz (4,9%)
  commissionAmount Float // Berechnete Provision (Brutto)

  // Tax Calculation (für Rechnung)
  taxRate     Float  @default(19.0) // MwSt-Satz (19%)
  taxAmount   Float? // MwSt-Betrag auf Provision
  netAmount   Float? // Provision Netto (ohne MwSt)
  grossAmount Float? // Provision Brutto (= commissionAmount)

  // Billing Period
  billingPeriodStart DateTime? // Start des Abrechnungszeitraums
  billingPeriodEnd   DateTime? // Ende des Abrechnungszeitraums
  billingMonth       Int? // Monat der Abrechnung (1-12)
  billingYear        Int? // Jahr der Abrechnung

  // Status
  status String @default("PENDING") // PENDING, BILLED, COLLECTED, FAILED, REFUNDED

  // Billing
  billedAt    DateTime?
  collectedAt DateTime?
  failedAt    DateTime? @map("failedat")

  // SEPA/GoCardless Details
  sepaReference String? // Legacy SEPA Referenz
  sepaStatus    String? // Legacy SEPA Status

  // GoCardless Integration
  gocardlessPaymentId     String?   @unique // GoCardless Payment ID
  gocardlessPaymentStatus String? // pending_submission, submitted, confirmed, paid_out, failed, cancelled
  gocardlessChargeDate    DateTime? // Geplantes Abbuchungsdatum
  gocardlessPayoutId      String? // GoCardless Payout ID (wenn ausgezahlt)

  // Invoice/Document
  invoiceNumber String?   @unique // Rechnungsnummer (z.B. RE-2024-001)
  invoiceUrl    String? // Link zur generierten PDF-Rechnung
  invoiceSentAt DateTime? // Wann wurde Rechnung versendet

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workshopId, status])
  @@index([billingMonth, billingYear])
  @@index([gocardlessPaymentId])
  @@map("commissions")
}

// ============================================
// VACATION MANAGEMENT
// ============================================

model WorkshopVacation {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String? // e.g., "Betriebsurlaub", "Feiertage", "Umbau"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workshop_vacations")
}

model EmployeeVacation {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  reason    String? // e.g., "Urlaub", "Krankheit", "Fortbildung"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("employee_vacations")
}

// ============================================
// WORKSHOP SERVICES
// ============================================

model WorkshopService {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Service Type
  serviceType String // TIRE_CHANGE, WHEEL_CHANGE, TIRE_REPAIR, MOTORCYCLE_TIRE, ALIGNMENT_BOTH, CLIMATE_SERVICE, BRAKE_SERVICE, BATTERY_SERVICE, OTHER_SERVICES

  // Pricing
  basePrice  Float // Grundpreis (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE, sonst Gesamtpreis)
  basePrice4 Float? // Preis für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)

  // Service-specific pricing
  runFlatSurcharge         Float? // Aufpreis für Runflat-Reifen (pro Reifen bei TIRE_CHANGE)
  disposalFee              Float? // Entsorgungsgebühr (pro Reifen)
  wheelSizeSurcharge       Json? // {"17": 5, "18": 10, "19": 15} - Aufpreis nach Radgröße
  balancingPrice           Float? @map("balancingprice") // Wuchten-Preis (pro Rad bei WHEEL_CHANGE)
  storagePrice             Float? @map("storageprice") // Einlagerungspreis (pro Saison bei WHEEL_CHANGE) - Optional
  refrigerantPricePer100ml Float? // Preis pro 100ml Kältemittel (nur bei CLIMATE_SERVICE)

  // Duration
  durationMinutes  Int // Dauer in Minuten (für 2 Reifen bei TIRE_CHANGE, für 1 Reifen bei MOTORCYCLE_TIRE)
  durationMinutes4 Int? // Dauer für 4 Reifen (TIRE_CHANGE) oder 2 Reifen (MOTORCYCLE_TIRE)
  balancingMinutes Int?     @map("balancingminutes") // Zusätzliche Dauer für Wuchten (pro Rad bei WHEEL_CHANGE)
  storageAvailable Boolean? @default(false) @map("storageavailable") // Einlagerung verfügbar

  // Service Packages (JSON structure for service-specific options - DEPRECATED, use ServicePackage relation instead)
  packages Json? // Legacy field - use servicePackages relation for new implementations

  // Availability
  isActive Boolean @default(true)

  // Notes
  description   String? // Beschreibung des Services
  internalNotes String? // Interne Notizen

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  servicePackages ServicePackage[]

  @@unique([workshopId, serviceType])
  @@map("workshop_services")
}

// ============================================
// SERVICE PACKAGES (for granular package management)
// ============================================

model ServicePackage {
  id                String          @id @default(cuid())
  workshopServiceId String
  workshopService   WorkshopService @relation(fields: [workshopServiceId], references: [id], onDelete: Cascade)

  // Package Type (service-specific)
  // TIRE_CHANGE: two_tires, four_tires, two_tires_disposal, four_tires_disposal
  // WHEEL_CHANGE: basic, with_balancing, with_storage, complete
  // TIRE_REPAIR: small, large, emergency
  // MOTORCYCLE_TIRE: front, rear, both
  // ALIGNMENT_BOTH: measurement_only, with_adjustment, with_adjustment_inspection
  // CLIMATE_SERVICE: check, basic, comfort, premium
  // BRAKE_SERVICE: front_pads, front_pads_discs, rear_pads, rear_pads_discs, rear_pads_discs_handbrake
  // BATTERY_SERVICE: test, replacement, premium
  // OTHER_SERVICES: rdks, valve, storage, tpms
  packageType String

  // Package Details
  name        String // Display name (e.g., "Klimacheck", "2 Reifen wechseln")
  description String? // Package description

  // Pricing & Duration
  price           Float // Price for this package
  durationMinutes Int // Duration in minutes

  // Availability
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workshopServiceId, packageType])
  @@map("service_packages")
}

// ============================================
// WORKSHOP LANDING PAGES
// ============================================

model WorkshopLandingPage {
  id         String   @id @default(cuid())
  workshopId String   @unique
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Status & URL
  isActive Boolean @default(false)
  slug     String  @unique // URL slug (e.g., "autoservice-mueller-berlin")

  // SEO
  metaTitle       String? // Max 60 chars
  metaDescription String? @db.Text // Max 160 chars
  keywords        String? // Comma-separated keywords

  // Hero Section
  heroHeadline String? // Main headline
  heroSubline  String? // Subheadline
  heroImage    String? // Hero background image URL
  ctaText      String  @default("Jetzt Anfrage stellen") // CTA button text

  // About Section
  aboutTitle String?
  aboutText  String? @db.Text

  // Images
  galleryImages String[] // Array of image URLs

  // Team Section
  showTeam    Boolean @default(false)
  teamMembers Json? // [{name, role, image, bio}]

  // Services (custom or from workshop)
  useWorkshopServices Boolean @default(true) // Use workshop's services
  customServices      Json? // Custom service list if not using workshop services

  // Features
  showLogo         Boolean @default(true)
  showReviews      Boolean @default(true)
  showMap          Boolean @default(true)
  showOpeningHours Boolean @default(true)
  showPartnerLogos Boolean @default(false)

  // Partner/Brand Logos
  partnerLogos Json? // [{name, image}]

  // FAQ Section
  showFaq  Boolean @default(false)
  faqItems Json? // [{question, answer}]

  // Social Media
  socialLinks Json? // {facebook, instagram, youtube}

  // Design & Branding
  template     String @default("modern") // modern, classic, minimal, professional
  primaryColor String @default("#2563eb") // Brand color
  accentColor  String @default("#10b981") // Accent color

  // Analytics
  viewCount    Int       @default(0)
  lastViewedAt DateTime?

  // Tracking
  lastPublishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@map("workshop_landing_pages")
}

// ============================================
// BEREIFUNG24 EMPLOYEES (Staff/Mitarbeiter)
// ============================================

model B24Employee {
  id       String  @id @default(cuid())
  email    String  @unique
  password String? // Null until they set it via email link

  // Personal Info
  firstName  String
  lastName   String
  phone      String?
  position   String? // e.g., "Account Manager", "Buchhalter", "Marketing Manager"
  department String? // e.g., "Buchhaltung", "Marketing", "Vertrieb", "Support"

  // Status
  isActive      Boolean @default(true)
  emailVerified Boolean @default(false)

  // Password Setup
  setupToken       String?   @unique // Token for initial password setup
  setupTokenExpiry DateTime? // Token expires after 24h

  // Login tracking
  lastLoginAt DateTime?

  // Relations
  permissions       B24EmployeePermission[]
  assignedWorkshops Workshop[]               @relation("WorkshopAssignment")
  activityLogs      B24EmployeeActivityLog[]

  // Sales CRM Relations
  assignedProspects   ProspectWorkshop[]    @relation("AssignedProspects")
  createdInteractions ProspectInteraction[] @relation("InteractionCreator")
  assignedTasks       ProspectTask[]        @relation("AssignedTasks")
  createdTasks        ProspectTask[]        @relation("TaskCreator")
  createdNotes        ProspectNote[]        @relation("NoteCreator")

  // KVP Relations
  submittedImprovements ImprovementSuggestion[] @relation("ImprovementSubmitter")
  assignedImprovements  ImprovementSuggestion[] @relation("ImprovementAssignee")
  improvementComments   ImprovementComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("b24_employees")
}

model B24EmployeePermission {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Which admin page/section
  resource String // e.g., "customers", "workshops", "analytics", "billing", "email-templates"

  // What they can do
  canRead   Boolean @default(false)
  canWrite  Boolean @default(false)
  canDelete Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, resource])
  @@map("b24_employee_permissions")
}

model B24EmployeeActivityLog {
  id         String      @id @default(cuid())
  employeeId String
  employee   B24Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  action     String // e.g., "workshop_assigned", "customer_contacted", "offer_reviewed"
  resource   String? // e.g., "workshop", "customer", "offer"
  resourceId String? // ID of the resource
  details    String? @db.Text // JSON with additional details
  ipAddress  String?

  createdAt DateTime @default(now())

  @@index([employeeId])
  @@index([createdAt])
  @@map("b24_employee_activity_logs")
}

// ============================================
// WORKSHOP CRM / SALES TRACKING
// ============================================

model WorkshopCRM {
  id         String   @id @default(cuid())
  workshopId String
  workshop   Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // Sales Status
  leadStatus              String   @default("NEUKONTAKT") // NEUKONTAKT, INTERESSIERT, VERHANDLUNG, AKTIV, INAKTIV
  potential               String? // HOCH, MITTEL, NIEDRIG
  estimatedMonthlyRevenue Decimal? @db.Decimal(10, 2)

  // Contact Person
  mainContactName     String?
  mainContactPosition String?
  mainContactPhone    String?
  mainContactEmail    String?
  decisionMaker       Boolean @default(false)

  // Competition
  otherPlatforms String? @db.Text // Comma-separated or JSON

  // Next Steps
  nextContactDate DateTime?
  nextContactType String? // TELEFON, BESUCH, EMAIL
  followUpNotes   String?   @db.Text

  // Contract Status
  contractStatus    String? // KEIN_VERTRAG, ANGEBOT_GESENDET, VERHANDLUNG, VERTRAG_AKTIV
  contractStartDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  interactions WorkshopInteraction[]
  notes        WorkshopNote[]

  @@unique([workshopId])
  @@map("workshop_crm")
}

model WorkshopInteraction {
  id    String      @id @default(cuid())
  crmId String
  crm   WorkshopCRM @relation(fields: [crmId], references: [id], onDelete: Cascade)

  employeeId   String?
  employeeName String // Name of B24 employee who made contact

  type     String // TELEFON, BESUCH, EMAIL, MEETING
  date     DateTime
  duration Int? // Duration in minutes

  summary String  @db.Text
  outcome String? // POSITIV, NEUTRAL, NEGATIV, FOLLOW_UP_NEEDED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([crmId])
  @@index([date])
  @@map("workshop_interactions")
}

model WorkshopNote {
  id    String      @id @default(cuid())
  crmId String
  crm   WorkshopCRM @relation(fields: [crmId], references: [id], onDelete: Cascade)

  employeeId   String?
  employeeName String // Name of B24 employee who created note

  category String? // ALLGEMEIN, WICHTIG, ANFORDERUNG, PROBLEM, CHANCE
  title    String?
  content  String  @db.Text

  isPinned Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([crmId])
  @@index([createdAt])
  @@map("workshop_notes")
}

// ============================================
// ADMIN LOGS
// ============================================

model AdminLog {
  id         String  @id @default(cuid())
  adminEmail String
  action     String
  details    String?

  createdAt DateTime @default(now())

  @@map("admin_logs")
}

// ============================================
// PAGE VIEWS / ANALYTICS
// ============================================

model PageView {
  id String @id @default(cuid())

  // Page information
  path      String // e.g., "/", "/dashboard/customer", "/lp/werkstatt-mueller"
  fullUrl   String? // Full URL including query params
  pageTitle String? // Page title

  // User information
  userId    String? // Logged-in user ID (optional)
  userRole  String? // CUSTOMER, WORKSHOP, ADMIN (optional)
  ipAddress String? // IP address (anonymized for privacy)
  userAgent String? // Browser/device info

  // Referrer
  referrer String? // Where did the user come from

  // Workshop landing page tracking
  workshopId String? // If viewing a workshop landing page

  // Session tracking
  sessionId String? // Session identifier

  // Timing
  viewedAt DateTime @default(now())

  @@index([path])
  @@index([workshopId])
  @@index([viewedAt])
  @@index([userId])
  @@map("page_views")
}

// ============================================
// SALES CRM - PROSPECT MANAGEMENT
// ============================================

// Potenzielle Werkstatt aus Google Places
model ProspectWorkshop {
  id String @id @default(cuid())

  // Google Places Daten
  googlePlaceId String  @unique @map("google_place_id")
  name          String
  address       String
  city          String
  postalCode    String  @map("postal_code")
  state         String? // Bundesland
  country       String  @default("DE")
  phone         String?
  website       String?
  email         String?

  // Google Places Ratings
  rating      Float?
  reviewCount Int?   @default(0) @map("review_count")
  priceLevel  Int?   @map("price_level") // 0-4 (Google Places price level)

  // Media
  photoUrls String[] @map("photo_urls") // Array von Photo URLs

  // Location
  latitude  Float
  longitude Float

  // Google Places Metadata
  placeTypes   String[] @map("place_types") // ["car_repair", "car_dealer", etc.]
  openingHours Json?    @map("opening_hours") // Google Places opening hours structure

  // Sales Pipeline
  status           ProspectStatus @default(NEW)
  priority         Priority       @default(MEDIUM)
  estimatedRevenue Float?         @map("estimated_revenue") // Geschätzter Jahresumsatz

  // Lead Scoring
  leadScore Int? @default(50) @map("lead_score") // 0-100

  // Zuständigkeit
  assignedToId String?      @map("assigned_to_id") // B24Employee ID
  assignedTo   B24Employee? @relation("AssignedProspects", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedAt   DateTime?    @map("assigned_at")

  // Tracking
  source           String // "google_places", "manual", "referral", "website"
  firstContactDate DateTime? @map("first_contact_date")
  lastContactDate  DateTime? @map("last_contact_date")
  nextFollowUpDate DateTime? @map("next_follow_up_date")

  // Conversion
  convertedToWorkshopId String?   @unique @map("converted_to_workshop_id")
  convertedWorkshop     Workshop? @relation("ConvertedFromProspect", fields: [convertedToWorkshopId], references: [id], onDelete: SetNull)
  convertedAt           DateTime? @map("converted_at")
  conversionValue       Float?    @map("conversion_value") // Tatsächlicher Wert bei Conversion

  // Loss Tracking
  lostReason String? @map("lost_reason") // Grund warum verloren

  // Relations
  interactions ProspectInteraction[]
  tasks        ProspectTask[]
  notes        ProspectNote[]

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([assignedToId])
  @@index([postalCode])
  @@index([city])
  @@index([leadScore])
  @@index([nextFollowUpDate])
  @@map("prospect_workshops")
}

enum ProspectStatus {
  NEW // Neu gefunden
  CONTACTED // Erstkontakt gemacht
  QUALIFIED // Qualifiziert (hat Potenzial)
  MEETING_SCHEDULED // Termin vereinbart
  DEMO_COMPLETED // Demo durchgeführt
  PROPOSAL_SENT // Angebot verschickt
  NEGOTIATING // In Verhandlung
  VERBAL_AGREEMENT // Mündliche Zusage
  CONTRACT_SENT // Vertrag verschickt
  WON // Gewonnen → Workshop erstellt
  LOST // Verloren
  NOT_INTERESTED // Kein Interesse
  NOT_REACHABLE // Nicht erreichbar
  CALLBACK // Follow-up geplant
  ON_HOLD // Pausiert
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Interaktionen/Kontakthistorie
model ProspectInteraction {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  type    InteractionType
  channel ContactChannel
  subject String
  notes   String          @db.Text
  outcome String? // Ergebnis der Interaktion

  // Duration for calls/meetings (in minutes)
  duration Int?

  // Sentiment Analysis
  sentiment String? // "positive", "neutral", "negative"

  // Next Steps
  nextSteps String? @map("next_steps") @db.Text

  // Attachments
  attachments String[] // URLs zu hochgeladenen Dateien

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("InteractionCreator", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now()) @map("created_at")

  @@index([prospectId])
  @@index([createdById])
  @@index([createdAt])
  @@map("prospect_interactions")
}

enum InteractionType {
  CALL // Telefonat
  EMAIL // E-Mail
  MEETING // Persönliches Treffen
  DEMO // Produkt-Demo
  NOTE // Notiz/Memo
  PROPOSAL // Angebot versendet
  CONTRACT // Vertrag
  FOLLOW_UP // Follow-up Kontakt
}

enum ContactChannel {
  PHONE
  EMAIL
  IN_PERSON // Persönlich
  VIDEO_CALL // Video-Call
  WHATSAPP
  SMS
  LINKEDIN
  OTHER
}

// Tasks/Follow-ups für Prospects
model ProspectTask {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  title       String
  description String?  @db.Text
  dueDate     DateTime @map("due_date")

  priority Priority   @default(MEDIUM)
  status   TaskStatus @default(PENDING)

  completed   Boolean   @default(false)
  completedAt DateTime? @map("completed_at")

  // Reminder
  reminderDate DateTime? @map("reminder_date")
  reminderSent Boolean   @default(false) @map("reminder_sent")

  assignedToId String      @map("assigned_to_id")
  assignedTo   B24Employee @relation("AssignedTasks", fields: [assignedToId], references: [id])

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("TaskCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([prospectId])
  @@index([assignedToId])
  @@index([dueDate])
  @@index([status])
  @@map("prospect_tasks")
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// Notizen zu Prospects
model ProspectNote {
  id String @id @default(cuid())

  prospectId String           @map("prospect_id")
  prospect   ProspectWorkshop @relation(fields: [prospectId], references: [id], onDelete: Cascade)

  content  String  @db.Text
  isPinned Boolean @default(false) @map("is_pinned") // Wichtige Notizen anpinnen

  createdById String      @map("created_by_id")
  createdBy   B24Employee @relation("NoteCreator", fields: [createdById], references: [id])
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  @@index([prospectId])
  @@index([createdById])
  @@map("prospect_notes")
}

// Erweitere B24Employee Model für Sales-Beziehungen
// (Diese Relations müssen zum existierenden B24Employee Model hinzugefügt werden)
// assignedProspects     ProspectWorkshop[]      @relation("AssignedProspects")
// createdInteractions   ProspectInteraction[]   @relation("InteractionCreator")
// assignedTasks         ProspectTask[]          @relation("AssignedTasks")
// createdTasks          ProspectTask[]          @relation("TaskCreator")
// createdNotes          ProspectNote[]          @relation("NoteCreator")

// ============================================
// KVP - KONTINUIERLICHER VERBESSERUNGSPROZESS
// ============================================

model ImprovementSuggestion {
  id String @id @default(cuid())

  title       String  @db.VarChar(200)
  description String  @db.Text
  category    String  @db.VarChar(50) // z.B. "UI/UX", "Performance", "Prozess", "Feature"
  priority    ImprovementPriority @default(MEDIUM)
  status      ImprovementStatus   @default(NEW)

  // Zeitplan
  estimatedEffort String? @db.VarChar(50) // z.B. "1 Tag", "1 Woche", "1 Monat"
  plannedDate     DateTime? // Geplante Umsetzung
  completedDate   DateTime? // Tatsächliche Umsetzung

  // Beziehungen
  submittedById String      @map("submitted_by_id")
  submittedBy   B24Employee @relation("ImprovementSubmitter", fields: [submittedById], references: [id])

  assignedToId String?      @map("assigned_to_id")
  assignedTo   B24Employee? @relation("ImprovementAssignee", fields: [assignedToId], references: [id])

  // Kommentare und Feedback
  comments ImprovementComment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([submittedById])
  @@index([assignedToId])
  @@map("improvement_suggestions")
}

model ImprovementComment {
  id String @id @default(cuid())

  suggestionId String                 @map("suggestion_id")
  suggestion   ImprovementSuggestion @relation(fields: [suggestionId], references: [id], onDelete: Cascade)

  content      String   @db.Text
  isStatusNote Boolean  @default(false) @map("is_status_note") // true = System-Notiz bei Statusänderung

  authorId String      @map("author_id")
  author   B24Employee @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([suggestionId])
  @@index([authorId])
  @@map("improvement_comments")
}

enum ImprovementStatus {
  NEW          // Neu eingereicht
  IN_REVIEW    // In Prüfung
  APPROVED     // Genehmigt
  IN_PROGRESS  // In Umsetzung
  COMPLETED    // Abgeschlossen
  REJECTED     // Abgelehnt
  ON_HOLD      // Zurückgestellt
}

enum ImprovementPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
